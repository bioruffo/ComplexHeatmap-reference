<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 13 Genome-level heatmap | ComplexHeatmap Complete Reference</title>
<meta name="author" content="Zuguang Gu">
<meta name="description" content="Many people are interested in making genome-scale heatmap with multiple tracks, like examples here and here. In this chapter, I will demonstrate how to implement it with ComplexHeatmap. To make...">
<meta name="generator" content="bookdown 0.27 with bs4_book()">
<meta property="og:title" content="Chapter 13 Genome-level heatmap | ComplexHeatmap Complete Reference">
<meta property="og:type" content="book">
<meta property="og:url" content="https://jokergoo.github.io/ComplexHeatmap-reference/book/genome-level-heatmap.html">
<meta property="og:image" content="https://jokergoo.github.io/ComplexHeatmap-reference/book/complexheatmap-cover.jpg">
<meta property="og:description" content="Many people are interested in making genome-scale heatmap with multiple tracks, like examples here and here. In this chapter, I will demonstrate how to implement it with ComplexHeatmap. To make...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 13 Genome-level heatmap | ComplexHeatmap Complete Reference">
<meta name="twitter:description" content="Many people are interested in making genome-scale heatmap with multiple tracks, like examples here and here. In this chapter, I will demonstrate how to implement it with ComplexHeatmap. To make...">
<meta name="twitter:image" content="https://jokergoo.github.io/ComplexHeatmap-reference/book/complexheatmap-cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><style>
    #content {
    	font-size: 0.95rem;
    }
    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">ComplexHeatmap Complete Reference</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="a-single-heatmap.html"><span class="header-section-number">2</span> A Single Heatmap</a></li>
<li><a class="" href="heatmap-annotations.html"><span class="header-section-number">3</span> Heatmap Annotations</a></li>
<li><a class="" href="a-list-of-heatmaps.html"><span class="header-section-number">4</span> A List of Heatmaps</a></li>
<li><a class="" href="legends.html"><span class="header-section-number">5</span> Legends</a></li>
<li><a class="" href="heatmap-decoration.html"><span class="header-section-number">6</span> Heatmap Decoration</a></li>
<li><a class="" href="oncoprint.html"><span class="header-section-number">7</span> OncoPrint</a></li>
<li><a class="" href="upset-plot.html"><span class="header-section-number">8</span> UpSet plot</a></li>
<li><a class="" href="interactive.html"><span class="header-section-number">9</span> Interactive ComplexHeatmap</a></li>
<li><a class="" href="integrate-with-other-packages.html"><span class="header-section-number">10</span> Integrate with other packages</a></li>
<li><a class="" href="other-high-level-plots.html"><span class="header-section-number">11</span> Other High-level Plots</a></li>
<li><a class="" href="three-d-heatmap.html"><span class="header-section-number">12</span> Three-dimensional ComplexHeatmap</a></li>
<li><a class="active" href="genome-level-heatmap.html"><span class="header-section-number">13</span> Genome-level heatmap</a></li>
<li><a class="" href="more-examples.html"><span class="header-section-number">14</span> More Examples</a></li>
<li><a class="" href="other-tricks.html"><span class="header-section-number">15</span> Other Tricks</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/jokergoo/ComplexHeatmap">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="genome-level-heatmap" class="section level1" number="13">
<h1>
<span class="header-section-number">13</span> Genome-level heatmap<a class="anchor" aria-label="anchor" href="#genome-level-heatmap"><i class="fas fa-link"></i></a>
</h1>
<p>Many people are interested in making genome-scale heatmap with multiple
tracks, like examples <a href="https://github.com/jokergoo/gtrellis/issues/4">here</a>
and
<a href="https://www.biorxiv.org/content/biorxiv/early/2019/03/30/594267/F4.medium.gif">here</a>.
In this chapter, I will demonstrate how to implement it with
<strong>ComplexHeatmap</strong>.</p>
<p>To make genome-scale plot, we first need the ranges on chromosome-level. There
are many ways to obtain this information. In following, I use
<code><a href="https://rdrr.io/pkg/circlize/man/read.chromInfo.html">circlize::read.chromInfo()</a></code> function.</p>
<div class="sourceCode" id="cb757"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/circlize">circlize</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/GenomicRanges">GenomicRanges</a></span><span class="op">)</span>
<span class="va">chr_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/read.chromInfo.html">read.chromInfo</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">df</span>
<span class="va">chr_df</span> <span class="op">=</span> <span class="va">chr_df</span><span class="op">[</span><span class="va">chr_df</span><span class="op">$</span><span class="va">chr</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"chr"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">22</span><span class="op">)</span>, <span class="op">]</span>
<span class="va">chr_gr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/GRanges-class.html">GRanges</a></span><span class="op">(</span>seqnames <span class="op">=</span> <span class="va">chr_df</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, ranges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/IRanges-constructor.html">IRanges</a></span><span class="op">(</span><span class="va">chr_df</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">chr_df</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">chr_gr</span></code></pre></div>
<pre><code>## GRanges object with 22 ranges and 0 metadata columns:
##        seqnames      ranges strand
##           &lt;Rle&gt;   &lt;IRanges&gt;  &lt;Rle&gt;
##    [1]     chr1 1-249250621      *
##    [2]     chr2 1-243199373      *
##    [3]     chr3 1-198022430      *
##    [4]     chr4 1-191154276      *
##    [5]     chr5 1-180915260      *
##    ...      ...         ...    ...
##   [18]    chr18  1-78077248      *
##   [19]    chr19  1-59128983      *
##   [20]    chr20  1-63025520      *
##   [21]    chr21  1-48129895      *
##   [22]    chr22  1-51304566      *
##   -------
##   seqinfo: 22 sequences from an unspecified genome; no seqlengths</code></pre>
<p>In the final heatmap, each row (if the genomic direction is vertical) or each
column (if the genomic direction is horizontal) actually represents a genomic
window, thus we need to split the genome with equal-width windows. Here I use
<code><a href="https://rdrr.io/pkg/EnrichedHeatmap/man/makeWindows.html">EnrichedHeatmap::makeWindows()</a></code> function to split the genome by 1MB window
(The two meta-columns in <code>chr_window</code> can be ignored here).</p>
<div class="sourceCode" id="cb759"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/EnrichedHeatmap">EnrichedHeatmap</a></span><span class="op">)</span>
<span class="va">chr_window</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/EnrichedHeatmap/man/makeWindows.html">makeWindows</a></span><span class="op">(</span><span class="va">chr_gr</span>, w <span class="op">=</span> <span class="fl">1e6</span><span class="op">)</span>
<span class="va">chr_window</span></code></pre></div>
<pre><code>## GRanges object with 2875 ranges and 2 metadata columns:
##          seqnames            ranges strand |  .i_query .i_window
##             &lt;Rle&gt;         &lt;IRanges&gt;  &lt;Rle&gt; | &lt;integer&gt; &lt;integer&gt;
##      [1]     chr1         1-1000000      * |         1         1
##      [2]     chr1   1000001-2000000      * |         1         2
##      [3]     chr1   2000001-3000000      * |         1         3
##      [4]     chr1   3000001-4000000      * |         1         4
##      [5]     chr1   4000001-5000000      * |         1         5
##      ...      ...               ...    ... .       ...       ...
##   [2871]    chr22 46000001-47000000      * |        22        47
##   [2872]    chr22 47000001-48000000      * |        22        48
##   [2873]    chr22 48000001-49000000      * |        22        49
##   [2874]    chr22 49000001-50000000      * |        22        50
##   [2875]    chr22 50000001-51000000      * |        22        51
##   -------
##   seqinfo: 22 sequences from an unspecified genome; no seqlengths</code></pre>
<p>To visualize genome-scale signals as a heatmap as well as other tracks, now
the task is to calculate the average signals in the 1MB windows by overlapping
the genomic windows and the genomic signals. Here I implement a function
<code>average_in_window()</code>. This function is adapted from <a href="https://bioconductor.org/packages/HilbertCurve/"><strong>HilbertCurve</strong>
package</a> since there is
similar task there.</p>
<div class="sourceCode" id="cb761"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">average_in_window</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">window</span>, <span class="va">gr</span>, <span class="va">v</span>, <span class="va">method</span> <span class="op">=</span> <span class="st">"weighted"</span>, <span class="va">empty_v</span> <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">{</span>

    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span> <span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span> <span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.recursive.html">is.atomic</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">is.vector</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span> <span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html">cbind</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>

    <span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html">ncol</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"`v` can only be a character vector."</span><span class="op">)</span>
    <span class="op">}</span>

    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">empty_v</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">empty_v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">rep</a></span><span class="op">(</span><span class="va">empty_v</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html">ncol</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>

    <span class="va">u</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">rep</a></span><span class="op">(</span><span class="va">empty_v</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">window</span><span class="op">)</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">window</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html">ncol</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span>

    <span class="va">mtch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/findOverlaps-methods.html">findOverlaps</a></span><span class="op">(</span><span class="va">window</span>, <span class="va">gr</span><span class="op">)</span><span class="op">)</span>
    <span class="va">intersect</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/setops-methods.html">pintersect</a></span><span class="op">(</span><span class="va">window</span><span class="op">[</span><span class="va">mtch</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">gr</span><span class="op">[</span><span class="va">mtch</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
    <span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/start.html">width</a></span><span class="op">(</span><span class="va">intersect</span><span class="op">)</span>
    <span class="va">v</span> <span class="op">=</span> <span class="va">v</span><span class="op">[</span><span class="va">mtch</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
    <span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html">nrow</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>

    <span class="va">ind_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/splitAsList.html">split</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="va">mtch</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>
    <span class="va">window_index</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ind_list</span><span class="op">)</span><span class="op">)</span>
    <span class="va">window_w</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/start.html">width</a></span><span class="op">(</span><span class="va">window</span><span class="op">)</span>

    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">ind_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
            <span class="va">ind</span> <span class="op">=</span> <span class="va">ind_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>
            <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.function.html">is.function</a></span><span class="op">(</span><span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                <span class="va">u</span><span class="op">[</span><span class="va">window_index</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="op">]</span> <span class="op">=</span> <span class="fu">method</span><span class="op">(</span><span class="va">v</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>, <span class="va">w</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>, <span class="va">window_w</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                <span class="va">tb</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/tapply.html">tapply</a></span><span class="op">(</span><span class="va">w</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>, <span class="va">v</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>, <span class="va">sum</span><span class="op">)</span>
                <span class="va">u</span><span class="op">[</span><span class="va">window_index</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">tb</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.min.html">which.max</a></span><span class="op">(</span><span class="va">tb</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
            <span class="op">}</span>
        <span class="op">}</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"w0"</span><span class="op">)</span> <span class="op">{</span>
            <span class="va">gr2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/inter-range-methods.html">reduce</a></span><span class="op">(</span><span class="va">gr</span>, min.gapwidth <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
            <span class="va">mtch2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/findOverlaps-methods.html">findOverlaps</a></span><span class="op">(</span><span class="va">window</span>, <span class="va">gr2</span><span class="op">)</span><span class="op">)</span>
            <span class="va">intersect2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/setops-methods.html">pintersect</a></span><span class="op">(</span><span class="va">window</span><span class="op">[</span><span class="va">mtch2</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">gr2</span><span class="op">[</span><span class="va">mtch2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>

            <span class="va">width_intersect</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/tapply.html">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/start.html">width</a></span><span class="op">(</span><span class="va">intersect2</span><span class="op">)</span>, <span class="va">mtch2</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">sum</span><span class="op">)</span>
            <span class="va">ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html">unique</a></span><span class="op">(</span><span class="va">mtch2</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>
            <span class="va">width_setdiff</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/start.html">width</a></span><span class="op">(</span><span class="va">window</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="va">width_intersect</span>

            <span class="va">w2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/start.html">width</a></span><span class="op">(</span><span class="va">window</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span>

            <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">ind_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                <span class="va">ind</span> <span class="op">=</span> <span class="va">ind_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>
                <span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/colSums.html">colSums</a></span><span class="op">(</span><span class="va">v</span><span class="op">[</span><span class="va">ind</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">*</span><span class="va">w</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span>
                <span class="va">u</span><span class="op">[</span><span class="va">window_index</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="va">x</span><span class="op">*</span><span class="va">width_intersect</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">empty_v</span><span class="op">*</span><span class="va">width_setdiff</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="va">w2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
            <span class="op">}</span>

        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"absolute"</span><span class="op">)</span> <span class="op">{</span>
            <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">ind_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                <span class="va">u</span><span class="op">[</span><span class="va">window_index</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">v</span><span class="op">[</span><span class="va">ind_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span>
            <span class="op">}</span>
            
        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"weighted"</span><span class="op">)</span> <span class="op">{</span>
            <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">ind_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                <span class="va">ind</span> <span class="op">=</span> <span class="va">ind_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>
                <span class="va">u</span><span class="op">[</span><span class="va">window_index</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/colSums.html">colSums</a></span><span class="op">(</span><span class="va">v</span><span class="op">[</span><span class="va">ind</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">*</span><span class="va">w</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span>
            <span class="op">}</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
            <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.function.html">is.function</a></span><span class="op">(</span><span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">ind_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">ind</span> <span class="op">=</span> <span class="va">ind_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>
                    <span class="va">u</span><span class="op">[</span><span class="va">window_index</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="op">]</span> <span class="op">=</span> <span class="fu">method</span><span class="op">(</span><span class="va">v</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>, <span class="va">w</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>, <span class="va">window_w</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
                <span class="op">}</span>
            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"wrong method."</span><span class="op">)</span>
            <span class="op">}</span>
        <span class="op">}</span>
    <span class="op">}</span>

    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>In <code>average_in_window()</code> function, there are following arguments:</p>
<ul>
<li>
<code>window</code>: A <code>GRanges</code> object of the genomic windows.</li>
<li>
<code>gr</code>: A <code>GRanges</code> object of the genomic signals.</li>
<li>
<code>v</code>: A vector or a matrix. This is the value associated with <code>gr</code> and it should have
the same length or <code>nrow</code> as <code>gr</code>. <code>v</code> can be numeric or character. If it is
<code>missing</code> or <code>NULL</code>, a value of one is assign to every region in <code>gr</code>. If <code>v</code> is numeric,
it can be a vector or a matrix, and if <code>v</code> is character, it can only be a vector.</li>
<li>
<code>method</code>: Method to summarize the signals for every genomic window.</li>
<li>
<code>empty_v</code>: The default value for the window if no region in <code>gr</code> overlaps to it.</li>
</ul>
<p>The function returns a matrix with the same row length and order as <code>window</code>.</p>
<p>The overlapping model is illustrated in the following plot. The red line in
the bottom represents a certain genomic window. Black lines on the top are the regions
for genomic signals that overlap with the window. The thick lines indicate the
intersected part between the signal regions and the window.</p>
<div class="inline-figure"><img src="13-genome-level-heatmap_files/figure-html/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;"></div>
<p>For a given window, <span class="math inline">\(n\)</span> is the number of signal regions which overlap with the
window (it is 5 in the above plot), <span class="math inline">\(w_i\)</span> is the width of the intersected
segments (black thick lines), and <span class="math inline">\(x_i\)</span> is the signal value associated with
the original regions.</p>
<ol style="list-style-type: decimal">
<li>
<p><strong>If the signals are numeric, either as a vector or a matrix</strong>, there are three pre-defined methods:</p>
<p>The <strong>“absolute”</strong> method is denoted as <span class="math inline">\(v_a\)</span> and is simply calculated as the mean
of all signal regions regardless of their width.</p>
<p><span class="math display">\[ v_a = \frac{\sum_i^n{x_i}}{n} \]</span></p>
<p>The <strong>“weighted”</strong> method is denoted as <span class="math inline">\(v_w\)</span> and is calculated as the mean of all
signal regions weighted by the width of their intersections. This is the default
method for numeric signals.</p>
<p><span class="math display">\[ v_w = \frac{\sum_i^n{x_iw_i}}{\sum_i^n{w_i}} \]</span></p>
<p>“Absolute” and “weighted” methods should be applied when background values
should not be taken into consideration. For example, when summarizing the mean
methylation in a small window, non-CpG background should be ignored, because
methylation is only associated with CpG sites and not with other positions.</p>
<p>The <strong>“w0”</strong> method is the weighted mean between the intersected parts and
un-intersected parts.</p>
<p><span class="math display">\[ v_{w0} = \frac{v_wW}{W+W'} \]</span></p>
<p><span class="math inline">\(W\)</span> is sum of width of the intersected parts (<span class="math inline">\(\sum_i^n{w_i}\)</span>) and <span class="math inline">\(W'\)</span> is the
sum of width for the non-intersected parts.</p>
</li>
<li>
<p><strong>If the signals are as a character vector,</strong> denote all levels encoded in <span class="math inline">\(x_i\)</span>
as <span class="math inline">\(A\)</span> and a certain level of <span class="math inline">\(A\)</span> is denoted as <span class="math inline">\(a\)</span>, the final value assigned to the
window is the level of which the corresponding segments have the maximal sum of widths.</p>
<p><span class="math display">\[\underset{a\in A}{\operatorname{arg\,max}}\sum_{i}^n I(x_i=a)\cdot w_i\]</span></p>
</li>
</ol>
<p>According to these rules, when the signal value <code>v</code> is numeric, the argumemt <code>method</code>
can be one of <code>weighted</code> (default), <code>absolute</code> and <code>w0</code>, and when <code>v</code> is character,
the value for <code>method</code> is ignored.</p>
<p>Besides the pre-defined values, <code>method</code> can also be a user-defined function and it works
both for numeric signals and character signals. The user-defined function should accept
three arguments: <code>x</code>, <code>w</code> and <code>gw</code>. This function is applied to every genomic window.
The three arguments are:</p>
<ul>
<li>
<code>x</code>: The signal values that fall in the genomic window (as shown in the previous plot).</li>
<li>
<code>w</code>: The associated segment widths.</li>
<li>
<code>gw</code>: The width of the current genomic window.</li>
</ul>
<p>The user-defined function should only return a scalar variable.</p>
<p>OK, now with the function <code>average_in_window()</code>, I can convert the genomic
signals to a window-based matrix. In the following example, I generate
approximately 1000 random genomic regions with 10 columns of random values (to
simulate 10 samples).</p>
<div class="sourceCode" id="cb762"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bed1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/generateRandomBed.html">generateRandomBed</a></span><span class="op">(</span>nr <span class="op">=</span> <span class="fl">1000</span>, nc <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="co"># generateRandomBed() is from circlize package</span>
<span class="co"># convert to a GRanes object</span>
<span class="va">gr1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/GRanges-class.html">GRanges</a></span><span class="op">(</span>seqnames <span class="op">=</span> <span class="va">bed1</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, ranges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/IRanges-constructor.html">IRanges</a></span><span class="op">(</span><span class="va">bed1</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">bed1</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

<span class="va">num_mat</span> <span class="op">=</span> <span class="fu">average_in_window</span><span class="op">(</span><span class="va">chr_window</span>, <span class="va">gr1</span>, <span class="va">bed1</span><span class="op">[</span>, <span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">num_mat</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 2875   10</code></pre>
<div class="sourceCode" id="cb764"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">head</a></span><span class="op">(</span><span class="va">num_mat</span><span class="op">)</span></code></pre></div>
<pre><code>##            [,1]       [,2]      [,3]       [,4]       [,5]       [,6]
## [1,] 0.41221587 -1.0284374 0.3001770 0.30235826 -0.1090057 -0.6867689
## [2,] 0.41221587 -1.0284374 0.3001770 0.30235826 -0.1090057 -0.6867689
## [3,] 0.41221587 -1.0284374 0.3001770 0.30235826 -0.1090057 -0.6867689
## [4,]         NA         NA        NA         NA         NA         NA
## [5,] 0.04940406 -0.2799608 0.1718526 0.05035123  0.4964346  0.3794261
## [6,]         NA         NA        NA         NA         NA         NA
##             [,7]       [,8]       [,9]      [,10]
## [1,] -0.01084778 -0.2034531 -0.9144625 -0.5319540
## [2,] -0.01084778 -0.2034531 -0.9144625 -0.5319540
## [3,] -0.01084778 -0.2034531 -0.9144625 -0.5319540
## [4,]          NA         NA         NA         NA
## [5,]  0.22292755 -0.7848129  0.2489310 -0.3708738
## [6,]          NA         NA         NA         NA</code></pre>
<p>The first five genomic windows have no value associated because no region in
<code>gr1</code> overlaps to them, thus, they take the value from <code>empty_v</code> which is by
default <code>NA</code>.</p>
<p>The second data to visualize is 10 lists of genomic regions with character
signals (let’s assume they are copy number variation results from 10 samples).
In each random regions, I additionally sample 20 from them, just to make them
sparse in the genome.</p>
<div class="sourceCode" id="cb766"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bed_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/generateRandomBed.html">generateRandomBed</a></span><span class="op">(</span>nr <span class="op">=</span> <span class="fl">1000</span>, nc <span class="op">=</span> <span class="fl">1</span>, 
        fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"gain"</span>, <span class="st">"loss"</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">char_mat</span> <span class="op">=</span> <span class="cn">NULL</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">bed</span> <span class="op">=</span> <span class="va">bed_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>
    <span class="va">bed</span> <span class="op">=</span> <span class="va">bed</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html">nrow</a></span><span class="op">(</span><span class="va">bed</span><span class="op">)</span>, <span class="fl">20</span><span class="op">)</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
    <span class="va">gr_cnv</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/GRanges-class.html">GRanges</a></span><span class="op">(</span>seqnames <span class="op">=</span> <span class="va">bed</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, ranges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/IRanges-constructor.html">IRanges</a></span><span class="op">(</span><span class="va">bed</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">bed</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

    <span class="va">char_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html">cbind</a></span><span class="op">(</span><span class="va">char_mat</span>, <span class="fu">average_in_window</span><span class="op">(</span><span class="va">chr_window</span>, <span class="va">gr_cnv</span>, <span class="va">bed</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The third data to visualize is simply genomic regions with two numeric columns where both columns
will be visualized as a point track and the first column will be visualized as a barplot track.</p>
<div class="sourceCode" id="cb767"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bed2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/generateRandomBed.html">generateRandomBed</a></span><span class="op">(</span>nr <span class="op">=</span> <span class="fl">100</span>, nc <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">gr2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/GRanges-class.html">GRanges</a></span><span class="op">(</span>seqnames <span class="op">=</span> <span class="va">bed2</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, ranges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/IRanges-constructor.html">IRanges</a></span><span class="op">(</span><span class="va">bed2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">bed2</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

<span class="va">v</span> <span class="op">=</span> <span class="fu">average_in_window</span><span class="op">(</span><span class="va">chr_window</span>, <span class="va">gr2</span>, <span class="va">bed2</span><span class="op">[</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p>The fourth data to visualize is a list of gene symbols that we want to mark in
the plot. <code>gr3</code> contains genomic positions for the genes as well as their
symbols. The variable <code>at</code> contains the row indice of the corresponding
windows in <code>chr_window</code> and <code>labels</code> contains the gene names. As shown in the
following code, I simply use <code><a href="https://rdrr.io/pkg/GenomicRanges/man/findOverlaps-methods.html">findOverlaps()</a></code> to associate gene regions to
genomic windows.</p>
<div class="sourceCode" id="cb768"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bed3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/generateRandomBed.html">generateRandomBed</a></span><span class="op">(</span>nr <span class="op">=</span> <span class="fl">40</span>, nc <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="va">gr3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/GRanges-class.html">GRanges</a></span><span class="op">(</span>seqnames <span class="op">=</span> <span class="va">bed3</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, ranges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/IRanges-constructor.html">IRanges</a></span><span class="op">(</span><span class="va">bed3</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">bed3</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">gr3</span><span class="op">$</span><span class="va">gene</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"gene_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">gr3</span><span class="op">)</span><span class="op">)</span>

<span class="va">mtch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/findOverlaps-methods.html">findOverlaps</a></span><span class="op">(</span><span class="va">chr_window</span>, <span class="va">gr3</span><span class="op">)</span><span class="op">)</span>
<span class="va">at</span> <span class="op">=</span> <span class="va">mtch</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>
<span class="va">labels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">mcols</a></span><span class="op">(</span><span class="va">gr3</span><span class="op">)</span><span class="op">[</span><span class="va">mtch</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span><span class="op">]</span></code></pre></div>
<p>Now I have all the variables and are ready for making the heatmaps. Before doing that,
to better control the heatmap, I set <code>chr</code> as a factor to control the order of chromosomes
in the final plot and I create a variable <code>subgroup</code> to simulate the 10 columns in the matrix
for two subgroups.</p>
<div class="sourceCode" id="cb769"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">chr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/GenomeInfoDb/man/seqinfo.html">seqnames</a></span><span class="op">(</span><span class="va">chr_window</span><span class="op">)</span><span class="op">)</span>
<span class="va">chr_level</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"chr"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">22</span><span class="op">)</span>
<span class="va">chr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">chr</span>, levels <span class="op">=</span> <span class="va">chr_level</span><span class="op">)</span>

<span class="va">subgroup</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></code></pre></div>
<p>The following code makes the heatmap with additional tracks. The plot is a combination
of two heatmaps and three row annotations. Don’t be scared by the massive number
of arguments. If you have been using <strong>ComplexHeatmap</strong> for more than a week, I believe
you’ve already get used to it :).</p>
<div class="sourceCode" id="cb770"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/ComplexHeatmap">ComplexHeatmap</a></span><span class="op">)</span>
<span class="va">ht_opt</span><span class="op">$</span><span class="va">TITLE_PADDING</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"points"</span><span class="op">)</span>
<span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">num_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>,
    row_split <span class="op">=</span> <span class="va">chr</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>, show_column_dend <span class="op">=</span> <span class="cn">FALSE</span>,
    column_split <span class="op">=</span> <span class="va">subgroup</span>, cluster_column_slices <span class="op">=</span> <span class="cn">FALSE</span>,
    column_title <span class="op">=</span> <span class="st">"numeric matrix"</span>,
    top_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html">HeatmapAnnotation</a></span><span class="op">(</span>subgroup <span class="op">=</span> <span class="va">subgroup</span>, annotation_name_side <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span>,
    row_title_rot <span class="op">=</span> <span class="fl">0</span>, row_title_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, border <span class="op">=</span> <span class="cn">TRUE</span>,
    row_gap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"points"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">char_mat</span>, name <span class="op">=</span> <span class="st">"CNV"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"gain"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"loss"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>,
    border <span class="op">=</span> <span class="cn">TRUE</span>, column_title <span class="op">=</span> <span class="st">"character matrix"</span><span class="op">)</span> <span class="op">+</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/rowAnnotation.html">rowAnnotation</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_mark.html">anno_mark</a></span><span class="op">(</span>at <span class="op">=</span> <span class="va">at</span>, labels <span class="op">=</span> <span class="va">labels</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/rowAnnotation.html">rowAnnotation</a></span><span class="op">(</span>pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_points.html">anno_points</a></span><span class="op">(</span><span class="va">v</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">16</span><span class="op">)</span><span class="op">)</span>, 
    width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/rowAnnotation.html">rowAnnotation</a></span><span class="op">(</span>bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_barplot.html">anno_barplot</a></span><span class="op">(</span><span class="va">v</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">v</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
    width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html">draw</a></span><span class="op">(</span><span class="va">ht_list</span>, merge_legend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="13-genome-level-heatmap_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;"></div>
<p>It is easy to make the arrangement of heatmaps vertical (use <code>%v%</code> to concatenate
heatmaps!). Just carefully switch the row-related parameters and
column-related parameters. Here I additinally adjust the legends to make them
look nicer in the plot.</p>
<p>Note I use a trick to arrange the chromosome names. Since the chromosome names will
overlap for small chromosomes, I simply add <code>\n</code> before or after for the neighbour chromosome names
(see how I set <code>column_title</code> argument in the first heatmap).</p>
<div class="sourceCode" id="cb771"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/t.html">t</a></span><span class="op">(</span><span class="va">num_mat</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>,
    column_split <span class="op">=</span> <span class="va">chr</span>, cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>, show_row_dend <span class="op">=</span> <span class="cn">FALSE</span>,
    row_split <span class="op">=</span> <span class="va">subgroup</span>, cluster_row_slices <span class="op">=</span> <span class="cn">FALSE</span>,
    row_title <span class="op">=</span> <span class="st">"numeric matrix"</span>,
    left_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/rowAnnotation.html">rowAnnotation</a></span><span class="op">(</span>subgroup <span class="op">=</span> <span class="va">subgroup</span>, show_annotation_name <span class="op">=</span> <span class="cn">FALSE</span>,
        annotation_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
            subgroup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>direction <span class="op">=</span> <span class="st">"horizontal"</span>, title_position <span class="op">=</span> <span class="st">"lefttop"</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    column_title_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, border <span class="op">=</span> <span class="cn">TRUE</span>,
    column_gap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"points"</span><span class="op">)</span>,
    column_title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">22</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">2</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"\n"</span>, <span class="va">chr_level</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">chr_level</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span>,
    heatmap_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>direction <span class="op">=</span> <span class="st">"horizontal"</span>, title_position <span class="op">=</span> <span class="st">"lefttop"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/pct_v_pct.html">%v%</a></span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/t.html">t</a></span><span class="op">(</span><span class="va">char_mat</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"CNV"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"gain"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"loss"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>,
    border <span class="op">=</span> <span class="cn">TRUE</span>, row_title <span class="op">=</span> <span class="st">"character matrix"</span>,
    heatmap_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>direction <span class="op">=</span> <span class="st">"horizontal"</span>, title_position <span class="op">=</span> <span class="st">"lefttop"</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/pct_v_pct.html">%v%</a></span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html">HeatmapAnnotation</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_mark.html">anno_mark</a></span><span class="op">(</span>at <span class="op">=</span> <span class="va">at</span>, labels <span class="op">=</span> <span class="va">labels</span>, side <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/pct_v_pct.html">%v%</a></span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html">HeatmapAnnotation</a></span><span class="op">(</span>pt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_points.html">anno_points</a></span><span class="op">(</span><span class="va">v</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">16</span><span class="op">)</span><span class="op">)</span>,
    annotation_name_side <span class="op">=</span> <span class="st">"left"</span>, height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/pct_v_pct.html">%v%</a></span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html">HeatmapAnnotation</a></span><span class="op">(</span>bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_barplot.html">anno_barplot</a></span><span class="op">(</span><span class="va">v</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">v</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
    annotation_name_side <span class="op">=</span> <span class="st">"left"</span>, height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html">draw</a></span><span class="op">(</span><span class="va">ht_list</span>, heatmap_legend_side <span class="op">=</span> <span class="st">"bottom"</span>, merge_legend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="13-genome-level-heatmap_files/figure-html/unnamed-chunk-11-1.png" width="960" style="display: block; margin: auto;"></div>

</div>
  <div class="chapter-nav">
<div class="prev"><a href="three-d-heatmap.html"><span class="header-section-number">12</span> Three-dimensional ComplexHeatmap</a></div>
<div class="next"><a href="more-examples.html"><span class="header-section-number">14</span> More Examples</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav"><li><a class="nav-link" href="#genome-level-heatmap"><span class="header-section-number">13</span> Genome-level heatmap</a></li></ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/jokergoo/ComplexHeatmap/blob/master/13-genome-level-heatmap.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/jokergoo/ComplexHeatmap/edit/master/13-genome-level-heatmap.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>ComplexHeatmap Complete Reference</strong>" was written by Zuguang Gu. It was last built on last revised on 2022-07-31.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
