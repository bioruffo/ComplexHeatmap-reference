<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 3 Heatmap Annotations | ComplexHeatmap Complete Reference</title>
<meta name="author" content="Zuguang Gu">
<meta name="description" content="Heatmap annotations are important components of a heatmap that it shows additional information that associates with rows or columns in the heatmap. ComplexHeatmap package provides very flexible...">
<meta name="generator" content="bookdown 0.27 with bs4_book()">
<meta property="og:title" content="Chapter 3 Heatmap Annotations | ComplexHeatmap Complete Reference">
<meta property="og:type" content="book">
<meta property="og:url" content="https://jokergoo.github.io/ComplexHeatmap-reference/book/heatmap-annotations.html">
<meta property="og:image" content="https://jokergoo.github.io/ComplexHeatmap-reference/book/complexheatmap-cover.jpg">
<meta property="og:description" content="Heatmap annotations are important components of a heatmap that it shows additional information that associates with rows or columns in the heatmap. ComplexHeatmap package provides very flexible...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 3 Heatmap Annotations | ComplexHeatmap Complete Reference">
<meta name="twitter:description" content="Heatmap annotations are important components of a heatmap that it shows additional information that associates with rows or columns in the heatmap. ComplexHeatmap package provides very flexible...">
<meta name="twitter:image" content="https://jokergoo.github.io/ComplexHeatmap-reference/book/complexheatmap-cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><style>
    #content {
    	font-size: 0.95rem;
    }
    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">ComplexHeatmap Complete Reference</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="a-single-heatmap.html"><span class="header-section-number">2</span> A Single Heatmap</a></li>
<li><a class="active" href="heatmap-annotations.html"><span class="header-section-number">3</span> Heatmap Annotations</a></li>
<li><a class="" href="a-list-of-heatmaps.html"><span class="header-section-number">4</span> A List of Heatmaps</a></li>
<li><a class="" href="legends.html"><span class="header-section-number">5</span> Legends</a></li>
<li><a class="" href="heatmap-decoration.html"><span class="header-section-number">6</span> Heatmap Decoration</a></li>
<li><a class="" href="oncoprint.html"><span class="header-section-number">7</span> OncoPrint</a></li>
<li><a class="" href="upset-plot.html"><span class="header-section-number">8</span> UpSet plot</a></li>
<li><a class="" href="interactive.html"><span class="header-section-number">9</span> Interactive ComplexHeatmap</a></li>
<li><a class="" href="integrate-with-other-packages.html"><span class="header-section-number">10</span> Integrate with other packages</a></li>
<li><a class="" href="other-high-level-plots.html"><span class="header-section-number">11</span> Other High-level Plots</a></li>
<li><a class="" href="three-d-heatmap.html"><span class="header-section-number">12</span> Three-dimensional ComplexHeatmap</a></li>
<li><a class="" href="genome-level-heatmap.html"><span class="header-section-number">13</span> Genome-level heatmap</a></li>
<li><a class="" href="more-examples.html"><span class="header-section-number">14</span> More Examples</a></li>
<li><a class="" href="other-tricks.html"><span class="header-section-number">15</span> Other Tricks</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/jokergoo/ComplexHeatmap">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="heatmap-annotations" class="section level1" number="3">
<h1>
<span class="header-section-number">3</span> Heatmap Annotations<a class="anchor" aria-label="anchor" href="#heatmap-annotations"><i class="fas fa-link"></i></a>
</h1>
<p>Heatmap annotations are important components of a heatmap that it shows
additional information that associates with rows or columns in the heatmap.
<strong>ComplexHeatmap</strong> package provides very flexible supports for setting
annotations and defining new annotation graphics. The annotations can be put
on the four sides of the heatmap, by <code>top_annotation</code>, <code>bottom_annotation</code>,
<code>left_annotation</code> and <code>right_annotation</code> arguments.</p>
<p>The value for the four arguments should be in the <code>HeatmapAnnotation</code> class
and should be constructed by <code>HeatmapAnnotation()</code> function, or by
<code>rowAnnotation()</code> function if it is a row annotation. (<code>rowAnnotation()</code> is
just a helper function which is identical to <code>HeatmapAnnotation(..., which = "row")</code>). A simple usage of heatmap annotations is as follows.</p>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"R"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"C"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>
<span class="va">column_ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, bar1 <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">row_ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, bar2 <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, top_annotation <span class="op">=</span> <span class="va">column_ha</span>, right_annotation <span class="op">=</span> <span class="va">row_ha</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-2-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Or assign as bottom annotation and left annotation.</p>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, bottom_annotation <span class="op">=</span> <span class="va">column_ha</span>, left_annotation <span class="op">=</span> <span class="va">row_ha</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-3-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>In above examples, <code>column_ha</code> and <code>row_ha</code> both have two annotations where
<code>foo1</code> and <code>foo2</code> are numeric vectors and <code>bar1</code> and <code>bar2</code> are barplots. The
vector-like annotation is called <em>“simple annotation”</em> here and the barplot
annotation is called <em>“complex annotation”</em>. You can already see the
annotations must be defined as name-value pairs (e.g. <code>foo = ...</code>).</p>
<p>Heatmap annotations can also be independent of the heatmaps. They can be
concatenated to the heatmap list by <code>+</code> if it is horizontal, or <code>%v%</code> if it is
vertical. Chapter <a href="a-list-of-heatmaps.html#a-list-of-heatmaps">4</a> will discuss how to concatenate
heatmaps and annotations.</p>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">+</span> <span class="fu">rowAnnotation</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">...</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">%v%</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">%v%</span> <span class="va">...</span></code></pre></div>
<p><code>HeatmapAnnotation()</code> returns a <code>HeatmapAnnotation</code> class object. The object
is usually composed of several annotations. In the following sections of this
chapter, we first introduce settings for individal annotation, and later we
show how to put them toghether.</p>
<p>You can see the information of the <code>column_ha</code> and <code>row_ha</code> objects by directly enter the object names:</p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">column_ha</span></code></pre></div>
<pre><code>## A HeatmapAnnotation object with 2 annotations
##   name: heatmap_annotation_0 
##   position: column 
##   items: 10 
##   width: 1npc 
##   height: 15.3514598035146mm 
##   this object is subsettable
##   5.92288888888889mm extension on the left 
##   9.4709mm extension on the right 
## 
##  name   annotation_type color_mapping height
##  foo1 continuous vector        random    5mm
##  bar1    anno_barplot()                 10mm</code></pre>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">row_ha</span></code></pre></div>
<pre><code>## A HeatmapAnnotation object with 2 annotations
##   name: heatmap_annotation_1 
##   position: row 
##   items: 10 
##   width: 15.3514598035146mm 
##   height: 1npc 
##   this object is subsettable
##   9.96242222222222mm extension on the bottom 
## 
##  name   annotation_type color_mapping width
##  foo2 continuous vector        random   5mm
##  bar2    anno_barplot()                10mm</code></pre>
<p>In the following examples in this chapter, we will only show the graphics for the
annotations with no heatmap, unless it is necessary. If you want to try it
with a heatmap, you just assign the <code>HeatmapAnnotation</code> object which we always
name as <code>ha</code> to <code>top_annotation</code>, <code>bottom_annotation</code>, <code>left_annotation</code> or
<code>right_annotation</code> arguments.</p>
<p>Settings are basically the same for column annotations and row annotations. If
there is nothing specicial, we only show the column annotation as examples. If
you want to try row annotation, just add <code>which = "row"</code> to
<code>HeatmapAnnotation()</code> or directly change to <code>rowAnnotation()</code> function.</p>
<div id="simple-annotation" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> Simple annotation<a class="anchor" aria-label="anchor" href="#simple-annotation"><i class="fas fa-link"></i></a>
</h2>
<p>A so-called <em>“simple annotation”</em> is the most used style of annotations which
is heatmap-like or grid-like graphics where colors are used to map to the
annotation values. To generate a simple annotation, you just simply put the
annotation vector in <code>HeatmapAnnotation()</code> with a certain name.</p>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-7-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Or a discrete annotation:</p>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-9-1.png" width="576" style="display: block; margin: auto;"></div>
<p>You can use any strings as annotation names except those pre-defined arguments
in <code>HeatmapAnnotation()</code>.</p>
<p>If colors are not specified, colors are randomly generated. To set colors for
annotations, <code>col</code> needs to be set as a named list where the names should be
the same as annotation names. For continuous values, the color mapping should
be a color mapping function generated by <code><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">circlize::colorRamp2()</a></code>.</p>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/circlize">circlize</a></span><span class="op">)</span>
<span class="va">col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">col_fun</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-11-1.png" width="576" style="display: block; margin: auto;"></div>
<p>And for discrete annotations, the color should be a named vector where names
correspond to the levels in the annotation.</p>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"b"</span> <span class="op">=</span> <span class="st">"green"</span>, <span class="st">"c"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-13-1.png" width="576" style="display: block; margin: auto;"></div>
<p>If you specify more than one vectors, there will be multiple annotations
(<code>foo</code> and <code>bar</code> in following example). Also you can see how <code>col</code> is set when
<code>foo</code> and <code>bar</code> are all put into a single <code>HeatmapAnnotation()</code>. Maybe now you
can understand the names in the color list is actually used to map to the
annotation names. Values in <code>col</code> will be used to construct legends for simple
annotations.</p>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>
    foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">col_fun</span>,
               bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"b"</span> <span class="op">=</span> <span class="st">"green"</span>, <span class="st">"c"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-15-1.png" width="576" style="display: block; margin: auto;"></div>
<p>The color for <code>NA</code> value is controlled by <code>na_col</code> argument.</p>
<div class="sourceCode" id="cb183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>
    foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="cn">NA</span>, <span class="fl">6</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">9</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">col_fun</span>,
               bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"b"</span> <span class="op">=</span> <span class="st">"green"</span>, <span class="st">"c"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>
    <span class="op">)</span>,
    na_col <span class="op">=</span> <span class="st">"black"</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-17-1.png" width="576" style="display: block; margin: auto;"></div>
<p><code>gp</code> mainly controls the graphics parameters for the borders of the grids.</p>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>
    foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">col_fun</span>,
               bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"b"</span> <span class="op">=</span> <span class="st">"green"</span>, <span class="st">"c"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>
    <span class="op">)</span>,
    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-19-1.png" width="576" style="display: block; margin: auto;"></div>
<p>The simple annotation can also be a matrix (numeric or character) that all the
columns in the matrix share a same color mapping schema. <strong>Note columns in the
matrix correspond to the rows in the column annotation</strong> (you can imagine a vector is a one-column matrix). Also the column
names of the matrix are used as the annotation names.</p>
<div class="sourceCode" id="cb185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-21-1.png" width="576" style="display: block; margin: auto;"></div>
<p>If the matrix has no column name, the name of the annotation is still used, but drawn
in the middle of the annotation.</p>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-23-1.png" width="576" style="display: block; margin: auto;"></div>
<p>As simple annotations can be in different modes (e.g. numeric, or character),
they can be combined as a data frame and send to <code>df</code> argument. Imagine in your
project, you might already have an annotation table, you can directly set it by
<code>df</code>.</p>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">anno_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>df <span class="op">=</span> <span class="va">anno_df</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">col_fun</span>,
               bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"b"</span> <span class="op">=</span> <span class="st">"green"</span>, <span class="st">"c"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-25-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Single annotations and data frame can be mixed, but single annotations are
inserted after the data frame annotation. In following example, colors for
<code>foo2</code> is not specified, random colors will be used.</p>
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>df <span class="op">=</span> <span class="va">anno_df</span>,
    foo2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">col_fun</span>,
               bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"b"</span> <span class="op">=</span> <span class="st">"green"</span>, <span class="st">"c"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-27-1.png" width="576" style="display: block; margin: auto;"></div>
<p><code>border</code> controls the border of every single annotation.</p>
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>
    foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">col_fun</span>,
               bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"b"</span> <span class="op">=</span> <span class="st">"green"</span>, <span class="st">"c"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>
    <span class="op">)</span>,
    border <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-29-1.png" width="576" style="display: block; margin: auto;"></div>
<p>The height of the simple annotation is controlled by <code>simple_anno_size</code>
argument. Since all single annotations have same height, the value of
<code>simple_anno_size</code> is a single <code>unit</code> value. Note there are arguments like
<code>width</code>, <code>height</code>, <code>annotation_width</code> and <code>annotation_height</code>, but they are
used to adjust the width/height for the complete heamtap annotations (which
are always mix of several annotations). The adjustment of these four arguments
will be introduced in Section <a href="heatmap-annotations.html#multiple-annotations">3.21</a>.</p>
<div class="sourceCode" id="cb190"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>
    foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, b <span class="op">=</span> <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">col_fun</span>,
               bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"b"</span> <span class="op">=</span> <span class="st">"green"</span>, <span class="st">"c"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>
    <span class="op">)</span>,
    simple_anno_size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-31-1.png" width="576" style="display: block; margin: auto;"></div>
<p>When you have multiple heatmaps and it is better to keep the size of simple
annotations on all heatmaps with the same size. <code>ht_opt$simple_anno_size</code> can
be set to control the simple annotation size globally (It will be introduced
in Section <a href="a-list-of-heatmaps.html#change-parameters-globally">4.13</a>).</p>
</div>
<div id="simple-annotation-as-an-annotation-function" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> Simple annotation as an annotation function<a class="anchor" aria-label="anchor" href="#simple-annotation-as-an-annotation-function"><i class="fas fa-link"></i></a>
</h2>
<p><code>HeatmapAnnotation()</code> supports <em>“complex annotation”</em> by setting the
annotation as a function. The annotation function defines how to draw the
graphics at a certain position corresponding to the column or row in the
heatmap. There are quite a lot of annotation functions predefined in
<strong>ComplexHeatmap</strong> package. In the end of this chapter, we will introduce how
to construct your own annotation function by the <code>AnnotationFunction</code> class.</p>
<p>For all the annotation functions in forms of <code>anno_*()</code>, if it is specified in
<code>HeatmapAnnotation()</code> or <code>rowAnnotation()</code>, you don’t need to do anything
explicitly on <code>anno_*()</code> to tell whether it should be drawn on rows or
columns. <code>anno_*()</code> automatically detects whether it is a row annotation
environment or a column annotation environment.</p>
<p>The simple annotation shown in previous section is internally constructed by
<code>anno_simple()</code> annotation function. Directly using <code>anno_simple()</code> <strong>will not
automatically generate legends for the final plot</strong>, but, it can provide more
flexibility for more annotation graphics (note in Chapter
<a href="legends.html#legends">5</a> we will show, although <code>anno_simple()</code> cannot automatically generate the
legends, the legends can be controlled and added to the final plot manually).</p>
<p>For an example in previous section:</p>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></code></pre></div>
<p>is actually identical to:</p>
<div class="sourceCode" id="cb192"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_simple</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><code>anno_simple()</code> makes heatmap-like annotations (or the simple annotations).
Basically if users only make heatmap-like annotations, they do not need to
directly use <code>anno_simple()</code>, but this function allows to add more symbols on
the annotation grids.</p>
<p><code>anno_simple()</code> allows to add “points” or single-letter symbols on top of the
annotation grids. <code>pch</code>, <code>pt_gp</code> and <code>pt_size</code> control the settings of the
points. The value of <code>pch</code> can be a vector with possible <code>NA</code> values.</p>
<div class="sourceCode" id="cb193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_simple</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, pch <span class="op">=</span> <span class="fl">1</span>, 
    pt_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>, pt_size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-35-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Set <code>pch</code> as a vector:</p>
<div class="sourceCode" id="cb194"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_simple</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, pch <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-37-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Set <code>pch</code> as a vector of letters:</p>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_simple</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-39-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Set <code>pch</code> as a vector with <code>NA</code> values (nothing is drawn for <code>NA</code> pch values):</p>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_simple</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="cn">NA</span>, <span class="fl">6</span><span class="op">:</span><span class="fl">8</span>, <span class="cn">NA</span>, <span class="fl">10</span>, <span class="fl">11</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-41-1.png" width="576" style="display: block; margin: auto;"></div>
<p><code>pch</code> also works if the value for <code>anno_simple()</code> is a matrix. The length of
<code>pch</code> should be as same as the number of matrix rows or columns or even the
length of the matrix (the length of the matrix is the length of all data
points in the matrix).</p>
<p>Length of <code>pch</code> corresponds to matrix columns:</p>
<div class="sourceCode" id="cb197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_simple</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-43-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Length of <code>pch</code> corresponds to matrix rows:</p>
<div class="sourceCode" id="cb198"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_simple</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-45-1.png" width="576" style="display: block; margin: auto;"></div>
<p><code>pch</code> is a matrix:</p>
<div class="sourceCode" id="cb199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>, nc <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">pch</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pch</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_simple</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, pch <span class="op">=</span> <span class="va">pch</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-47-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Till now, you might wonder how to set the legends of the symbols you’ve added
to the simple annotations. Here we will only show you a simple example and
this functionality will be discussed in Chapter <a href="legends.html#legends">5</a>. In following
example, we assume the simple annotations are kind of p-values and we add <code>*</code>
for p-values less than 0.01.</p>
<div class="sourceCode" id="cb200"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">pvalue</span> <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="va">is_sig</span> <span class="op">=</span> <span class="va">pvalue</span> <span class="op">&lt;</span> <span class="fl">0.01</span>
<span class="va">pch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"*"</span>, <span class="fl">10</span><span class="op">)</span>
<span class="va">pch</span><span class="op">[</span><span class="op">!</span><span class="va">is_sig</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span>
<span class="co"># color mapping for -log10(pvalue)</span>
<span class="va">pvalue_col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> 
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>
    pvalue <span class="op">=</span> <span class="fu">anno_simple</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">pvalue</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">pvalue_col_fun</span>, pch <span class="op">=</span> <span class="va">pch</span><span class="op">)</span>,
    annotation_name_side <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>, top_annotation <span class="op">=</span> <span class="va">ha</span><span class="op">)</span>
<span class="co"># now we generate two legends, one for the p-value</span>
<span class="co"># see how we define the legend for pvalue</span>
<span class="va">lgd_pvalue</span> <span class="op">=</span> <span class="fu">Legend</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"p-value"</span>, col_fun <span class="op">=</span> <span class="va">pvalue_col_fun</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, 
    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"0.1"</span>, <span class="st">"0.01"</span>, <span class="st">"0.001"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># and one for the significant p-values</span>
<span class="va">lgd_sig</span> <span class="op">=</span> <span class="fu">Legend</span><span class="op">(</span>pch <span class="op">=</span> <span class="st">"*"</span>, type <span class="op">=</span> <span class="st">"points"</span>, labels <span class="op">=</span> <span class="st">"&lt; 0.01"</span><span class="op">)</span>
<span class="co"># these two self-defined legends are added to the plot by `annotation_legend_list`</span>
<span class="fu">draw</span><span class="op">(</span><span class="va">ht</span>, annotation_legend_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lgd_pvalue</span>, <span class="va">lgd_sig</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-48-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The height of the simple annotation can be controlled by <code>height</code> argument or
<code>simple_anno_size</code> inside <code>anno_simple()</code>. <code>simple_anno_size</code> controls the
size for single-row annotation and <code>height</code>/<code>width</code> controls the total
height/width of the simple annotations. If <code>height</code>/<code>width</code> is set,
<code>simple_anno_size</code> is ignored.</p>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_simple</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-50-1.png" width="576" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb202"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_simple</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, 
    simple_anno_size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-52-1.png" width="576" style="display: block; margin: auto;"></div>
<p><strong>For all the annotation functions we introduce later, the height or the width
for individual annotations should all be set inside the <code>anno_*()</code>
functions.</strong></p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="heatmap-annotations.html#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># code only for demonstration</span></span>
<span id="cb203-2"><a href="heatmap-annotations.html#cb203-2" aria-hidden="true" tabindex="-1"></a>anno_<span class="sc">*</span>(..., <span class="at">width =</span> ...)</span>
<span id="cb203-3"><a href="heatmap-annotations.html#cb203-3" aria-hidden="true" tabindex="-1"></a>anno_<span class="sc">*</span>(..., <span class="at">height =</span> ...)</span></code></pre></div>
<p>Again, the <code>width</code>, <code>height</code>, <code>annotation_width</code> and <code>annotation_height</code>
arguments in <code>HeatmapAnnotation()</code> are used to adjust the size of multiple
annotations.</p>
</div>
<div id="empty-annotation" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> Empty annotation<a class="anchor" aria-label="anchor" href="#empty-annotation"><i class="fas fa-link"></i></a>
</h2>
<p><code>anno_empty()</code> is a place holder where nothing is drawn. Later user-defined
graphics can be added by <code>decorate_annotation()</code> function.</p>
<div class="sourceCode" id="cb204"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_empty</span><span class="op">(</span>border <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-55-1.png" width="576" style="display: block; margin: auto;"></div>
<p>In Chapter <a href="heatmap-decoration.html#heatmap-decoration">6</a>, we will introduce the use of the
decoration functions, but here we give a quick example. In gene expression
expression analysis, there are senarios that we split the heatmaps into
several groups and we want to highlight some key genes in each group. In this
case, we simply add the gene names on the right side of the heatmap without
aligning them to the their corresponding rows. (<code>anno_mark()</code> can align the
labels correclty to their corresponding rows, but in the example we show here,
it is not necessray).</p>
<p>In following example, since rows are split into four slices, the empty
annotation is also split into four slices. Basically what we do is in each
empty annotation slice, we add a colored segment and text.</p>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">random_text</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">text_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    text1 <span class="op">=</span> <span class="fu">random_text</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>,
    text2 <span class="op">=</span> <span class="fu">random_text</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>,
    text3 <span class="op">=</span> <span class="fu">random_text</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>,
    text4 <span class="op">=</span> <span class="fu">random_text</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>
<span class="op">)</span>
<span class="co"># note how we set the width of this empty annotation</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_empty</span><span class="op">(</span>border <span class="op">=</span> <span class="cn">FALSE</span>, 
    width <span class="op">=</span> <span class="fu">max_text_width</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">text_list</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">4</span>, right_annotation <span class="op">=</span> <span class="va">ha</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">decorate_annotation</span><span class="op">(</span><span class="st">"foo"</span>, slice <span class="op">=</span> <span class="va">i</span>, <span class="op">{</span>
        <span class="fu">grid.rect</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"mm"</span><span class="op">)</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">i</span>, col <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>, just <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span>
        <span class="fu">grid.text</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">text_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span>, x <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"mm"</span><span class="op">)</span>, just <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-56-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Note the previous plot can also be made by <code>anno_block()</code> or <code>anno_textbox()</code> (Section <a href="heatmap-annotations.html#anno-text-box">3.19</a>).</p>
<p>A second use of the empty annotation is to add complex annotation graphics
where the empty annotation pretends to be a virtual plotting region. You can
construct an annotation function by <code>AnnotationFunction</code> class for complex
annotation graphics, which allows subsetting and splitting, but still, it can
be a secondary choice to directly draw inside the empty annotation, which is
easier and faster for implementing (but less flexible and does not allow
splitting).</p>
<p>In following we show how to add a “complex version” of points annotation. The
only thing that needs to be careful is the location on x-axis (y-axis if it is
a row annotation) should correspond to the column index after column
reordering.</p>
<div class="sourceCode" id="cb206"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Note this example is only for demonstration of `anno_empty()`.</span>
<span class="co"># Actually it can be made easily by `anno_points()`.</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_empty</span><span class="op">(</span>border <span class="op">=</span> <span class="cn">TRUE</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">3</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>, top_annotation <span class="op">=</span> <span class="va">ha</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">draw</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span>
<span class="va">co</span> <span class="op">=</span> <span class="fu">column_order</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span>
<span class="va">value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="fu">decorate_annotation</span><span class="op">(</span><span class="st">"foo"</span>, <span class="op">{</span>
    <span class="co"># value on x-axis is always 1:ncol(mat)</span>
    <span class="va">x</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
    <span class="co"># while values on y-axis is the value after column reordering</span>
    <span class="va">value</span> <span class="op">=</span> <span class="va">value</span><span class="op">[</span><span class="va">co</span><span class="op">]</span>
    <span class="fu">pushViewport</span><span class="op">(</span><span class="fu">viewport</span><span class="op">(</span>xscale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">10.5</span><span class="op">)</span>, yscale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">grid.lines</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">10.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,
        default.units <span class="op">=</span> <span class="st">"native"</span><span class="op">)</span>
    <span class="fu">grid.points</span><span class="op">(</span><span class="va">x</span>, <span class="va">value</span>, pch <span class="op">=</span> <span class="fl">16</span>, size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"mm"</span><span class="op">)</span>,
        gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">value</span> <span class="op">&gt;</span> <span class="fl">0.5</span>, <span class="st">"red"</span>, <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span>, default.units <span class="op">=</span> <span class="st">"native"</span><span class="op">)</span>
    <span class="fu">grid.yaxis</span><span class="op">(</span>at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">popViewport</span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-57-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
<div id="block-annotation" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> Block annotation<a class="anchor" aria-label="anchor" href="#block-annotation"><i class="fas fa-link"></i></a>
</h2>
<p>There are two uses for block annotation. 1. simply as rectangles (with labels
inside) to mark heatmap slices, 2. as plotting regions to associate subsets of
rows or columns in the heatmap.</p>
<div id="block-for-putting-labels" class="section level3" number="3.4.1">
<h3>
<span class="header-section-number">3.4.1</span> Block for putting labels<a class="anchor" aria-label="anchor" href="#block-for-putting-labels"><i class="fas fa-link"></i></a>
</h3>
<p>In this case, the block annotation is more like a color block which identifies groups when
the rows or columns of the heatmap are split.</p>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>,
    top_annotation <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_block</span><span class="op">(</span>gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    column_km <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-58-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Labels can be added to each block.</p>
<div class="sourceCode" id="cb208"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>,
    top_annotation <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_block</span><span class="op">(</span>gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>,
        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"group1"</span>, <span class="st">"group2"</span>, <span class="st">"group3"</span><span class="op">)</span>, 
        labels_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span>, fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    column_km <span class="op">=</span> <span class="fl">3</span>,
    left_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_block</span><span class="op">(</span>gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>,
        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"group1"</span>, <span class="st">"group2"</span>, <span class="st">"group3"</span><span class="op">)</span>, 
        labels_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span>, fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    row_km <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-59-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Note the length of <code>labels</code> or graphics parameters should have the same length
as the number of slices.</p>
<p><code>anno_block()</code> function draws rectangles for row/column slices where one
rectangle only corresponds to one single slice. Then what if we want to draw
the rectangles over several slices to show they belong to certain groups?</p>
<p>Currently, it is difficult to directly support it in <code>anno_block()</code>, however,
there is workaround for it. Actually, to draw rectangles across several
slices, we need to know two things: 1. the positions of the slices in the
plot, and 2. space to draw the rectangles. Luckily, the positions can be
obtained by directly go to the correspoding viewport and the space can be
allocated by <code>anno_empty()</code> function.</p>
<p>In the following code, we use <code>anno_empty()</code> to create an empty annotation:</p>
<div class="sourceCode" id="cb209"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">mat2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">50</span><span class="op">*</span><span class="fl">50</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, each <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>
    empty <span class="op">=</span> <span class="fu">anno_empty</span><span class="op">(</span>border <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
    foo <span class="op">=</span> <span class="fu">anno_block</span><span class="op">(</span>gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, labels <span class="op">=</span> <span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat2</span>, name <span class="op">=</span> <span class="st">"mat2"</span>, column_split <span class="op">=</span> <span class="va">split</span>, top_annotation <span class="op">=</span> <span class="va">ha</span>, 
    column_title <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-60-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Let’s say, we want to put the first three column slices as a group and the last two
slices as the second group.</p>
<p>The positions of the first and the third slices for annotation <code>"empty"</code> can be obtained by:</p>
<div class="sourceCode" id="cb210"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">seekViewport</span><span class="op">(</span><span class="st">"annotation_empty_1"</span><span class="op">)</span>
<span class="va">loc1</span> <span class="op">=</span> <span class="fu">deviceLoc</span><span class="op">(</span>x <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"npc"</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">seekViewport</span><span class="op">(</span><span class="st">"annotation_empty_3"</span><span class="op">)</span>
<span class="va">loc2</span> <span class="op">=</span> <span class="fu">deviceLoc</span><span class="op">(</span>x <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>
<span class="va">loc2</span></code></pre></div>
<pre><code>## $x
## [1] 4.07403126835173inches
## 
## $y
## [1] 6.51051067246731inches</code></pre>
<p>The viewport name <code>"annotation_empty_1"</code> correspond to the first slice for
annotation <code>empty</code>, and we take the left bottom of the first “empty”
annotation slice and the top right of the third slice, saved in <code>loc1</code> and
<code>loc2</code> variables.</p>
<p>Here what is important is the use of <code><a href="https://rdrr.io/r/grid/deviceLoc.html">grid::deviceLoc()</a></code> function. It directly
converts a location measured in a certain viewport to the position in
the graphics device.</p>
<p>In the end, we go to the <code>"global"</code> viewport because the size of <code>"global"</code>
viewport is the size of the graphics device, and draw the rectangle and add
label.</p>
<div class="sourceCode" id="cb212"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">seekViewport</span><span class="op">(</span><span class="st">"global"</span><span class="op">)</span>
<span class="fu">grid.rect</span><span class="op">(</span><span class="va">loc1</span><span class="op">$</span><span class="va">x</span>, <span class="va">loc1</span><span class="op">$</span><span class="va">y</span>, width <span class="op">=</span> <span class="va">loc2</span><span class="op">$</span><span class="va">x</span> <span class="op">-</span> <span class="va">loc1</span><span class="op">$</span><span class="va">x</span>, height <span class="op">=</span> <span class="va">loc2</span><span class="op">$</span><span class="va">y</span> <span class="op">-</span> <span class="va">loc1</span><span class="op">$</span><span class="va">y</span>, 
    just <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"bottom"</span><span class="op">)</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">grid.text</span><span class="op">(</span><span class="st">"group 1"</span>, x <span class="op">=</span> <span class="op">(</span><span class="va">loc1</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">loc2</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">*</span><span class="fl">0.5</span>, y <span class="op">=</span> <span class="op">(</span><span class="va">loc1</span><span class="op">$</span><span class="va">y</span> <span class="op">+</span> <span class="va">loc2</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">*</span><span class="fl">0.5</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-64-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The viewport names for the annotations are in a fixed format, which is
<code>annotation_{annotation_name}_{slice_index}</code>. The full set of viewport names
can be obtained by <code>list_components()</code> function.</p>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">list_components</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "ROOT"                        "global"                     
##  [3] "global_layout"               "global-heatmaplist"         
##  [5] "main_heatmap_list"           "heatmap_mat2"               
##  [7] "mat2_heatmap_body_wrap"      "mat2_heatmap_body_1_1"      
##  [9] "mat2_heatmap_body_1_2"       "mat2_heatmap_body_1_3"      
## [11] "mat2_heatmap_body_1_4"       "mat2_heatmap_body_1_5"      
## [13] "mat2_dend_row_1"             "mat2_dend_column_1"         
## [15] "mat2_dend_column_2"          "mat2_dend_column_3"         
## [17] "mat2_dend_column_4"          "mat2_dend_column_5"         
## [19] "annotation_empty_1"          "annotation_foo_1"           
## [21] "annotation_empty_2"          "annotation_foo_2"           
## [23] "annotation_empty_3"          "annotation_foo_3"           
## [25] "annotation_empty_4"          "annotation_foo_4"           
## [27] "annotation_empty_5"          "annotation_foo_5"           
## [29] "global-heatmap_legend_right" "heatmap_legend"</code></pre>
<p>If more than one group-level rectangles are to be added, we can wrap the code
into a simple function <code>group_block_anno()</code>:</p>
<div class="sourceCode" id="cb215"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>
    empty <span class="op">=</span> <span class="fu">anno_empty</span><span class="op">(</span>border <span class="op">=</span> <span class="cn">FALSE</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">8</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span>,
    foo <span class="op">=</span> <span class="fu">anno_block</span><span class="op">(</span>gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, labels <span class="op">=</span> <span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat2</span>, name <span class="op">=</span> <span class="st">"mat2"</span>, column_split <span class="op">=</span> <span class="va">split</span>, top_annotation <span class="op">=</span> <span class="va">ha</span>, 
    column_title <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/GetoptLong">GetoptLong</a></span><span class="op">)</span>  <span class="co"># for the function qq()</span>
<span class="va">group_block_anno</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">group</span>, <span class="va">empty_anno</span>, <span class="va">gp</span> <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span><span class="op">)</span>, 
    <span class="va">label</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">label_gp</span> <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>

    <span class="fu">seekViewport</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/GetoptLong/man/qq.html">qq</a></span><span class="op">(</span><span class="st">"annotation_@{empty_anno}_@{min(group)}"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">loc1</span> <span class="op">=</span> <span class="fu">deviceLoc</span><span class="op">(</span>x <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"npc"</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">seekViewport</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/GetoptLong/man/qq.html">qq</a></span><span class="op">(</span><span class="st">"annotation_@{empty_anno}_@{max(group)}"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">loc2</span> <span class="op">=</span> <span class="fu">deviceLoc</span><span class="op">(</span>x <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>

    <span class="fu">seekViewport</span><span class="op">(</span><span class="st">"global"</span><span class="op">)</span>
    <span class="fu">grid.rect</span><span class="op">(</span><span class="va">loc1</span><span class="op">$</span><span class="va">x</span>, <span class="va">loc1</span><span class="op">$</span><span class="va">y</span>, width <span class="op">=</span> <span class="va">loc2</span><span class="op">$</span><span class="va">x</span> <span class="op">-</span> <span class="va">loc1</span><span class="op">$</span><span class="va">x</span>, height <span class="op">=</span> <span class="va">loc2</span><span class="op">$</span><span class="va">y</span> <span class="op">-</span> <span class="va">loc1</span><span class="op">$</span><span class="va">y</span>, 
        just <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"bottom"</span><span class="op">)</span>, gp <span class="op">=</span> <span class="va">gp</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu">grid.text</span><span class="op">(</span><span class="va">label</span>, x <span class="op">=</span> <span class="op">(</span><span class="va">loc1</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">loc2</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">*</span><span class="fl">0.5</span>, y <span class="op">=</span> <span class="op">(</span><span class="va">loc1</span><span class="op">$</span><span class="va">y</span> <span class="op">+</span> <span class="va">loc2</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">*</span><span class="fl">0.5</span>, gp <span class="op">=</span> <span class="va">label_gp</span><span class="op">)</span>
    <span class="op">}</span>
<span class="op">}</span>

<span class="fu">group_block_anno</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="st">"empty"</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"group 1"</span><span class="op">)</span>
<span class="fu">group_block_anno</span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">5</span>, <span class="st">"empty"</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"group 2"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-67-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
<div id="blocks-as-plotting-regions" class="section level3" number="3.4.2">
<h3>
<span class="header-section-number">3.4.2</span> Blocks as plotting regions<a class="anchor" aria-label="anchor" href="#blocks-as-plotting-regions"><i class="fas fa-link"></i></a>
</h3>
<p>When heatmap is split, each block in block annotation can be thought as a
virtual plotting region. <code>anno_block()</code> allows an argument <code>panel_fun</code> which
accepts a self-defined function that draws graphics in each slice. It must
have two arguments:</p>
<ol style="list-style-type: decimal">
<li>row/column indices for the current slice (let’s call it <code>index</code>),</li>
<li>a vector of levels from the split variable that correspond to current slice (let’s call it <code>level</code>). When e.g. <code>row_km</code> is
only set or <code>row_split</code> is only set to one categorical variable, then <code>level</code> is a vector of length one. If there are multiple
categorical variables set with <code>row_km</code> and <code>row_split</code>, <code>level</code> is a vector of which the length is the same as the number
of categorical variables.</li>
</ol>
<p>When <code>panel_fun</code> is set, all other graphics parameters in <code>anno_block()</code> are ignored. See the following example:</p>
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"2"</span> <span class="op">=</span> <span class="st">"blue"</span>, <span class="st">"A"</span> <span class="op">=</span> <span class="st">"green"</span>, <span class="st">"B"</span> <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">2</span>, 
    row_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_block</span><span class="op">(</span>
    panel_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span>, <span class="va">levels</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu">grid.rect</span><span class="op">(</span>gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">col</span><span class="op">[</span><span class="va">levels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span>
        <span class="va">txt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">levels</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span>
        <span class="va">txt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">txt</span>, <span class="st">"\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span>, <span class="st">" rows"</span><span class="op">)</span>
        <span class="fu">grid.text</span><span class="op">(</span><span class="va">txt</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, rot <span class="op">=</span> <span class="fl">0</span>,
            gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="va">col</span><span class="op">[</span><span class="va">levels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>,
    width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">3</span>, <span class="st">"cm"</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-68-1.png" width="672" style="display: block; margin: auto;"></div>
<p>To make it more general, <code>anno_block()</code> accepts an argument <code>align_to</code> which defines
a list of indices that blocks will be corresponded to, but you need to make sure
the indices are continuously adjacent on heatmaps.</p>
<div class="sourceCode" id="cb217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">align_to</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"A"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">split</span> <span class="op">==</span> <span class="st">"A"</span><span class="op">)</span><span class="op">)</span>
<span class="va">panel_fun</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span>, <span class="va">nm</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">grid.rect</span><span class="op">(</span><span class="op">)</span>
    <span class="fu">grid.text</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span>, <span class="st">" rows"</span><span class="op">)</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_block</span><span class="op">(</span>
    align_to <span class="op">=</span> <span class="va">align_to</span>,
    panel_fun <span class="op">=</span> <span class="va">panel_fun</span>,
    width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">3</span>, <span class="st">"cm"</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-69-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p><code>anno_block()</code> normally works with <code>row_split</code>, but it is not necessary, see the following example:</p>
<div class="sourceCode" id="cb218"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">align_to</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"A"</span> <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, <span class="st">"B"</span> <span class="op">=</span> <span class="fl">7</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_block</span><span class="op">(</span>
    align_to <span class="op">=</span> <span class="va">align_to</span>,
    panel_fun <span class="op">=</span> <span class="va">panel_fun</span>,
    width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">3</span>, <span class="st">"cm"</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-70-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
</div>
<div id="image-annotation" class="section level2" number="3.5">
<h2>
<span class="header-section-number">3.5</span> Image annotation<a class="anchor" aria-label="anchor" href="#image-annotation"><i class="fas fa-link"></i></a>
</h2>
<p>Images can be added as annotations. <code>anno_image()</code> supports image in <code>png</code>,
<code>svg</code>, <code>pdf</code>, <code>eps</code>, <code>jpeg/jpg</code>, <code>tiff</code> formats. How they are imported as
annotations are as follows:</p>
<ul>
<li>
<code>png</code>, <code>jpeg/jpg</code> and <code>tiff</code> images are imported by <code><a href="https://rdrr.io/pkg/png/man/readPNG.html">png::readPNG()</a></code>,
<code><a href="https://rdrr.io/pkg/jpeg/man/readJPEG.html">jpeg::readJPEG()</a></code> and <code><a href="https://rdrr.io/pkg/tiff/man/readTIFF.html">tiff::readTIFF()</a></code>, and drawn by
<code><a href="https://rdrr.io/r/grid/grid.raster.html">grid::grid.raster()</a></code>.</li>
<li>
<code>svg</code> images are firstly reformatted by <code>rsvg::rsvg_svg()</code> and then imported
by <code><a href="https://rdrr.io/pkg/grImport2/man/readPicture.html">grImport2::readPicture()</a></code> and drawn by <code><a href="https://rdrr.io/pkg/grImport2/man/grid.picture.html">grImport2::grid.picture()</a></code>.</li>
<li>
<code>pdf</code> and <code>eps</code> images are imported by <code><a href="https://rdrr.io/pkg/grImport/man/PostScriptTrace.html">grImport::PostScriptTrace()</a></code> and
<code><a href="https://rdrr.io/pkg/grImport/man/readPicture.html">grImport::readPicture()</a></code>, later drawn by <code><a href="https://rdrr.io/pkg/grImport/man/grid.picture.html">grImport::grid.picture()</a></code>.</li>
</ul>
<p>The free icons for following examples are from
<a href="https://github.com/Keyamoon/IcoMoon-Free" class="uri">https://github.com/Keyamoon/IcoMoon-Free</a>. A vector of image paths are set as
the first argument of <code>anno_image()</code>.</p>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">image_png</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="st">"IcoMoon-Free-master/PNG/64px"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>
<span class="va">image_svg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="st">"IcoMoon-Free-master/SVG/"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>
<span class="va">image_eps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="st">"IcoMoon-Free-master/EPS/"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>
<span class="va">image_pdf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="st">"IcoMoon-Free-master/PDF/"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>

<span class="co"># we only draw the image annotation for PNG images, while the others are the same</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_image</span><span class="op">(</span><span class="va">image_png</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-72-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Different image formats can be mixed in the input vector.</p>
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_image</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">image_png</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="va">image_svg</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, 
    <span class="va">image_eps</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="va">image_pdf</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Border and background colors (if the images have transparent background) can
be set by <code>gp</code>.</p>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_image</span><span class="op">(</span><span class="va">image_png</span>, 
    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-75-1.png" width="576" style="display: block; margin: auto;"></div>
<p><code>border</code> controls the border of the whole annotation.</p>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_image</span><span class="op">(</span><span class="va">image_png</span>, border <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-77-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Padding or space around the images is set by <code>space</code>.</p>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_image</span><span class="op">(</span><span class="va">image_png</span>, space <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">3</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-79-1.png" width="576" style="display: block; margin: auto;"></div>
<p>If only some of the images need to be drawn, the other elements in the <code>image</code>
vector can be set to <code>''</code> or <code>NA</code>.</p>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">image_png</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="st">""</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_image</span><span class="op">(</span><span class="va">image_png</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-81-1.png" width="576" style="display: block; margin: auto;"></div>
</div>
<div id="points-annotation" class="section level2" number="3.6">
<h2>
<span class="header-section-number">3.6</span> Points annotation<a class="anchor" aria-label="anchor" href="#points-annotation"><i class="fas fa-link"></i></a>
</h2>
<p>Points annotation implemented by <code>anno_points()</code> shows distribution of a list
of data points. The data points object <code>x</code> can be a single vector or a matrix.
If it is a matrix, the graphics settings such as <code>pch</code>, <code>size</code> and <code>gp</code> can
correpspond to matrix columns. Note again, if <code>x</code> is a matrix, rows in <code>x</code>
correspond to columns in the heatmap matrix.</p>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-83-1.png" width="576" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>, nc <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, 
    pch <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-85-1.png" width="576" style="display: block; margin: auto;"></div>
<p><code>ylim</code> controls the range on “y-axis” or the “data axis” (if it is a row
annotation, the data axis is horizontal), <code>extend</code> controls the extended space
on the data axis direction. <code>axis</code> controls whether to show the axis and
<code>axis_param</code> controls the settings for axis. The default settings for axis are:</p>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">default_axis_param</span><span class="op">(</span><span class="st">"column"</span><span class="op">)</span></code></pre></div>
<pre><code>## $at
## NULL
## 
## $labels
## NULL
## 
## $labels_rot
## [1] 0
## 
## $gp
## $fontsize
## [1] 8
## 
## 
## $side
## [1] "left"
## 
## $facing
## [1] "outside"
## 
## $direction
## [1] "normal"</code></pre>
<p>And you can overwrite some of them:</p>
<div class="sourceCode" id="cb229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,
    axis_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        side <span class="op">=</span> <span class="st">"right"</span>,
        at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>, 
        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"zero"</span>, <span class="st">"half"</span>, <span class="st">"one"</span><span class="op">)</span>
    <span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-88-1.png" width="576" style="display: block; margin: auto;"></div>
<p>One thing that might be useful is you can control the rotation of the axis
labels.</p>
<div class="sourceCode" id="cb230"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,
    width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span>,
    axis_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        side <span class="op">=</span> <span class="st">"bottom"</span>,
        at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>, 
        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"zero"</span>, <span class="st">"half"</span>, <span class="st">"one"</span><span class="op">)</span>,
        labels_rot <span class="op">=</span> <span class="fl">45</span>
    <span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-90-1.png" width="108.850393700787" style="display: block; margin: auto;"></div>
<p><strong>The configuration of axis is same for all other annotation functions which have
axes.</strong></p>
<p>The default size of the points annotation is 5mm. It can be controlled by
<code>height</code>/<code>width</code> argument in <code>anno_points()</code>.</p>
<div class="sourceCode" id="cb231"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-92-1.png" width="576" style="display: block; margin: auto;"></div>
</div>
<div id="lines-annotation" class="section level2" number="3.7">
<h2>
<span class="header-section-number">3.7</span> Line annotation<a class="anchor" aria-label="anchor" href="#lines-annotation"><i class="fas fa-link"></i></a>
</h2>
<p><code>anno_lines()</code> connects the data points by a list of segments. Similar as
<code>anno_points()</code>, the data variable can be a numeric vector:</p>
<div class="sourceCode" id="cb232"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_lines</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-94-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Or a matrix:</p>
<div class="sourceCode" id="cb233"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_lines</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, add_points <span class="op">=</span> <span class="cn">TRUE</span>, pt_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">16</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-96-1.png" width="576" style="display: block; margin: auto;"></div>
<p>As shown above, points can be added to the lines by setting <code>add_points = TRUE</code>.</p>
<p>Smoothed lines (by <code><a href="https://rdrr.io/r/stats/loess.html">loess()</a></code>) can be added instead of the original lines by
setting <code>smooth = TRUE</code>, but it should be used with caution because the order of
columns in the heatmap is used as “x-value” for the fitting and only if you think
the fitting against the reordered order makes sense.</p>
<p>Smoothing also works when the input data variable is a matrix that the smoothing
is performed for each column separately.</p>
<p>If <code>smooth</code> is <code>TRUE</code>, <code>add_points</code> is set to <code>TRUE</code> by default.</p>
<div class="sourceCode" id="cb234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_lines</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, smooth <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-98-1.png" width="576" style="display: block; margin: auto;"></div>
<p>The default size of the lines annotation is 5mm. It can be controlled by
<code>height</code>/<code>width</code> argument in <code>anno_lines()</code>.</p>
<div class="sourceCode" id="cb235"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_lines</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="barplot_annotation" class="section level2" number="3.8">
<h2>
<span class="header-section-number">3.8</span> Barplot annotation<a class="anchor" aria-label="anchor" href="#barplot_annotation"><i class="fas fa-link"></i></a>
</h2>
<p>The data points can be represented as barplots. Some of the arguments in
<code>anno_barplot()</code> such as <code>ylim</code>, <code>axis</code>, <code>axis_param</code> are the same as
<code>anno_points()</code>.</p>
<div class="sourceCode" id="cb236"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-101-1.png" width="576" style="display: block; margin: auto;"></div>
<p>The width of bars is controlled by <code>bar_width</code>. It is a relative value to the
width of the cell in the heatmap.</p>
<div class="sourceCode" id="cb237"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, bar_width <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-103-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Graphic parameters are controlled by <code>gp</code>.</p>
<div class="sourceCode" id="cb238"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-105-1.png" width="576" style="display: block; margin: auto;"></div>
<p>You can choose the baseline of bars by <code>baseline</code>.</p>
<div class="sourceCode" id="cb239"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, baseline <span class="op">=</span> <span class="st">"min"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-107-1.png" width="576" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb240"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, baseline <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-109-1.png" width="576" style="display: block; margin: auto;"></div>
<p>If the input value is a matrix, it will be stacked barplots.</p>
<div class="sourceCode" id="cb241"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nc <span class="op">=</span> <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-111-1.png" width="576" style="display: block; margin: auto;"></div>
<p>And length of parameters in <code>gp</code> can be the number of the columns in the matrix:</p>
<div class="sourceCode" id="cb242"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, 
    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, col <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-113-1.png" width="576" style="display: block; margin: auto;"></div>
<p>The default size of the barplot annotation is 5mm. It can be controlled by
<code>height</code>/<code>width</code> argument in <code>anno_barplot()</code>.</p>
<div class="sourceCode" id="cb243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Following example shows a barplot annotation which visualizes a proportion
matrix (for which row sums are 1).</p>
<div class="sourceCode" id="cb244"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">4</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span>, nc <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">m</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="va">m</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, 
    bar_width <span class="op">=</span> <span class="fl">1</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">6</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-116-1.png" width="576" style="display: block; margin: auto;"></div>
<p>The direction of the axis can be reversed which is useful when the annotation
is put on the left of the heatmap.</p>
<div class="sourceCode" id="cb245"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha_list</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>axis_reverse <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="va">m</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, 
    axis_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>direction <span class="op">=</span> <span class="st">"reverse"</span><span class="op">)</span>, 
    bar_width <span class="op">=</span> <span class="fl">1</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
<span class="fu">rowAnnotation</span><span class="op">(</span>axis_normal <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="va">m</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, 
    bar_width <span class="op">=</span> <span class="fl">1</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu">draw</span><span class="op">(</span><span class="va">ha_list</span>, ht_gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-117-1.png" width="432" style="display: block; margin: auto;"></div>
<p><code>direction = "reverse"</code> also works for other annotation functions which have
axes, but it is more commonly used for barplot annotations.</p>
<p>Argument <code>add_numbers</code> can be set to <code>TRUE</code> so that numbers associated to bars are drawn on top of the bars.
For column annotation, texts are by default with 45 degree rotation.</p>
<div class="sourceCode" id="cb246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, add_numbers <span class="op">=</span> <span class="cn">TRUE</span>, 
    height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-119-1.png" width="576" style="display: block; margin: auto;"></div>
<p>When the input for <code>anno_barplot()</code> is a matrix, argument <code>beside</code> can be set to
<code>TRUE</code> so that bars for a same heatmap column are positioned by each other:</p>
<div class="sourceCode" id="cb247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nc <span class="op">=</span> <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
    beside <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-121-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Argument <code>attach</code> can be set to <code>TRUE</code> so that two adjacent bars are attached.</p>
<div class="sourceCode" id="cb248"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nc <span class="op">=</span> <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
    beside <span class="op">=</span> <span class="cn">TRUE</span>, attach <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-123-1.png" width="576" style="display: block; margin: auto;"></div>
</div>
<div id="box-annotation" class="section level2" number="3.9">
<h2>
<span class="header-section-number">3.9</span> Boxplot annotation<a class="anchor" aria-label="anchor" href="#box-annotation"><i class="fas fa-link"></i></a>
</h2>
<p>Boxplot annotation as well as the annotation functions which are introduced
later are more suitable for small matrice. I don’t think you want to put
boxplots as column annotation for a matrix with 100 columns.</p>
<p>For <code>anno_boxplot()</code>, the input data variable should be a matrix or a list. If
<code>x</code> is a matrix and if it is a column annotation, statistics for boxplots are
calculated by columns, and if it is a row annotation, the calculation is done
by rows.</p>
<div class="sourceCode" id="cb249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span>
<span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_boxplot</span><span class="op">(</span><span class="va">m</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-125-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Graphic parameters are controlled by <code>gp</code>.</p>
<div class="sourceCode" id="cb250"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_boxplot</span><span class="op">(</span><span class="va">m</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span>, 
    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-127-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Width of the boxes are controlled by <code>box_width</code>. <code>outline</code> controls whether to
show outlier points.</p>
<div class="sourceCode" id="cb251"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_boxplot</span><span class="op">(</span><span class="va">m</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span>, 
    box_width <span class="op">=</span> <span class="fl">0.9</span>, outline <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-129-1.png" width="576" style="display: block; margin: auto;"></div>
<p><code>anno_boxplot()</code> only draws one boxplot for one single row. Section
<a href="more-examples.html#add-multiple-boxplots-for-single-row">14.6</a> demonstrates how to define an annotation function which
draws multiple boxplots for a single row, and Section <a href="heatmap-annotations.html#zoom-annotation">3.18</a>
demonstrates how to draw one single boxplot for a group of rows.</p>
</div>
<div id="histogram-annotation" class="section level2" number="3.10">
<h2>
<span class="header-section-number">3.10</span> Histogram annotation<a class="anchor" aria-label="anchor" href="#histogram-annotation"><i class="fas fa-link"></i></a>
</h2>
<p>Annotations as histograms are more suitable to put as row annotations. The
setting for the data variable is the same as <code>anno_boxplot()</code> which can be a
matrix or a list.</p>
<p>Similar as <code>anno_boxplot()</code>, the input data variable should be a matrix or a list. If
<code>x</code> is a matrix and if it is a column annotation, histograms are
calculated by columns, and if it is a row annotation, histograms are calculated
by rows.</p>
<div class="sourceCode" id="cb252"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, nc <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_histogram</span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span> <span class="co"># apply `m` on rows</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-131-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
<p>Number of breaks for histograms is controlled by <code>n_breaks</code>.</p>
<div class="sourceCode" id="cb253"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_histogram</span><span class="op">(</span><span class="va">m</span>, n_breaks <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-133-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
<p>Colors are controlled by <code>gp</code>.</p>
<div class="sourceCode" id="cb254"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_histogram</span><span class="op">(</span><span class="va">m</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-135-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
</div>
<div id="density-annotation" class="section level2" number="3.11">
<h2>
<span class="header-section-number">3.11</span> Density annotation<a class="anchor" aria-label="anchor" href="#density-annotation"><i class="fas fa-link"></i></a>
</h2>
<p>Similar as histogram annotations, <code>anno_density()</code> shows the distribution
as a fitted curve.</p>
<div class="sourceCode" id="cb255"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_density</span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-137-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
<p>The height of the density peaks can be controlled to make the distribution
look like a <a href="http://blog.revolutionanalytics.com/2017/07/joyplots.html">“joyplot”</a>.</p>
<div class="sourceCode" id="cb256"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_density</span><span class="op">(</span><span class="va">m</span>, joyplot_scale <span class="op">=</span> <span class="fl">2</span>, 
    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#CCCCCC80"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-139-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
<p>Or visualize the distribution as violin plot.</p>
<div class="sourceCode" id="cb257"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_density</span><span class="op">(</span><span class="va">m</span>, type <span class="op">=</span> <span class="st">"violin"</span>, 
    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-141-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
<p>When there are too many rows in the input variable, the space for normal
density peaks might be too small. In this case, we can visualize the
distribution by heatmaps.</p>
<div class="sourceCode" id="cb258"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">50</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_density</span><span class="op">(</span><span class="va">m2</span>, type <span class="op">=</span> <span class="st">"heatmap"</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">6</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-143-1.png" width="241.889763779528" style="display: block; margin: auto;"></div>
<p>THe color schema for heatmap distribution is controlled by <code>heatmap_colors</code>.</p>
<div class="sourceCode" id="cb259"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_density</span><span class="op">(</span><span class="va">m2</span>, type <span class="op">=</span> <span class="st">"heatmap"</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">6</span>, <span class="st">"cm"</span><span class="op">)</span>, 
    heatmap_colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"orange"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-145-1.png" width="241.889763779528" style="display: block; margin: auto;"></div>
<p>In <strong>ComplexHeatmap</strong> package, there is a <code>densityHeatmap()</code> function which
visualizes distribution as a heatmap. It will be introduced in Section
<a href="other-high-level-plots.html#density-heatmap">11.1</a>.</p>
</div>
<div id="joyplot-annotation" class="section level2" number="3.12">
<h2>
<span class="header-section-number">3.12</span> Joyplot annotation<a class="anchor" aria-label="anchor" href="#joyplot-annotation"><i class="fas fa-link"></i></a>
</h2>
<p><code>anno_joyplot()</code> is specific for so-called joyplot (<a href="http://blog.revolutionanalytics.com/2017/07/joyplots.html" class="uri">http://blog.revolutionanalytics.com/2017/07/joyplots.html</a>).
The input data should be a matrix or a list.</p>
<p>Note <code>anno_joyplot()</code> is always applied to columns if the input is a matrix.
Because joyplot visualizes parallel distributions and the matrix is not a
necessary format while a list is already enough for it, if you are not sure
about how to set as a matrix, just convert it to a list for using it.</p>
<div class="sourceCode" id="cb260"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, nc <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="va">lt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">m</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_joyplot</span><span class="op">(</span><span class="va">lt</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span>, 
    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, transparency <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-147-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
<p>Or only show the lines (<code>scale</code> argument controls the relative height of the
curves).</p>
<div class="sourceCode" id="cb261"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5000</span><span class="op">)</span>, nc <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">lt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">m</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_joyplot</span><span class="op">(</span><span class="va">lt</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>, 
    scale <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-149-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
<p>The format of the input variable is special. It can be one of the following
two:</p>
<ol style="list-style-type: decimal">
<li>a matrix (remember <code>anno_joyplot()</code> is always applied to columns of the
matrix) where x coordinate corresponds to <code>1:nrow(matrix)</code> and each column
in the matrix corresponds to one distribution in the joyplot.</li>
<li>a list of data frames where each data frame has two columns which
correspond to x coordinate and y coordinate.</li>
</ol>
</div>
<div id="horizon-chart-annotation" class="section level2" number="3.13">
<h2>
<span class="header-section-number">3.13</span> Horizon chart annotation<a class="anchor" aria-label="anchor" href="#horizon-chart-annotation"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://flowingdata.com/2015/07/02/changing-price-of-food-items-and-horizon-graphs/">Horizon
chart</a>
as annotation can only be added as row annotation. The format of the input
variable for <code>anno_horizon()</code> is the same as <code>anno_joyplot()</code> which is
introduced in previous section.</p>
<p>The default style of horizon chart annotation is:</p>
<div class="sourceCode" id="cb262"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumprod</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="op">-</span><span class="va">x</span><span class="op">/</span><span class="fl">100</span>, <span class="va">x</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_horizon</span><span class="op">(</span><span class="va">lt</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-151-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
<p>Values in each track are normalized by <code>x/max(abs(x))</code>.</p>
<p>Colors for positive values and negative values are controlled by <code>pos_fill</code>
and <code>neg_fill</code> in <code>gpar()</code>.</p>
<div class="sourceCode" id="cb263"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_horizon</span><span class="op">(</span><span class="va">lt</span>, 
    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>pos_fill <span class="op">=</span> <span class="st">"orange"</span>, neg_fill <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-153-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
<p><code>pos_fill</code> and <code>neg_fill</code> can be assigned as a vector.</p>
<div class="sourceCode" id="cb264"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_horizon</span><span class="op">(</span><span class="va">lt</span>, 
    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>pos_fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"orange"</span>, <span class="st">"red"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
              neg_fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkgreen"</span>, <span class="st">"blue"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-155-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
<p>Whether the peaks for negative values start from the bottom or from the top.</p>
<div class="sourceCode" id="cb265"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_horizon</span><span class="op">(</span><span class="va">lt</span>, negative_from_top <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-157-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
<p>The space between every two neighbouring charts.</p>
<div class="sourceCode" id="cb266"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_horizon</span><span class="op">(</span><span class="va">lt</span>, gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-159-1.png" width="166.299212598425" style="display: block; margin: auto;"></div>
</div>
<div id="text-annotation" class="section level2" number="3.14">
<h2>
<span class="header-section-number">3.14</span> Text annotation<a class="anchor" aria-label="anchor" href="#text-annotation"><i class="fas fa-link"></i></a>
</h2>
<p>Text can be used as annotations by <code>anno_text()</code>. Graphics parameters are controlled
by <code>gp</code>.</p>
<div class="sourceCode" id="cb267"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_text</span><span class="op">(</span><span class="va">month.name</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">+</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-161-1.png" width="113.507443569554" style="display: block; margin: auto;"></div>
<p>Locationsn are controlled by <code>location</code> and <code>just</code>. Rotation is controlled by <code>rot</code>.</p>
<div class="sourceCode" id="cb268"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_text</span><span class="op">(</span><span class="va">month.name</span>, location <span class="op">=</span> <span class="fl">1</span>, rot <span class="op">=</span> <span class="fl">30</span>, 
    just <span class="op">=</span> <span class="st">"right"</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">+</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-163-1.png" width="102.719105697635" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb269"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_text</span><span class="op">(</span><span class="va">month.name</span>, location <span class="op">=</span> <span class="fl">0.5</span>, just <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-165-1.png" width="93.3741102362204" style="display: block; margin: auto;"></div>
<p><code>location</code> and <code>just</code> are automatically calculated according the the position
of the annotations put to the heatmap (e.g. text are aligned to the left if it
is a right annotation to the heatmap and are aligned to the right it it is a
left annotation).</p>
<p>The width/height are automatically calculated based on all the text. Normally
you don’t need to manually set the width/height of it.</p>
<p>Background colors can be set by <code>gp</code>. Here <code>fill</code> controls the filled
background color, <code>col</code> controls the color of text and the non-standard
<code>border</code> controls the background border color.</p>
<p>You can see we explicitly set <code>width</code> as 1.2 times the width of the longest
text.</p>
<div class="sourceCode" id="cb270"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_text</span><span class="op">(</span><span class="va">month.name</span>, location <span class="op">=</span> <span class="fl">0.5</span>, just <span class="op">=</span> <span class="st">"center"</span>,
    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"white"</span>, border <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,
    width <span class="op">=</span> <span class="fu">max_text_width</span><span class="op">(</span><span class="va">month.name</span><span class="op">)</span><span class="op">*</span><span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-167-1.png" width="109.02531023622" style="display: block; margin: auto;"></div>
<p>More complicated texts can be drawn by integrating with the <strong>gridtext</strong>
package (Section <a href="integrate-with-other-packages.html#gridtext-annotations">10.3.3</a>). A quick example is as follows:</p>
<div class="sourceCode" id="cb271"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">text</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/GetoptLong/man/qq.html">qq</a></span><span class="op">(</span><span class="st">"&lt;span style='color:red'&gt;**@{x}**&lt;sub&gt;@{x}&lt;/sub&gt;&lt;/span&gt;_@{x}_&lt;sup&gt;@{x}&lt;/sup&gt;"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>
    foo <span class="op">=</span> <span class="fu">anno_text</span><span class="op">(</span><span class="fu">gt_render</span><span class="op">(</span><span class="va">text</span>, align_widths <span class="op">=</span> <span class="cn">TRUE</span>, 
                        r <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"pt"</span><span class="op">)</span>,
                        padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"pt"</span><span class="op">)</span><span class="op">)</span>, 
                    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>box_col <span class="op">=</span> <span class="st">"blue"</span>, box_lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, 
                    just <span class="op">=</span> <span class="st">"right"</span>, 
                    location <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>
    <span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-169-1.png" width="66.0741849560212" style="display: block; margin: auto;"></div>
<p>Unlike other annotations, by default there is no annotation title for text annotation. The title
can be added by setting <code>show_name = TRUE</code> in <code>anno_text()</code>:</p>
<div class="sourceCode" id="cb272"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">+</span> <span class="fu">rowAnnotation</span><span class="op">(</span>month <span class="op">=</span> <span class="fu">anno_text</span><span class="op">(</span><span class="va">month.name</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, just <span class="op">=</span> <span class="st">"center"</span>, 
        location <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"npc"</span><span class="op">)</span>, show_name <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, 
    annotation_name_rot <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-170-1.png" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="anno-numeric" class="section level2" number="3.15">
<h2>
<span class="header-section-number">3.15</span> Numeric labels annotation<a class="anchor" aria-label="anchor" href="#anno-numeric"><i class="fas fa-link"></i></a>
</h2>
<p>There is a special text annotation for numeric labels. To emphasize the visual effect,
we also want to add bars to show the absolute values of the numbers. This can be
done with <code>anno_numeric()</code> function. Note currently it only supports row annotation.</p>
<div class="sourceCode" id="cb273"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>numeric <span class="op">=</span> <span class="fu">anno_numeric</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, annotation_name_rot <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-172-1.png" width="90.7086614173228" style="display: block; margin: auto;"></div>
<p>Background colors can by controlled by <code>bg_gp</code>.</p>
<div class="sourceCode" id="cb274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>numeric <span class="op">=</span> <span class="fu">anno_numeric</span><span class="op">(</span><span class="va">x</span>, 
        bg_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"orange"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span>,
    annotation_name_rot <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-174-1.png" width="90.7086614173228" style="display: block; margin: auto;"></div>
<p><code>align_to</code> can be set to <code>"right"</code> or <code>"left"</code>:</p>
<div class="sourceCode" id="cb275"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>numeric <span class="op">=</span> <span class="fu">anno_numeric</span><span class="op">(</span><span class="va">x</span>, 
        bg_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"orange"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,
        align_to <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>,
    annotation_name_rot <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-176-1.png" width="90.7086614173228" style="display: block; margin: auto;"></div>
<p>Format of labels on the plot can be controlled by <code>labels_format</code>:</p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>numeric <span class="op">=</span> <span class="fu">anno_numeric</span><span class="op">(</span><span class="va">x</span>,
        labels_format <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.2f"</span>, <span class="va">x</span><span class="op">*</span><span class="fl">100</span><span class="op">)</span>, <span class="st">"%"</span><span class="op">)</span><span class="op">)</span>,
    annotation_name_rot <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-178-1.png" width="90.7086614173228" style="display: block; margin: auto;"></div>
<p>It is also possible to show a numeric vector with both negative and positive values.
In this case, all graphics parameters should have length of two where the first one
controls negative values and the second controls positive values.</p>
<div class="sourceCode" id="cb277"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>numeric <span class="op">=</span> <span class="fu">anno_numeric</span><span class="op">(</span><span class="va">x</span>, 
        bg_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
    annotation_name_rot <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-180-1.png" width="125.779742448757" style="display: block; margin: auto;"></div>
<p>Another example is to visualize a vector of p-values. Here we should apply <code>-log10()</code>
on p-values for mapping to bar heights with <code>x_convert</code> argument:</p>
<div class="sourceCode" id="cb278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>pvalue <span class="op">=</span> <span class="fu">anno_numeric</span><span class="op">(</span><span class="va">x</span>, 
        rg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,
        x_convert <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, 
        labels_format <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.2e"</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span>,
    annotation_name_rot <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-182-1.png" width="92.9129263424886" style="display: block; margin: auto;"></div>
</div>
<div id="completely-customized-annotation" class="section level2" number="3.16">
<h2>
<span class="header-section-number">3.16</span> Completely customized annotation<a class="anchor" aria-label="anchor" href="#completely-customized-annotation"><i class="fas fa-link"></i></a>
</h2>
<p>For most annotation functions implemented in <strong>ComplexHeatmap</strong>, they only
draw one same type of annotation graphics, e.g. <code>anno_points()</code> only draws
points or <code>anno_image()</code> only draws images. From <strong>ComplexHeatmap</strong> version 2.9.4, we added a new annotation
function <code>anno_customize()</code>, with which you can completely freely define
graphics for every annotation cell.</p>
<p>The input for <code>anno_customize()</code> should be a categorical vector.</p>
<div class="sourceCode" id="cb279"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>, <span class="st">"c"</span>, <span class="st">"d"</span>, <span class="st">"d"</span><span class="op">)</span></code></pre></div>
<p>For each level, you need to define a graphics function for it.</p>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">graphics</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="st">"a"</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">w</span>, <span class="va">h</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu">grid.rect</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">w</span><span class="op">*</span><span class="fl">0.8</span>, <span class="va">h</span><span class="op">*</span><span class="fl">0.33</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>,
    <span class="st">"b"</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">w</span>, <span class="va">h</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu">grid.text</span><span class="op">(</span><span class="st">"A"</span>, <span class="va">x</span>, <span class="va">y</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>,
    <span class="st">"c"</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">w</span>, <span class="va">h</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu">grid.points</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>
    <span class="op">}</span>,
    <span class="st">"d"</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">w</span>, <span class="va">h</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">img</span> <span class="op">=</span> <span class="fu">png</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/png/man/readPNG.html">readPNG</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Rlogo.png"</span>, package <span class="op">=</span> <span class="st">"circlize"</span><span class="op">)</span><span class="op">)</span>
        <span class="fu">grid.raster</span><span class="op">(</span><span class="va">img</span>, <span class="va">x</span>, <span class="va">y</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.8</span>, <span class="st">"snpc"</span><span class="op">)</span>, 
            height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.8</span>, <span class="st">"snpc"</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
<span class="op">)</span></code></pre></div>
<p>When adding graphics, each annotation cell is an independent viewport, thus, the self-defined graphics function accepts four arguments: <code>x</code> and <code>y</code>: the center
of the viewport of the annotation cell, <code>w</code> and <code>h</code>: the width and height of the viewport. In the example above, we set a horizontal bar for <code>"a"</code>, a text for <code>"b"</code>,
a point for <code>"c"</code> and an image for <code>"d"</code>.</p>
<p>Then we add this new annotation to both row and column of the heatmap, just in the same way as normal annotations.</p>
<div class="sourceCode" id="cb281"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span>, 
    top_annotation <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_customize</span><span class="op">(</span><span class="va">x</span>, graphics <span class="op">=</span> <span class="va">graphics</span><span class="op">)</span><span class="op">)</span>,
    right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>bar <span class="op">=</span> <span class="fu">anno_customize</span><span class="op">(</span><span class="va">x</span>, graphics <span class="op">=</span> <span class="va">graphics</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-185-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Reordering and splitting are automatically adjusted.</p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span>, 
    top_annotation <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_customize</span><span class="op">(</span><span class="va">x</span>, graphics <span class="op">=</span> <span class="va">graphics</span><span class="op">)</span><span class="op">)</span>,
    right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>bar <span class="op">=</span> <span class="fu">anno_customize</span><span class="op">(</span><span class="va">x</span>, graphics <span class="op">=</span> <span class="va">graphics</span><span class="op">)</span><span class="op">)</span>,
    column_split <span class="op">=</span> <span class="va">x</span>, row_split <span class="op">=</span> <span class="va">x</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-186-1.png" width="672" style="display: block; margin: auto;"></div>
<p><code>Legend()</code> function also accepts a <code>graphics</code> argument, so it is easy to add
legends for the “customized annotations.” How to use <code>Legend()</code> function will
be introduced in Chapter <a href="legends.html#legends">5</a>.</p>
<div class="sourceCode" id="cb283"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span>, 
    top_annotation <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_customize</span><span class="op">(</span><span class="va">x</span>, graphics <span class="op">=</span> <span class="va">graphics</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">lgd</span> <span class="op">=</span> <span class="fu">Legend</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"foo"</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">graphics</span><span class="op">)</span>, graphics <span class="op">=</span> <span class="va">graphics</span><span class="op">)</span>
<span class="fu">draw</span><span class="op">(</span><span class="va">ht</span>, annotation_legend_list <span class="op">=</span> <span class="va">lgd</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-187-1.png" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="mark-annotation" class="section level2" number="3.17">
<h2>
<span class="header-section-number">3.17</span> Mark annotation<a class="anchor" aria-label="anchor" href="#mark-annotation"><i class="fas fa-link"></i></a>
</h2>
<p>Sometimes there are many rows or columns in the heatmap and we want to mark
some of them. <code>anno_mark()</code> is used to mark subset of rows or columns and
connect to labels with lines.</p>
<p><code>anno_mark()</code> at least needs two arguments where <code>at</code> are the indices to the
original matrix and <code>labels</code> are the corresponding text.</p>
<div class="sourceCode" id="cb284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_mark</span><span class="op">(</span>at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">20</span>, <span class="fl">60</span>, <span class="fl">97</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span>, 
    labels <span class="op">=</span> <span class="va">month.name</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>, right_annotation <span class="op">=</span> <span class="va">ha</span>,
    row_names_side <span class="op">=</span> <span class="st">"left"</span>, row_names_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>, right_annotation <span class="op">=</span> <span class="va">ha</span>,
    row_names_side <span class="op">=</span> <span class="st">"left"</span>, row_names_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, row_km <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-189-1.png" width="672" style="display: block; margin: auto;"></div>
<p>The calculation of positions of texts depends on the absolute size of the graphics
device. If you resize the current interactive device or you use <code>grid.grabExpr()</code>
to capture the current plot, you might see the positions of texts are all corrupt.
Please refer to Section <a href="integrate-with-other-packages.html#cowplot">10.2</a> for a solution.</p>
</div>
<div id="zoom-annotation" class="section level2" number="3.18">
<h2>
<span class="header-section-number">3.18</span> Zoom/link annotation<a class="anchor" aria-label="anchor" href="#zoom-annotation"><i class="fas fa-link"></i></a>
</h2>
<p><code>anno_mark()</code> connects single row or column on the heatmap to a label, the
next annotation function <code>anno_link()</code> connects subsets of rows or columns to
plotting regions where more comprehensive graphics can be added there.
See following example where we make boxplot for every row group.</p>
<div class="sourceCode" id="cb285"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="va">subgroup</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="va">rg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>
<span class="va">panel_fun</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span>, <span class="va">nm</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">pushViewport</span><span class="op">(</span><span class="fu">viewport</span><span class="op">(</span>xscale <span class="op">=</span> <span class="va">rg</span>, yscale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">grid.rect</span><span class="op">(</span><span class="op">)</span>
    <span class="fu">grid.xaxis</span><span class="op">(</span>gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">grid.boxplot</span><span class="op">(</span><span class="va">m</span><span class="op">[</span><span class="va">index</span>, <span class="op">]</span>, pos <span class="op">=</span> <span class="fl">1</span>, direction <span class="op">=</span> <span class="st">"horizontal"</span><span class="op">)</span>
    <span class="fu">popViewport</span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">anno</span> <span class="op">=</span> <span class="fu">anno_link</span><span class="op">(</span>align_to <span class="op">=</span> <span class="va">subgroup</span>, which <span class="op">=</span> <span class="st">"row"</span>, panel_fun <span class="op">=</span> <span class="va">panel_fun</span>, 
    size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span>, gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span>, name <span class="op">=</span> <span class="st">"mat"</span>, right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="va">anno</span><span class="op">)</span>, 
    row_split <span class="op">=</span> <span class="va">subgroup</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-190-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The important arguments for <code>anno_zoom()</code> are:</p>
<ol style="list-style-type: decimal">
<li>
<code>align_to</code>: It defines how the plotting regions (or the boxes) correspond
to the rows or the columns in the heatmap. If the value is a list of
indices, each box corresponds to the rows or columns with indices in one
vector in the list. If the value is a categorical variable (e.g. a factor
or a character vector) that has the same length as the rows or columns in
the heatmap, each box corresponds to the rows/columns in each level in the
categorical variable.</li>
<li>
<code>panel_fun</code>: A self-defined function that defines how to draw graphics in
the box. The function must have a <code>index</code> argument which is the indices for
the rows/columns that the box corresponds to. It can have a second argument
<code>nm</code> which is the “name” of the selected part in the heatmap. The
corresponding value for <code>nm</code> comes from <code>align_to</code> if it is specified as a
categorical variable or a list with names.</li>
<li>
<code>size</code>: The size of boxes. It can be pure numeric that they are treated as
relative fractions of the total height/width of the heatmap. The value of
<code>size</code> can also be absolute units.</li>
<li>
<code>gap</code>: Gaps between boxes. It should be a <code>unit</code> object.</li>
</ol>
<p>In previous example, <code>align_to</code> is set as a categorical variable. In the next
example, <code>align_to</code> is set as a list of indicies and only cover slices “a” and “b.”</p>
<div class="sourceCode" id="cb286"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">align_to</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, <span class="va">subgroup</span><span class="op">)</span>
<span class="va">align_to</span> <span class="op">=</span> <span class="va">align_to</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">]</span>
<span class="va">anno</span> <span class="op">=</span> <span class="fu">anno_link</span><span class="op">(</span>align_to <span class="op">=</span> <span class="va">align_to</span>, which <span class="op">=</span> <span class="st">"row"</span>, panel_fun <span class="op">=</span> <span class="va">panel_fun</span>, 
    size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span>, gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span>, name <span class="op">=</span> <span class="st">"mat"</span>, right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="va">anno</span><span class="op">)</span>, 
    row_split <span class="op">=</span> <span class="va">subgroup</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-191-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p><code>anno_link()</code> also works for column annotations.</p>
<p>Similar as <code>anno_mark()</code>, the positions of the plotting regions also depends
on the absolute size of the graphic device. If you resize the current
interactive device or you use <code>grid.grabExpr()</code> to capture the current plot,
you might see the positions of texts are all corrupt. Please refer to Section
<a href="integrate-with-other-packages.html#cowplot">10.2</a> for a solution.</p>
<p>As show in the previous examples, <code>anno_link()</code> normally works together with
<code>row_split</code>/<code>column_split</code> to associate additional graphics to slices. However,
it is not necessary, as long as rows with indices in <code>align_to</code> are continuously
adjacent on heatmaps.</p>
<div class="sourceCode" id="cb287"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">align_to</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span>
<span class="va">anno</span> <span class="op">=</span> <span class="fu">anno_link</span><span class="op">(</span>align_to <span class="op">=</span> <span class="va">align_to</span>, which <span class="op">=</span> <span class="st">"row"</span>, panel_fun <span class="op">=</span> <span class="va">panel_fun</span>, 
    size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span>, gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># here row indices 1 to 20 are adjacent since no clustering is applied on rows</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span>, name <span class="op">=</span> <span class="st">"mat"</span>, right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="va">anno</span><span class="op">)</span>, 
    cluster_rows <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-192-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
<div id="anno-text-box" class="section level2" number="3.19">
<h2>
<span class="header-section-number">3.19</span> Text box annotation<a class="anchor" aria-label="anchor" href="#anno-text-box"><i class="fas fa-link"></i></a>
</h2>
<p>From <strong>ComplexHeatmap</strong> 2.11.1, there are supports for drawing text boxes and associating them
to heatmaps.</p>
<div id="construct-the-text-box" class="section level3" number="3.19.1">
<h3>
<span class="header-section-number">3.19.1</span> Construct the text box<a class="anchor" aria-label="anchor" href="#construct-the-text-box"><i class="fas fa-link"></i></a>
</h3>
<p>Text box annotation depends on the text box “grob.” The text box grob can be
constructed with the function <code>textbox_grob()</code>. It accpets a character vector
with words or phrases/sentences. We first demonstrate the use of words.</p>
<p>Following functionn <code>random_text()</code> generates a vector of random words or phrases.</p>
<div class="sourceCode" id="cb288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">random_text</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">n_words</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span>
         <span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">n_words</span>, <span class="fl">1</span><span class="op">)</span>, 
            <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">n_words</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">w</span>, collapse <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
            <span class="va">w</span>
        <span class="op">}</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Following code shows how to set graphics parameters:</p>
<div class="sourceCode" id="cb289"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">words</span> <span class="op">=</span> <span class="fu">random_text</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">words</span></code></pre></div>
<pre><code>##  [1] "sncjrkeyti" "hgjisd"     "kgul"       "mgixj"      "ugzfbe"    
##  [6] "mrafuoi"    "ptfkh"      "gpqvrxbdm"  "sytvnchpl"  "nczg"</code></pre>
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">words</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-194-1.png" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb292"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">words</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-194-2.png" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb293"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">words</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">5</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-194-3.png" width="672" style="display: block; margin: auto;"></div>
<p>Following code shows how to set the background:</p>
<div class="sourceCode" id="cb294"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">words</span>, background_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#CCCCCC"</span>, col <span class="op">=</span> <span class="st">"#808080"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-195-1.png" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb295"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">words</span>, background_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#CCCCCC"</span>, col <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>, 
    round_corners <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-195-2.png" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb296"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">words</span>, background_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#CCCCCC"</span>, col <span class="op">=</span> <span class="st">"#808080"</span><span class="op">)</span>, 
    padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-195-3.png" width="672" style="display: block; margin: auto;"></div>
<p>Following code shows how to set spaces between words and lines, and how to set the width
of the text box:</p>
<div class="sourceCode" id="cb297"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">words</span>, line_space <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">5</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-196-1.png" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb298"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">words</span>, text_space <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">5</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-196-2.png" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb299"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">words</span>, max_width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">12</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-196-3.png" width="672" style="display: block; margin: auto;"></div>
<p>Words can be added from the bottom left of the box or from the top left:</p>
<div class="sourceCode" id="cb300"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fontsize</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">5</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>
<span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">words</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">fontsize</span><span class="op">)</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-197-1.png" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb301"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">words</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">fontsize</span><span class="op">)</span>, 
    first_text_from <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-197-2.png" width="672" style="display: block; margin: auto;"></div>
<p>Sentences or phrases are composed of several words, so there are some extra parameters.
If the longest sentence is longer than <code>max_width</code>, the width of the longest sentence will
be the width of the text box. Setting <code>word_wrap = TRUE</code> can adjust the text
according to the width of the text box.</p>
<div class="sourceCode" id="cb302"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sentences</span> <span class="op">=</span> <span class="fu">random_text</span><span class="op">(</span><span class="fl">5</span>, <span class="fl">8</span><span class="op">)</span>
<span class="va">sentences</span></code></pre></div>
<pre><code>## [1] "ihztacybvx gmtnpzdyls"                               
## [2] "ilhgo qkgscf djqphuclne fiatnsebx"                   
## [3] "dkevzsc gewi xque bvrdjoh"                           
## [4] "ekoxjw"                                              
## [5] "lidcgxh exfdckjz kjos jmxcrzh jgyfqta jmzbovhc fnosi"</code></pre>
<div class="sourceCode" id="cb304"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fontsize</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">20</span><span class="op">)</span>
<span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">sentences</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, fontsize <span class="op">=</span> <span class="va">fontsize</span><span class="op">)</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-198-1.png" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb305"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">sentences</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, fontsize <span class="op">=</span> <span class="va">fontsize</span><span class="op">)</span>, 
    word_wrap <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-198-2.png" width="672" style="display: block; margin: auto;"></div>
<p>Also argument <code>add_new_line</code> can be set to <code>TRUE</code> so each sentence will be in a single line.</p>
<div class="sourceCode" id="cb306"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">sentences</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, fontsize <span class="op">=</span> <span class="va">fontsize</span><span class="op">)</span>, 
    add_new_line <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-199-1.png" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb307"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">grid.newpage</span><span class="op">(</span><span class="op">)</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">sentences</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, fontsize <span class="op">=</span> <span class="va">fontsize</span><span class="op">)</span>, 
    add_new_line <span class="op">=</span> <span class="cn">TRUE</span>, word_wrap <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">grid.draw</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-199-2.png" width="672" style="display: block; margin: auto;"></div>
<p>Finally, the width and height of the text box grob can be obtained by <code>grobWidth()</code> and <code>grobHeight()</code>.
Also there is a companion function <code>grid.textbox()</code> that directly draws text box at a certain position.</p>
<div class="sourceCode" id="cb308"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">gb</span> <span class="op">=</span> <span class="fu">textbox_grob</span><span class="op">(</span><span class="va">words</span><span class="op">)</span>
<span class="fu">grobWidth</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span>
<span class="fu">grobHeight</span><span class="op">(</span><span class="va">gb</span><span class="op">)</span>
<span class="fu">grid.textbox</span><span class="op">(</span><span class="va">words</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span></code></pre></div>
</div>
<div id="draw-textbox-annotation" class="section level3" number="3.19.2">
<h3>
<span class="header-section-number">3.19.2</span> Draw textbox annotation<a class="anchor" aria-label="anchor" href="#draw-textbox-annotation"><i class="fas fa-link"></i></a>
</h3>
<p>The function <code>anno_textbox()</code> draws several text boxes and associate them to heatmaps.
Note you don’t need to directly use <code>textbox_grob()</code> function with <code>anno_textbox()</code>,
but there are parameters that control texts in <code>anno_textbox()</code> that are directly passed to <code>textbox_grob()</code>.</p>
<p>Since texts are already wrapped into boxes, the text box annotations are basically
implemented by <code>anno_link()</code> and <code>anno_block()</code>.</p>
<p>By default, the text box annotation is implemented by <code>anno_link()</code>. Since heights
of text boxes are not always the same as the height of subsets of rows they correspond to,
there are connections between the heatmap and text boxes. In the following example,
we generated 10 text boxes and each one is linked to a heatmap slice. In this case,
the first parameter for <code>anno_textbox()</code> is a categorical variable which also split heatmap rows.
The second parameter <code>text</code> is a named list of character vectors where name of the list
should correspond to the levels in <code>split</code>.</p>
<div class="sourceCode" id="cb309"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">text</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">split</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">random_text</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">split</span><span class="op">)</span>

<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>, row_split <span class="op">=</span> <span class="va">split</span>,
    right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>textbox <span class="op">=</span> <span class="fu">anno_textbox</span><span class="op">(</span><span class="va">split</span>, <span class="va">text</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-201-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Or put on the left side of the heatmap:</p>
<div class="sourceCode" id="cb310"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>, row_split <span class="op">=</span> <span class="va">split</span>, row_title <span class="op">=</span> <span class="cn">NULL</span>,
    left_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>textbox <span class="op">=</span> <span class="fu">anno_textbox</span><span class="op">(</span><span class="va">split</span>, <span class="va">text</span>, side <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-202-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Parameters for <code>textbox_grob()</code> can be directly passed in <code>anno_textbox()</code>. E.g.
when the text are sentences, to control word wrap and new lines:</p>
<div class="sourceCode" id="cb311"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">sentences</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">split</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">random_text</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">8</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sentences</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">split</span><span class="op">)</span>

<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span>,
    right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>
        textbox <span class="op">=</span> <span class="fu">anno_textbox</span><span class="op">(</span>
            <span class="va">split</span>, <span class="va">sentences</span>, 
            word_wrap <span class="op">=</span> <span class="cn">TRUE</span>, 
            add_new_line <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-203-1.png" width="672" style="display: block; margin: auto;"></div>
<p>The first argument for <code>anno_textbox()</code> can also be set as a list of indicies. Note
the indices for rows should be continuously adjacent on heatmaps.</p>
<div class="sourceCode" id="cb312"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">align_to</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">split</span><span class="op">)</span>, <span class="va">split</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span>,
    right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>
        textbox <span class="op">=</span> <span class="fu">anno_textbox</span><span class="op">(</span>
            <span class="va">align_to</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">]</span>, 
            <span class="va">sentences</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">]</span>, <span class="co"># names should match</span>
            word_wrap <span class="op">=</span> <span class="cn">TRUE</span>, 
            add_new_line <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-204-1.png" width="672" style="display: block; margin: auto;"></div>
<p><code>anno_textbox()</code> works mainly together with <code>row_split</code> to associate more information
to every heatmap slice. But this is not necessary, as long as you can ensure the indices
are continuously adjacent on heatmaps. In the next example, rows are not clustered,
we add two text boxed to correspond to row 1-10 and row 11-30.</p>
<div class="sourceCode" id="cb313"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>,
    right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>
        textbox <span class="op">=</span> <span class="fu">anno_textbox</span><span class="op">(</span>
            <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"a"</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="st">"b"</span> <span class="op">=</span> <span class="fl">11</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span>, 
            <span class="va">sentences</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">]</span>, 
            word_wrap <span class="op">=</span> <span class="cn">TRUE</span>, 
            add_new_line <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-205-1.png" width="672" style="display: block; margin: auto;"></div>
<p>There are some cases that users want to put the text boxes exactly at the positions
of the corresponding heatmap slices. In this case, the <code>by</code> argument should be
set to <code>"anno_block"</code>. And now <code>anno_block()</code> is internally used to implement text
box annotations.</p>
<div class="sourceCode" id="cb314"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span>
<span class="va">text</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">split</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">random_text</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">split</span><span class="op">)</span>

<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span>,
    right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>
        textbox <span class="op">=</span> <span class="fu">anno_textbox</span><span class="op">(</span><span class="va">split</span>, <span class="va">text</span>, by <span class="op">=</span> <span class="st">"anno_block"</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-206-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Similarly, the first parameter can be set as a list of indicies:</p>
<div class="sourceCode" id="cb315"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">align_to</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">split</span><span class="op">)</span>, <span class="va">split</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span>,
    right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>
        textbox <span class="op">=</span> <span class="fu">anno_textbox</span><span class="op">(</span>
            <span class="va">align_to</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">]</span>, 
            <span class="va">text</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">]</span>, <span class="co"># names should match</span>
            by <span class="op">=</span> <span class="st">"anno_block"</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-207-1.png" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb316"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>,
    right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>
        textbox <span class="op">=</span> <span class="fu">anno_textbox</span><span class="op">(</span>
            <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"a"</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="st">"b"</span> <span class="op">=</span> <span class="fl">50</span><span class="op">:</span><span class="fl">70</span><span class="op">)</span>, 
            <span class="va">text</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">]</span>, 
            by <span class="op">=</span> <span class="st">"anno_block"</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-208-1.png" width="672" style="display: block; margin: auto;"></div>
<p>So far, the texts are assigned with random colors. Now the question is how to
exactly control graphics parameters for texts in the text boxes. In previous examples,
the value of <code>text</code> is a list of character vectors. The graphics parameters can
be integrated into <code>text</code> by setting <code>text</code> as a list of data frames. In each data
frame, the first column contains texts that will be put into boxes. The data frame
can also contains the following four columns (<code>"col"</code>, <code>"fontsize"</code>, <code>"fontfamily"</code>
and <code>"fontface"</code>) to exactly control the corresponding text.</p>
<div class="sourceCode" id="cb317"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="fl">20</span><span class="op">)</span>
<span class="va">text</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">split</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu">random_text</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span>
    <span class="va">df</span><span class="op">$</span><span class="va">fontsize</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">6</span>, <span class="fl">20</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">df</span><span class="op">$</span><span class="va">col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/circlize/man/rand_color.html">rand_color</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        <span class="va">df</span><span class="op">$</span><span class="va">col</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
    <span class="op">}</span>
    <span class="va">df</span>
<span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">split</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">text</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>##         text  fontsize       col
## 1 gixsnwmyjr 16.409436 #E80DF8FF
## 2    klxdszq 14.065497 #E80DF8FF
## 3    nmyaiko 10.148988 #E80DF8FF
## 4  iytaznevh  9.719641 #E80DF8FF
## 5  wbqlhxiof 19.864118 #E80DF8FF
## 6   zaovsbwe 14.295501 #E80DF8FF</code></pre>
<div class="sourceCode" id="cb319"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>, row_split <span class="op">=</span> <span class="va">split</span>,
    right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>textbox <span class="op">=</span> <span class="fu">anno_textbox</span><span class="op">(</span><span class="va">split</span>, <span class="va">text</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-209-1.png" width="672" style="display: block; margin: auto;"></div>
<p>In the <a href="http://www.bioconductor.org/packages/devel/bioc/html/simplifyEnrichment.html"><strong>simplifyEnrichment</strong></a> package,
we use <code>anno_textbox()</code> to implement a word cloud annotation to visualize
summaries of biological functions in each GO cluster.</p>
</div>
</div>
<div id="summary-annotation" class="section level2" number="3.20">
<h2>
<span class="header-section-number">3.20</span> Summary annotation<a class="anchor" aria-label="anchor" href="#summary-annotation"><i class="fas fa-link"></i></a>
</h2>
<p>There is one special annotation <code>anno_summary()</code> which only works with
one-column heatmap or one-row heatmap (we can say the heatmap only contains a
vector). It shows summary statistics for the vector in the heatmap. If the
corresponding vector is discrete, the summary annotation is presented as
barplots and if the vector is continuous, the summary annotation is boxplot.
<code>anno_summary()</code> is always used when the heatmap is split so that statistics
can be compared between heatmap slices.</p>
<p>The first example shows the summary annotation for discrete heatmap. The
barplot shows the proportion of each level in each slice. The absolute values
can already be seen by the height of the heatmap slice.</p>
<p>The color schema for the barplots is automatically extracted from the heatmap.</p>
<div class="sourceCode" id="cb320"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>summary <span class="op">=</span> <span class="fu">anno_summary</span><span class="op">(</span>height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu">Heatmap</span><span class="op">(</span><span class="va">v</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"b"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>,
    top_annotation <span class="op">=</span> <span class="va">ha</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span>, row_split <span class="op">=</span> <span class="va">split</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-210-1.png" width="672" style="display: block; margin: auto;"></div>
<p>The second example shows the summary annotation for continuous heatmap. The
graphic parameters should be manually set by <code>gp</code>. The legend of the boxplot
can be created and added as introduced in Section <a href="legends.html#discrete-legends">5.2</a>,
last second paragraph.</p>
<div class="sourceCode" id="cb321"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>summary <span class="op">=</span> <span class="fu">anno_summary</span><span class="op">(</span>gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, 
    height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">v</span>, name <span class="op">=</span> <span class="st">"mat"</span>, top_annotation <span class="op">=</span> <span class="va">ha</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span>, 
    row_split <span class="op">=</span> <span class="va">split</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-211-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Normally we don’t draw this one-column heatmap along. It is always combined
with other “main heatmaps.” E.g. A gene expression matrix with a one-column
heatmap which shows whether the gene is a protein coding gene or a linc-RNA
gene.</p>
<p>In following, we show a simple example of a “main heatmap” with two one-column
heatmaps. The functionality of heatmap concatenation will be introduced in
Chapter <a href="a-list-of-heatmaps.html#a-list-of-heatmaps">4</a>.</p>
<div class="sourceCode" id="cb322"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">50</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">ht_list</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span>, name <span class="op">=</span> <span class="st">"main_matrix"</span><span class="op">)</span>

<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>summary <span class="op">=</span> <span class="fu">anno_summary</span><span class="op">(</span>height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">3</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">ht_list</span> <span class="op">=</span> <span class="va">ht_list</span> <span class="op">+</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">v</span>, name <span class="op">=</span> <span class="st">"mat1"</span>, top_annotation <span class="op">=</span> <span class="va">ha</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>

<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>summary <span class="op">=</span> <span class="fu">anno_summary</span><span class="op">(</span>gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, 
    height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">3</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span>
<span class="va">ht_list</span> <span class="op">=</span> <span class="va">ht_list</span> <span class="op">+</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">v</span>, name <span class="op">=</span> <span class="st">"mat2"</span>, top_annotation <span class="op">=</span> <span class="va">ha</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>

<span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">lgd_boxplot</span> <span class="op">=</span> <span class="fu">Legend</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"group a"</span>, <span class="st">"group b"</span><span class="op">)</span>, title <span class="op">=</span> <span class="st">"group"</span>,
    legend_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu">draw</span><span class="op">(</span><span class="va">ht_list</span>, row_split <span class="op">=</span> <span class="va">split</span>, ht_gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">5</span>, <span class="st">"mm"</span><span class="op">)</span>, 
    heatmap_legend_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lgd_boxplot</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-212-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
<div id="multiple-annotations" class="section level2" number="3.21">
<h2>
<span class="header-section-number">3.21</span> Multiple annotations<a class="anchor" aria-label="anchor" href="#multiple-annotations"><i class="fas fa-link"></i></a>
</h2>
<div id="heatmap-annotation-general-settings" class="section level3" number="3.21.1">
<h3>
<span class="header-section-number">3.21.1</span> General settings<a class="anchor" aria-label="anchor" href="#heatmap-annotation-general-settings"><i class="fas fa-link"></i></a>
</h3>
<p>As mentioned before, to put multiple annotations in <code>HeatmapAnnotation()</code>,
they just need to be specified as name-value pairs. In <code>HeatmapAnnotation()</code>,
there are some arguments which controls multiple annotations. For these
arguments, they are specified as a vector which has same length as number of
the annotations, or a named vector with subset of the annotations.</p>
<p>The simple annotations which are specified as vectors, matrices and data
frames will automatically have legends on the heatmap. <code>show_legend</code> controls
whether to draw the legends for them. Note here if <code>show_legend</code> is a vector,
the value of <code>show_legend</code> should be in one of the following formats:</p>
<ul>
<li>A logical vector with the same length as the number of simple annotations.</li>
<li>A logical vector with the same length as the number of totla annotations. The
values for complex annotations are ignored.</li>
<li>A named vector to control subset of the simple annotations.</li>
</ul>
<p>For customization on the annotation legends, please refer to Section <a href="legends.html#heatmap-and-annotation-legends">5.4</a>.</p>
<div class="sourceCode" id="cb323"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    show_legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bar"</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>, top_annotation <span class="op">=</span> <span class="va">ha</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-213-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p><code>gp</code> controls graphic parameters (except <code>fill</code>) for the simple annotatios,
such as the border of annotation grids.</p>
<div class="sourceCode" id="cb324"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-215-1.png" width="576" style="display: block; margin: auto;"></div>
<p><code>border</code> controls the border of every single annotations.
<code>show_annotation_name</code> controls whether show annotation names. As mentioned,
the value can be a single value, a vector or a named vector.</p>
<div class="sourceCode" id="cb325"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    show_annotation_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="co"># only turn off `bar`</span>
    border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># turn on foo</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-217-1.png" width="576" style="display: block; margin: auto;"></div>
<p><code>annotation_name_gp</code>, <code>annotation_name_offset</code>, <code>annotation_name_side</code> and
<code>annotation_name_rot</code> control the style and position of the annotation names.
The latter three can be specified as named vectors. If
<code>annotation_name_offset</code> is specified as a named vector, it can be specified
as characters while not <code>unit</code> objects: <code>annotation_name_offset = c(foo = "1cm")</code>.</p>
<p><code>gap</code> controls the space between every two neighbouring annotations. The value
can be a single unit or a vector of units.</p>
<div class="sourceCode" id="cb326"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-219-1.png" width="576" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb327"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-221-1.png" width="576" style="display: block; margin: auto;"></div>
</div>
<div id="size-of-annotations" class="section level3" number="3.21.2">
<h3>
<span class="header-section-number">3.21.2</span> Size of annotations<a class="anchor" aria-label="anchor" href="#size-of-annotations"><i class="fas fa-link"></i></a>
</h3>
<p><code>height</code>, <code>width</code>, <code>annotation_height</code> and <code>annotation_width</code> control the
height or width of the complete heatmap annotations. Normally you don’t need
to set them because all the single annotations have fixed height/width and the
final height/width for the whole heatmap annotation is the sum of them.
Resizing these values will involve rather complicated adjustment depending on
whether it is a simple annotation or complex annotation. The resizing of
heatmap annotations will also happen when adjusting a list of heatmaps. In
following examples, we take column annotations as examples and demonstrate
some scenarios for the resizing adjustment.</p>
<p>First the default height of <code>ha</code>:</p>
<div class="sourceCode" id="cb328"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># foo: 1cm, bar: 5mm, pt: 1cm</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, 
    bar <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-223-1.png" width="576" style="display: block; margin: auto;"></div>
<p>If <code>height</code> is set, the size of the simple annotation will not change, while
only the complex annotations are adjusted. If there are multiple complex
annotations, they are adjusted according to the ratio of their original size.</p>
<div class="sourceCode" id="cb329"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># foo: 1cm, bar: 5mm, pt: 4.5cm</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, 
    bar <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">6</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-225-1.png" width="576" style="display: block; margin: auto;"></div>
<p><code>simple_anno_size</code> controls the height of all simple annotations. Recall
<code>ht_opt$simple_anno_size</code> can be set to globally control the size of simple
annotations in all heatmaps.</p>
<div class="sourceCode" id="cb330"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># foo: 2cm, bar:1cm, pt: 3cm</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, 
    bar <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    simple_anno_size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">6</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-227-1.png" width="576" style="display: block; margin: auto;"></div>
<p>If <code>annotation_height</code> is set as a vector of absolute units, the height of all
three annotations are adjusted accordingly.</p>
<div class="sourceCode" id="cb331"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># foo: 1cm, bar: 2cm, pt: 3cm</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, 
    bar <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    annotation_height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-229-1.png" width="576" style="display: block; margin: auto;"></div>
<p>If <code>annotation_height</code> is set as pure numbers which is treated as relative
ratios for annotations, <code>height</code> should also be set as an absolute unit and
the size of every single annotation is adjusted by the ratios.</p>
<div class="sourceCode" id="cb332"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># foo: 1cm, bar: 2cm, pt: 3cm</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, 
    bar <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    annotation_height <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">6</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-230-1.png" width="576" style="display: block; margin: auto;"></div>
<p><code>annotation_height</code> can be mixed with relative units (in <code>null</code> unit) and
absolute units.</p>
<div class="sourceCode" id="cb333"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># foo: 1.5cm, bar: 1.5cm, pt: 3cm</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, 
    bar <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    annotation_height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"null"</span>, <span class="st">"null"</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">6</span>, <span class="st">"cm"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-232-1.png" width="576" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb334"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># foo: 2cm, bar: 1cm, pt: 3cm</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, 
    bar <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    annotation_height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cm"</span>, <span class="st">"null"</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">6</span>, <span class="st">"cm"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-234-1.png" width="576" style="display: block; margin: auto;"></div>
<p>If there are only simple annotations, simply setting <code>height</code> won’t change the
height.</p>
<div class="sourceCode" id="cb335"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># foo: 1cm, bar: 5mm</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, 
    bar <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,
    height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">6</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-236-1.png" width="576" style="display: block; margin: auto;"></div>
<p>unless <code>simple_anno_size_adjust</code> is set to <code>TRUE</code>.</p>
<div class="sourceCode" id="cb336"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># foo: 4cm, bar: 2cm</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, 
    bar <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,
    height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">6</span>, <span class="st">"cm"</span><span class="op">)</span>,
    simple_anno_size_adjust <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-238-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Section <a href="a-list-of-heatmaps.html#annotations-as-components-are-adjusted">4.6</a> introduces how the
annotation sizes are adjusted among a list of heatmaps.</p>
</div>
<div id="annotation-labels" class="section level3" number="3.21.3">
<h3>
<span class="header-section-number">3.21.3</span> Annotation labels<a class="anchor" aria-label="anchor" href="#annotation-labels"><i class="fas fa-link"></i></a>
</h3>
<p>From version 2.3.3, alternative labels for annotations can be set by <code>annotation_label</code> argument:</p>
<div class="sourceCode" id="cb337"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    annotation_label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Annotation_foo"</span>, <span class="st">"Annotation_bar"</span>, <span class="st">"Annotation_pt"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-240-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Annotation labels can also be set with complex text:</p>
<div class="sourceCode" id="cb338"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    annotation_label <span class="op">=</span> <span class="fu">gt_render</span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"**Anno**_&lt;span style='color:red'&gt;foo&lt;/span&gt;"</span>, 
          <span class="st">"**Anno**_&lt;span style='color:blue'&gt;bar&lt;/span&gt;"</span>, 
          <span class="st">"**Anno**_&lt;span style='color:green'&gt;pt&lt;/span&gt;"</span><span class="op">)</span>,
        gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>box_fill <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>, top_annotation <span class="op">=</span> <span class="va">ha</span><span class="op">)</span></code></pre></div>
<div class="inline-figure">
<img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-241-1.png" width="499.2" style="display: block; margin: auto;">
From version 2.5.6, rotations of annotation names can be configured.</div>
<div class="sourceCode" id="cb339"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    annotation_name_rot <span class="op">=</span> <span class="fl">45</span>
<span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>, top_annotation <span class="op">=</span> <span class="va">ha</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-242-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Or on the rows:</p>
<div class="sourceCode" id="cb340"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
    annotation_name_rot <span class="op">=</span> <span class="fl">45</span>
<span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>, left_annotation <span class="op">=</span> <span class="va">ha</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-243-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
</div>
<div id="heatmap-annotation-utility-function" class="section level2" number="3.22">
<h2>
<span class="header-section-number">3.22</span> Utility functions<a class="anchor" aria-label="anchor" href="#heatmap-annotation-utility-function"><i class="fas fa-link"></i></a>
</h2>
<p>There are some utility functions which make the manipulation of heatmap
annotation easier. Just see following examples.</p>
<div class="sourceCode" id="cb341"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ha</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 3</code></pre>
<div class="sourceCode" id="cb343"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/nobs.html">nobs</a></span><span class="op">(</span><span class="va">ha</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 10</code></pre>
<p>Get or set the names of the annotations:</p>
<div class="sourceCode" id="cb345"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ha</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "foo" "bar" "pt"</code></pre>
<div class="sourceCode" id="cb347"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ha</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FOO"</span>, <span class="st">"BAR"</span>, <span class="st">"PT"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ha</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "FOO" "BAR" "PT"</code></pre>
<p>You can concatenate two <code>HeatmapAnnotation</code> objects if they contain same
number of observations and different annotation names.</p>
<div class="sourceCode" id="cb349"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha1</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, 
    bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
    pt <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="va">ha2</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>FOO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, 
    BAR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    PT <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ha1</span>, <span class="va">ha2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ha</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "foo" "bar" "pt"  "FOO" "BAR" "PT"</code></pre>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-247-1.png" width="576" style="display: block; margin: auto;"></div>
<p><code>HeatmapAnnotation</code> object sometimes is subsettable. The row index corresponds
to observations in the annotation and column index corresponds to the
annotations. If the annotations are all simple annotations or the complex
annotation created by <code>anno_*()</code> functions in <strong>ComplexHeatmap</strong> package, the
<code>HeatmapAnnotation</code> object is always subsettable.</p>
<div class="sourceCode" id="cb351"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ha_subset</span> <span class="op">=</span> <span class="va">ha</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"foo"</span>, <span class="st">"PT"</span><span class="op">)</span><span class="op">]</span>
<span class="va">ha_subset</span></code></pre></div>
<pre><code>## A HeatmapAnnotation object with 2 annotations
##   name: heatmap_annotation_136 
##   position: column 
##   items: 5 
##   width: 1npc 
##   height: 15.3514598035146mm 
##   this object is subsettable
##   5.21733333333333mm extension on the left 
##   6.75733333333333mm extension on the right 
## 
##  name   annotation_type color_mapping height
##   foo continuous vector        random    5mm
##    PT     anno_points()                 10mm</code></pre>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-249-1.png" width="576" style="display: block; margin: auto;"></div>
<p>The construction of heatmaps and annotations can be separated, later the annotations
can be filled into the heatmap objects by the <code>attach_annotation()</code> function.</p>
<div class="sourceCode" id="cb353"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">ha1</span> <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>
<span class="va">ha2</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>bar <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">attach_annotation</span><span class="op">(</span><span class="va">ht</span>, <span class="va">ha1</span>, side <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">attach_annotation</span><span class="op">(</span><span class="va">ht</span>, <span class="va">ha2</span>, side <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span></code></pre></div>
</div>
<div id="implement-new-annotation-functions" class="section level2" number="3.23">
<h2>
<span class="header-section-number">3.23</span> Implement new annotation functions<a class="anchor" aria-label="anchor" href="#implement-new-annotation-functions"><i class="fas fa-link"></i></a>
</h2>
<p>All the annotation functions defined in <strong>ComplexHeatmap</strong> are constructed by
the <code>AnnotationFunction</code> class. The <code>AnnotationFunction</code> class not only stores
the “real R function” which draws the graphics, it also calculates the spaces
produced by the annotation axis. More importantly, it allows splitting the
annotation graphics according to the split of the main heatmap.</p>
<p>As expected, the main part of the <code>AnnotationFunction</code> class is a function
which defines how to draw at specific positions which correspond to rows or
columns in the heatmap. The function should have three arguments: <code>index</code>, <code>k</code>
and <code>n</code> (the names of the arguments can be arbitrary) where <code>k</code> and <code>n</code> are
optional. <code>index</code> corresponds to the indices of rows or columns of the
heatmap. The value of <code>index</code> is not necessarily to be the whole row indices
or column indices in the heatmap. It can also be a subset of the indices if
the annotation is split into slices according to the split of the heatmap.
<code>index</code> is reordered according to the reordering of heatmap rows or columns
(e.g. by clustering). So, <code>index</code> actually contains a list of row or column
indices for the current slice after row or column reordering.</p>
<p>As mentioned, annotation can be split into slices. <code>k</code> corresponds to the
current slice and <code>n</code> corresponds to the total number of slices. The
annotation function draws in every slice repeatedly. The information of <code>k</code>
and <code>n</code> sometimes can be useful, for example, we want to add axis in the
annotation, and if it is a column annotation and axis is drawn on the very
right of the annotation area, the axis is only drawn when <code>k == n</code>.</p>
<p>Since the function only allows <code>index</code>, <code>k</code> and <code>n</code>, the function sometimes
uses several external variables which can not be defined inside the function,
e.g. the data points for the annotation. These variables should be imported
into the <code>AnnotationFunction</code> class by <code>var_import</code> so that the function can
correctly find these variables.</p>
<p>One important feature for <code>AnnotationFunction</code> class is it can be subsettable,
which is the base for splitting. To allow subsetting on the object, users need
to define the rule for the imported variables if there is any. The rules are
simple functions which accpet the variable and indices, and return the subset
of the variable. The subset rule functions implemented in this package are
<code>subset_gp()</code>, <code>subset_matrix_by_row()</code> and <code>subset_vector()</code>. If the
subsetting rule is not provided, it is inferred by the type of the object.</p>
<p>In the following example, we first construct an <code>AnnotationFunction</code> object which needs external
variable and supports subsetting. This annotation contains a list of “lolipops” (points plus vertical segments) which
is drawn in a viewport. Y-axis is drawn in the first slices.</p>
<p>The variable <code>x</code> is from outside of the function, so it should be added to <code>var_import</code>.</p>
<div class="sourceCode" id="cb354"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
<span class="va">anno1</span> <span class="op">=</span> <span class="fu">AnnotationFunction</span><span class="op">(</span>
    fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span>, <span class="va">k</span>, <span class="va">n</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span>
        <span class="fu">pushViewport</span><span class="op">(</span><span class="fu">viewport</span><span class="op">(</span>xscale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">n</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span>, yscale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
        <span class="fu">grid.rect</span><span class="op">(</span><span class="op">)</span>
        <span class="fu">grid.points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">x</span><span class="op">[</span><span class="va">index</span><span class="op">]</span>, default.units <span class="op">=</span> <span class="st">"native"</span><span class="op">)</span>
        <span class="fu">grid.segments</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">x</span><span class="op">[</span><span class="va">index</span><span class="op">]</span>, default.units <span class="op">=</span> <span class="st">"native"</span><span class="op">)</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">k</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="fu">grid.yaxis</span><span class="op">(</span><span class="op">)</span>
        <span class="fu">popViewport</span><span class="op">(</span><span class="op">)</span>
    <span class="op">}</span>,
    var_import <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span><span class="op">)</span>,
    n <span class="op">=</span> <span class="fl">10</span>,
    subsettable <span class="op">=</span> <span class="cn">TRUE</span>,
    height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">anno1</span></code></pre></div>
<pre><code>## An AnnotationFunction object
##   function: user-defined
##   position: column 
##   items: 10 
##   width: 1npc 
##   height: 2cm 
##   imported variable: x 
##   this object is subsettable</code></pre>
<p>Then we can assign <code>anno1</code> in <code>HeatmapAnnotation()</code> function. Since <code>anno1</code> is
subsettable, you can split columns of the heatmap.</p>
<div class="sourceCode" id="cb356"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">11</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span>, top_annotation <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="va">anno1</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span>, top_annotation <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="va">anno1</span><span class="op">)</span>, 
    column_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-253-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The second way is to put all data variables inside the function and no need to
import other variables.</p>
<div class="sourceCode" id="cb357"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">anno2</span> <span class="op">=</span> <span class="fu">AnnotationFunction</span><span class="op">(</span>
    fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">x</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
        <span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span>
        <span class="fu">pushViewport</span><span class="op">(</span><span class="fu">viewport</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
        <span class="fu">grid.points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">x</span><span class="op">[</span><span class="va">index</span><span class="op">]</span><span class="op">)</span>
        <span class="fu">popViewport</span><span class="op">(</span><span class="op">)</span>
    <span class="op">}</span>,
    n <span class="op">=</span> <span class="fl">10</span>,
    subsettable <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
<p>The most compact way to only specify the function to the constructor. This allows
reordering, but it does not work when you split heatmap.</p>
<div class="sourceCode" id="cb358"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">anno3</span> <span class="op">=</span> <span class="fu">AnnotationFunction</span><span class="op">(</span>
    fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">x</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
        <span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span>
        <span class="fu">pushViewport</span><span class="op">(</span><span class="fu">viewport</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
        <span class="fu">grid.points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">x</span><span class="op">[</span><span class="va">index</span><span class="op">]</span><span class="op">)</span>
        <span class="fu">popViewport</span><span class="op">(</span><span class="op">)</span>
    <span class="op">}</span>
<span class="op">)</span></code></pre></div>
<p>All the <code>anno_*()</code> functions introduced in this section actually are not
really annotation functions, while they are functions generating annotation
functions with specific configurations.</p>
<div class="sourceCode" id="cb359"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">anno_points</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code>## An AnnotationFunction object
##   function: anno_points()
##   position: column 
##   items: 10 
##   width: 1npc 
##   height: 1cm 
##   imported variable: data_scale, axis_param, border, size, value, pch_as_image, axis, gp, axis_grob, pch 
##   subsettable variable: gp, value, size, pch 
##   this object is subsettable
##   5.13831111111111mm extension on the left</code></pre>
<p>In most cases, you don’t need to manually construct your <code>AnnotationFunction</code>
objects. The annotation function <code>anno_*()</code> implemented in <strong>ComplexHeatmap</strong>
are already enough for most of the analysis tasks. On the other hand, users
can also use <code>anno_empty()</code> and <code>decorate_annotation()</code> to quickly add
self-defined annotation graphics. E.g. we can re-implement previous heatmap
as (of course it is lengthy):</p>
<div class="sourceCode" id="cb361"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span>, name <span class="op">=</span> <span class="st">"mat"</span>,
    top_annotation <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_empty</span><span class="op">(</span>height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
    column_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">draw</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span>
<span class="va">co</span> <span class="op">=</span> <span class="fu">column_order</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span>
<span class="fu">decorate_annotation</span><span class="op">(</span><span class="st">"foo"</span>, slice <span class="op">=</span> <span class="fl">1</span>, <span class="op">{</span>
    <span class="va">od</span> <span class="op">=</span> <span class="va">co</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
    <span class="fu">pushViewport</span><span class="op">(</span><span class="fu">viewport</span><span class="op">(</span>xscale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span>, yscale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">grid.points</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span>, <span class="va">x</span><span class="op">[</span><span class="va">od</span><span class="op">]</span><span class="op">)</span>
    <span class="fu">grid.segments</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span>, <span class="va">x</span><span class="op">[</span><span class="va">od</span><span class="op">]</span>, default.units <span class="op">=</span> <span class="st">"native"</span><span class="op">)</span>
    <span class="fu">grid.yaxis</span><span class="op">(</span><span class="op">)</span>
    <span class="fu">popViewport</span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="fu">decorate_annotation</span><span class="op">(</span><span class="st">"foo"</span>, slice <span class="op">=</span> <span class="fl">2</span>, <span class="op">{</span>
    <span class="va">od</span> <span class="op">=</span> <span class="va">co</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
    <span class="fu">pushViewport</span><span class="op">(</span><span class="fu">viewport</span><span class="op">(</span>xscale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span>, yscale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">grid.points</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span>, <span class="va">x</span><span class="op">[</span><span class="va">od</span><span class="op">]</span><span class="op">)</span>
    <span class="fu">grid.segments</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span>, <span class="va">x</span><span class="op">[</span><span class="va">od</span><span class="op">]</span>, default.units <span class="op">=</span> <span class="st">"native"</span><span class="op">)</span>
    <span class="fu">popViewport</span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-257-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div id="construct-annotation-function-by-cell_fun" class="section level3" number="3.23.1">
<h3>
<span class="header-section-number">3.23.1</span> Construct annotation function by <code>cell_fun</code><a class="anchor" aria-label="anchor" href="#construct-annotation-function-by-cell_fun"><i class="fas fa-link"></i></a>
</h3>
<p>To simplify the use of <code>AnnotationFunction()</code>, from version 2.9.3, it has a new argument <code>cell_fun</code> which accepts
a self-defined function that only draws in a single “annotation cell.”
This would be convenient for annotation only with a few cells.
See the following example which visualizes percent values by text and bars.
Actually this is how <code>anno_numeric()</code> (Section <a href="heatmap-annotations.html#anno-numeric">3.15</a>) is implemented.</p>
<div class="sourceCode" id="cb362"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">anno_pct</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>

    <span class="va">max_x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
    <span class="va">text</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.2f"</span>, <span class="va">x</span><span class="op">*</span><span class="fl">100</span><span class="op">)</span>, <span class="st">"%"</span><span class="op">)</span>
    <span class="va">cell_fun_pct</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu">pushViewport</span><span class="op">(</span><span class="fu">viewport</span><span class="op">(</span>xscale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">max_x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
        <span class="fu">grid.roundrect</span><span class="op">(</span>x <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"native"</span><span class="op">)</span>, 
            height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span> <span class="op">-</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"pt"</span><span class="op">)</span>, 
            just <span class="op">=</span> <span class="st">"right"</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#0000FF80"</span>, col <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>
        <span class="fu">grid.text</span><span class="op">(</span><span class="va">text</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, x <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, just <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>
        <span class="fu">popViewport</span><span class="op">(</span><span class="op">)</span>
    <span class="op">}</span>

    <span class="fu">AnnotationFunction</span><span class="op">(</span>
        cell_fun <span class="op">=</span> <span class="va">cell_fun_pct</span>,
        var_import <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">max_x</span>, <span class="va">x</span>, <span class="va">text</span><span class="op">)</span>, 
        which <span class="op">=</span> <span class="st">"row"</span>,
        width <span class="op">=</span> <span class="fu">max_text_width</span><span class="op">(</span><span class="va">text</span><span class="op">)</span><span class="op">*</span><span class="fl">1.25</span>
    <span class="op">)</span>
<span class="op">}</span>

<span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo <span class="op">=</span> <span class="fu">anno_pct</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, annotation_name_rot <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>

<span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">=</span> <span class="va">x</span>
<span class="va">ha</span> <span class="op">+</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">m</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="03-heatmap_annotations_files/figure-html/unnamed-chunk-258-1.png" width="480" style="display: block; margin: auto;"></div>
<p>Note if <code>cell_fun</code> is set in <code>AnnotationFunction</code>, the returned annotation function
is subsettable, which means it also works when heatmap is split.</p>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="a-single-heatmap.html"><span class="header-section-number">2</span> A Single Heatmap</a></div>
<div class="next"><a href="a-list-of-heatmaps.html"><span class="header-section-number">4</span> A List of Heatmaps</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#heatmap-annotations"><span class="header-section-number">3</span> Heatmap Annotations</a></li>
<li><a class="nav-link" href="#simple-annotation"><span class="header-section-number">3.1</span> Simple annotation</a></li>
<li><a class="nav-link" href="#simple-annotation-as-an-annotation-function"><span class="header-section-number">3.2</span> Simple annotation as an annotation function</a></li>
<li><a class="nav-link" href="#empty-annotation"><span class="header-section-number">3.3</span> Empty annotation</a></li>
<li>
<a class="nav-link" href="#block-annotation"><span class="header-section-number">3.4</span> Block annotation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#block-for-putting-labels"><span class="header-section-number">3.4.1</span> Block for putting labels</a></li>
<li><a class="nav-link" href="#blocks-as-plotting-regions"><span class="header-section-number">3.4.2</span> Blocks as plotting regions</a></li>
</ul>
</li>
<li><a class="nav-link" href="#image-annotation"><span class="header-section-number">3.5</span> Image annotation</a></li>
<li><a class="nav-link" href="#points-annotation"><span class="header-section-number">3.6</span> Points annotation</a></li>
<li><a class="nav-link" href="#lines-annotation"><span class="header-section-number">3.7</span> Line annotation</a></li>
<li><a class="nav-link" href="#barplot_annotation"><span class="header-section-number">3.8</span> Barplot annotation</a></li>
<li><a class="nav-link" href="#box-annotation"><span class="header-section-number">3.9</span> Boxplot annotation</a></li>
<li><a class="nav-link" href="#histogram-annotation"><span class="header-section-number">3.10</span> Histogram annotation</a></li>
<li><a class="nav-link" href="#density-annotation"><span class="header-section-number">3.11</span> Density annotation</a></li>
<li><a class="nav-link" href="#joyplot-annotation"><span class="header-section-number">3.12</span> Joyplot annotation</a></li>
<li><a class="nav-link" href="#horizon-chart-annotation"><span class="header-section-number">3.13</span> Horizon chart annotation</a></li>
<li><a class="nav-link" href="#text-annotation"><span class="header-section-number">3.14</span> Text annotation</a></li>
<li><a class="nav-link" href="#anno-numeric"><span class="header-section-number">3.15</span> Numeric labels annotation</a></li>
<li><a class="nav-link" href="#completely-customized-annotation"><span class="header-section-number">3.16</span> Completely customized annotation</a></li>
<li><a class="nav-link" href="#mark-annotation"><span class="header-section-number">3.17</span> Mark annotation</a></li>
<li><a class="nav-link" href="#zoom-annotation"><span class="header-section-number">3.18</span> Zoom/link annotation</a></li>
<li>
<a class="nav-link" href="#anno-text-box"><span class="header-section-number">3.19</span> Text box annotation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#construct-the-text-box"><span class="header-section-number">3.19.1</span> Construct the text box</a></li>
<li><a class="nav-link" href="#draw-textbox-annotation"><span class="header-section-number">3.19.2</span> Draw textbox annotation</a></li>
</ul>
</li>
<li><a class="nav-link" href="#summary-annotation"><span class="header-section-number">3.20</span> Summary annotation</a></li>
<li>
<a class="nav-link" href="#multiple-annotations"><span class="header-section-number">3.21</span> Multiple annotations</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#heatmap-annotation-general-settings"><span class="header-section-number">3.21.1</span> General settings</a></li>
<li><a class="nav-link" href="#size-of-annotations"><span class="header-section-number">3.21.2</span> Size of annotations</a></li>
<li><a class="nav-link" href="#annotation-labels"><span class="header-section-number">3.21.3</span> Annotation labels</a></li>
</ul>
</li>
<li><a class="nav-link" href="#heatmap-annotation-utility-function"><span class="header-section-number">3.22</span> Utility functions</a></li>
<li>
<a class="nav-link" href="#implement-new-annotation-functions"><span class="header-section-number">3.23</span> Implement new annotation functions</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#construct-annotation-function-by-cell_fun"><span class="header-section-number">3.23.1</span> Construct annotation function by cell_fun</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/jokergoo/ComplexHeatmap/blob/master/03-heatmap_annotations.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/jokergoo/ComplexHeatmap/edit/master/03-heatmap_annotations.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>ComplexHeatmap Complete Reference</strong>" was written by Zuguang Gu. It was last built on last revised on 2022-07-31.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
