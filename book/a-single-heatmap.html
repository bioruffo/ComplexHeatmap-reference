<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 2 A Single Heatmap | ComplexHeatmap Complete Reference</title>
<meta name="author" content="Zuguang Gu">
<meta name="description" content="A single heatmap is the most used approach for visualizing data. Although “the shining point” of the ComplexHeatmap package is that it can visualize a list of heatmaps in parallel, however, as the...">
<meta name="generator" content="bookdown 0.27 with bs4_book()">
<meta property="og:title" content="Chapter 2 A Single Heatmap | ComplexHeatmap Complete Reference">
<meta property="og:type" content="book">
<meta property="og:url" content="https://jokergoo.github.io/ComplexHeatmap-reference/book/a-single-heatmap.html">
<meta property="og:image" content="https://jokergoo.github.io/ComplexHeatmap-reference/book/complexheatmap-cover.jpg">
<meta property="og:description" content="A single heatmap is the most used approach for visualizing data. Although “the shining point” of the ComplexHeatmap package is that it can visualize a list of heatmaps in parallel, however, as the...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 2 A Single Heatmap | ComplexHeatmap Complete Reference">
<meta name="twitter:description" content="A single heatmap is the most used approach for visualizing data. Although “the shining point” of the ComplexHeatmap package is that it can visualize a list of heatmaps in parallel, however, as the...">
<meta name="twitter:image" content="https://jokergoo.github.io/ComplexHeatmap-reference/book/complexheatmap-cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><style>
    #content {
    	font-size: 0.95rem;
    }
    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">ComplexHeatmap Complete Reference</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="active" href="a-single-heatmap.html"><span class="header-section-number">2</span> A Single Heatmap</a></li>
<li><a class="" href="heatmap-annotations.html"><span class="header-section-number">3</span> Heatmap Annotations</a></li>
<li><a class="" href="a-list-of-heatmaps.html"><span class="header-section-number">4</span> A List of Heatmaps</a></li>
<li><a class="" href="legends.html"><span class="header-section-number">5</span> Legends</a></li>
<li><a class="" href="heatmap-decoration.html"><span class="header-section-number">6</span> Heatmap Decoration</a></li>
<li><a class="" href="oncoprint.html"><span class="header-section-number">7</span> OncoPrint</a></li>
<li><a class="" href="upset-plot.html"><span class="header-section-number">8</span> UpSet plot</a></li>
<li><a class="" href="interactive.html"><span class="header-section-number">9</span> Interactive ComplexHeatmap</a></li>
<li><a class="" href="integrate-with-other-packages.html"><span class="header-section-number">10</span> Integrate with other packages</a></li>
<li><a class="" href="other-high-level-plots.html"><span class="header-section-number">11</span> Other High-level Plots</a></li>
<li><a class="" href="three-d-heatmap.html"><span class="header-section-number">12</span> Three-dimensional ComplexHeatmap</a></li>
<li><a class="" href="genome-level-heatmap.html"><span class="header-section-number">13</span> Genome-level heatmap</a></li>
<li><a class="" href="more-examples.html"><span class="header-section-number">14</span> More Examples</a></li>
<li><a class="" href="other-tricks.html"><span class="header-section-number">15</span> Other Tricks</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/jokergoo/ComplexHeatmap">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="a-single-heatmap" class="section level1" number="2">
<h1>
<span class="header-section-number">2</span> A Single Heatmap<a class="anchor" aria-label="anchor" href="#a-single-heatmap"><i class="fas fa-link"></i></a>
</h1>
<p>A single heatmap is the most used approach for visualizing data. Although
“the shining point” of the <strong>ComplexHeatmap</strong> package is that it can visualize a
list of heatmaps in parallel, however, as the basic unit of the heatmap list, it is
still very important to have the single heatmap well configured.</p>
<p>First let’s generate a random matrix where there are three groups in the columns
and three groups in the rows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">nr1</span> <span class="op">=</span> <span class="fl">4</span>; <span class="va">nr2</span> <span class="op">=</span> <span class="fl">8</span>; <span class="va">nr3</span> <span class="op">=</span> <span class="fl">6</span>; <span class="va">nr</span> <span class="op">=</span> <span class="va">nr1</span> <span class="op">+</span> <span class="va">nr2</span> <span class="op">+</span> <span class="va">nr3</span>
<span class="va">nc1</span> <span class="op">=</span> <span class="fl">6</span>; <span class="va">nc2</span> <span class="op">=</span> <span class="fl">8</span>; <span class="va">nc3</span> <span class="op">=</span> <span class="fl">10</span>; <span class="va">nc</span> <span class="op">=</span> <span class="va">nc1</span> <span class="op">+</span> <span class="va">nc2</span> <span class="op">+</span> <span class="va">nc3</span>
<span class="va">mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nr1</span><span class="op">*</span><span class="va">nc1</span>, mean <span class="op">=</span> <span class="fl">1</span>,   sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, nr <span class="op">=</span> <span class="va">nr1</span><span class="op">)</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nr2</span><span class="op">*</span><span class="va">nc1</span>, mean <span class="op">=</span> <span class="fl">0</span>,   sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, nr <span class="op">=</span> <span class="va">nr2</span><span class="op">)</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nr3</span><span class="op">*</span><span class="va">nc1</span>, mean <span class="op">=</span> <span class="fl">0</span>,   sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, nr <span class="op">=</span> <span class="va">nr3</span><span class="op">)</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nr1</span><span class="op">*</span><span class="va">nc2</span>, mean <span class="op">=</span> <span class="fl">0</span>,   sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, nr <span class="op">=</span> <span class="va">nr1</span><span class="op">)</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nr2</span><span class="op">*</span><span class="va">nc2</span>, mean <span class="op">=</span> <span class="fl">1</span>,   sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, nr <span class="op">=</span> <span class="va">nr2</span><span class="op">)</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nr3</span><span class="op">*</span><span class="va">nc2</span>, mean <span class="op">=</span> <span class="fl">0</span>,   sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, nr <span class="op">=</span> <span class="va">nr3</span><span class="op">)</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nr1</span><span class="op">*</span><span class="va">nc3</span>, mean <span class="op">=</span> <span class="fl">0.5</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, nr <span class="op">=</span> <span class="va">nr1</span><span class="op">)</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nr2</span><span class="op">*</span><span class="va">nc3</span>, mean <span class="op">=</span> <span class="fl">0.5</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, nr <span class="op">=</span> <span class="va">nr2</span><span class="op">)</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nr3</span><span class="op">*</span><span class="va">nc3</span>, mean <span class="op">=</span> <span class="fl">1</span>,   sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, nr <span class="op">=</span> <span class="va">nr3</span><span class="op">)</span><span class="op">)</span>
   <span class="op">)</span>
<span class="va">mat</span> <span class="op">=</span> <span class="va">mat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">nr</span>, <span class="va">nr</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">nc</span>, <span class="va">nc</span><span class="op">)</span><span class="op">]</span> <span class="co"># random shuffle rows and columns</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"row"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">nr</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Following command contains the minimal argument for the <code>Heatmap()</code> function
which visualizes the matrix as a heatmap with default settings. Very
similar as other heatmap tools, it draws the dendrograms, the row/column names
and the heatmap legend. The default color schema is “blue-white-red” which is
mapped to the minimal-mean-maximal values in the matrix. The title for the
legend is assigned with an internal index number.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/default-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The title for the legend is taken from the “name” of the heatmap by default.
Each heatmap has a name which is like a unique identifier for the heatmap and
it is important when you have a list of heatmaps. In later chapters, you will
find the heatmap name is used for setting the “main heatmap” and is used for
decoration on heatmaps. If the name is not assigned, an internal name is
assigned to the heatmap in a form of <code>matrix_%d</code>. In the following examples in
this chapter, we give the name <code>mat</code> to the heatmap (for which you will see
the change of legend title in the next plot).</p>
<p>If you put <code>Heatmap()</code> inside a function or a <code>for</code>/<code>if</code>/<code>while</code> chunk, or the R script is run under command-line, you
won’t see the heatmap after executing <code>Heatmap()</code>. In this case, you need to
use <code>draw()</code> function explicitly as follows. We will explain this point in
more detail in Section <a href="a-single-heatmap.html#plot-the-heatmap">2.11</a>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="a-single-heatmap.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(...) {</span>
<span id="cb6-2"><a href="a-single-heatmap.html#cb6-2" aria-hidden="true" tabindex="-1"></a>    ht <span class="ot">=</span> <span class="fu">Heatmap</span>(mat)</span>
<span id="cb6-3"><a href="a-single-heatmap.html#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">draw</span>(ht)</span>
<span id="cb6-4"><a href="a-single-heatmap.html#cb6-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div id="colors" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Colors<a class="anchor" aria-label="anchor" href="#colors"><i class="fas fa-link"></i></a>
</h2>
<p>For heatmap visualization, colors are the major representation of the data
matrix. In most cases, the heatmap visualizes a matrix with continuous numeric
values. In this case, users should provide a color mapping function. A color
mapping function should accept a vector of values and return a vector of
corresponding colors. <strong>Users should always use <code><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">circlize::colorRamp2()</a></code>
function to generate the color mapping function</strong> in <code>Heatmap()</code>. The
two arguments for <code><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2()</a></code> is a vector of break values and a vector of
corresponding colors. <code><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2()</a></code> linearly interpolates colors in every
interval through LAB color space. Also using <code><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2()</a></code> helps to generate
a legend with proper tick marks.</p>
<p>In following example, values between -2 and 2 are linearly interpolated to get
corresponding colors, values larger than 2 are all mapped to red and values
less than -2 are all mapped to green.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/circlize">circlize</a></span><span class="op">)</span>
<span class="va">col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">col_fun</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "#00FF00FF" "#00FF00FF" "#B1FF9AFF" "#FFFFFFFF" "#FF9E81FF" "#FF0000FF"
## [7] "#FF0000FF"</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-2-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>As you can see, the color mapping function exactly maps negative values to
green and positive values to red, even when the distribution of negative
values and positive values are not centric to zero. Also this color mapping
function is <strong>not affected by outliers</strong>. In following plot, the clustering is
heavily affected by the outlier (see the dendrogram) but not the color mapping.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat2</span> <span class="op">=</span> <span class="va">mat</span>
<span class="va">mat2</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">100000</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat2</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>, 
    column_title <span class="op">=</span> <span class="st">"a matrix with outliers"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-3-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>More importantly, <code><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2()</a></code> makes colors in multiple heatmaps comparible
if they are set with a same color mapping function. In following three
heatmaps, a same color always corresponds to a same value.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>, column_title <span class="op">=</span> <span class="st">"mat"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span><span class="op">/</span><span class="fl">4</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>, column_title <span class="op">=</span> <span class="st">"mat/4"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>, column_title <span class="op">=</span> <span class="st">"abs(mat)"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-5-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>If the matrix is continuous, you can also simply provide a vector of colors
and colors will be linearly interpolated. But remember this method is not
robust to outliers because the mapping starts from the minimal value in the
matrix and ends with the maximal value. Following color mapping setting is
identical to <code>colorRamp2(seq(min(mat), max(mat), length = 10), rev(rainbow(10)))</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">rainbow</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span>, 
    column_title <span class="op">=</span> <span class="st">"set a color vector for a continuous matrix"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-6-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>If the matrix contains discrete values (either numeric or character), colors
should be specified as a named vector to make it possible for the mapping from
discrete values to colors. If there is no name for the color vector, the order of
colors corresponds to the order of <code>unique(mat)</code>. Note now the legend is
generated from the color mapping vector and it is a “discrete legend.”</p>
<p>In the following example, we set colors for a discrete numeric matrix. You don’t need to convert
it to a character matrix, just set the numbers as “names” of the color vector.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">discrete_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>
<span class="va">colors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"2"</span>, <span class="st">"3"</span>, <span class="st">"4"</span><span class="op">)</span><span class="op">)</span> <span class="co"># black, red, green, blue</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">discrete_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">colors</span>,
    column_title <span class="op">=</span> <span class="st">"a discrete numeric matrix"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-7-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>For a character matrix, it is straightforward.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">discrete_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>
<span class="va">colors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, names <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">discrete_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">colors</span>,
    column_title <span class="op">=</span> <span class="st">"a discrete character matrix"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/discrete_character_matrix-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>As you can see in the two examples above, for the numeric matrix (no matter the
color is continuous mapping or discrete mapping), by default clustering is
applied on both dimensions, while for character matrix, clustering is turned
off (but you can still cluster a character matrix if you provide a proper
distance metric for two character vectors, see example in Section
<a href="a-single-heatmap.html#distance-methods">2.3.1</a>).</p>
<p><code>NA</code> is allowed in the matrix. You can control the color of <code>NA</code> by <code>na_col</code>
argument (by default it is grey for <code>NA</code>). <strong>A matrix that contains <code>NA</code> can
be clustered by <code>Heatmap()</code></strong> as long as there is no <code>NA</code> distances between
any of the rows or columns respectively. Usually these cases correspond to
sparse matrices (filled with a lot of <code>NA</code> values), and indicate that the
unknown values should be predicted via other methods first.</p>
<p>Note the <code>NA</code> value is not presented in the legend.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat_with_na</span> <span class="op">=</span> <span class="va">mat</span>
<span class="va">na_index</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span>
<span class="va">mat_with_na</span><span class="op">[</span><span class="va">na_index</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat_with_na</span>, name <span class="op">=</span> <span class="st">"mat"</span>, na_col <span class="op">=</span> <span class="st">"black"</span>,
    column_title <span class="op">=</span> <span class="st">"a matrix with NA values"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-8-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Color space is important for interpolating colors. By default, colors are
linearly interpolated in <a href="https://en.wikipedia.org/wiki/Lab_color_space">LAB color
space</a>, but you can select the
color space in <code><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2()</a></code> function. Compare following two plots. Can you
see the difference?</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"#EEEEEE"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>
<span class="va">f2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"#EEEEEE"</span>, <span class="st">"red"</span><span class="op">)</span>, space <span class="op">=</span> <span class="st">"RGB"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat1"</span>, col <span class="op">=</span> <span class="va">f1</span>, column_title <span class="op">=</span> <span class="st">"LAB color space"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat2"</span>, col <span class="op">=</span> <span class="va">f2</span>, column_title <span class="op">=</span> <span class="st">"RGB color space"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-10-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>In following plots, corresponding values change evenly on the folded lines,
you can see how colors change under different color spaces (top plots:
green-black-red, bottom plots: blue-white-red. The plot is made by
<a href="https://bioconductor.org/packages/release/bioc/html/HilbertCurve.html"><strong>HilbertCurve</strong> package</a>).</p>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-11-1.png" width="100%" style="display: block; margin: auto;"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-11-2.png" width="100%" style="display: block; margin: auto;"></p>
<p>Last but not the least, colors for the heatmap borders can be set by the
<code>border</code>/<code>border_gp</code> and <code>rect_gp</code> arguments. <code>border</code>/<code>border_gp</code> controls
the global border of the heatmap body and <code>rect_gp</code> controls the border of the
grids/cells in the heatmap.</p>
<p>The value of <code>border</code> can be logical (<code>TRUE</code> corresponds to <code>black</code>) or a
character of color (e.g. <code>red</code>). The use for <code>border</code> argument is only for historical
reason, here you can also set <code>border_gp</code> argument which should be a <code>gpar</code> object.</p>
<p><code>rect_gp</code> is a <code>gpar</code> object which means you can only set it by
<code><a href="https://rdrr.io/r/grid/gpar.html">grid::gpar()</a></code>. Since the filled color is already controlled by the heatmap
color mapping, you can only set the <code>col</code>/<code>lwd</code>/<code>lty</code> parameters in <code>gpar()</code> to control the
border of the heatmap grids.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, border_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"black"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,
    column_title <span class="op">=</span> <span class="st">"set heatmap borders"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-12-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, rect_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,
    column_title <span class="op">=</span> <span class="st">"set cell borders"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-12-2.png" width="499.2" style="display: block; margin: auto;"></div>
<p>If <code>col</code> is not set, the default color mapping by <code>Heatmap()</code> is designed with
trying to be as convinient and meaningful as possible. Following are the rules
for the default color mapping (by <code>ComplexHeatmap:::default_col()</code>):</p>
<ul>
<li>If the values are characters, the colors are generated by
<code><a href="https://rdrr.io/pkg/circlize/man/rand_color.html">circlize::rand_color()</a></code>.</li>
<li>If the values are from the heatmap annotation and are numeric, colors are
mapped between white and one random color by linearly interpolating to the
mininum and maxinum.</li>
<li>If the values are from the matrix (let’s denote it as <span class="math inline">\(M\)</span>):
<ul>
<li>If the fraction of positive values in <span class="math inline">\(M\)</span> is between 25% and 75%, colors
are mapped to blue, white and red by linearly interpolating to <span class="math inline">\(-q\)</span>, 0
and <span class="math inline">\(q\)</span>, where <span class="math inline">\(q\)</span> is the maximum of <span class="math inline">\(|M|\)</span> if the number of unique
values is less than 100, or <span class="math inline">\(q\)</span> is the 99th percentile of <span class="math inline">\(|M|\)</span> if there are more than 100 values in teh matrix. This
color mapping is centric to zero.</li>
<li>Or else the colors are mapped to blue, white and red by linearly
interpolating to <span class="math inline">\(q_1\)</span>, <span class="math inline">\((q_1 + q_2)/2\)</span> and <span class="math inline">\(q_2\)</span>, where <span class="math inline">\(q_1\)</span> and <span class="math inline">\(q_2\)</span>
are mininum and maxinum if the number of unique values is <span class="math inline">\(M\)</span> is less
than 100. If there are more than 100 values in the matrix, <span class="math inline">\(q_1\)</span> is the 1st percentile and <span class="math inline">\(q_2\)</span> is the 99th
percentile in <span class="math inline">\(M\)</span>.</li>
</ul>
</li>
</ul>
<p><code>rect_gp</code> allows a non-standard parameter <code>type</code>. If it is set to <code>"none"</code>,
the clustering is still applied but nothing in drawn on the heatmap body. The
customized graphics on heatmap body can be later added via a self-defined <code>cell_fun</code>
or <code>layer_fun</code> (explained in Section <a href="a-single-heatmap.html#customize-the-heatmap-body">2.9</a>).</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, rect_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>,
    column_title <span class="op">=</span> <span class="st">"nothing is drawn in the heatmap body"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-13-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
<div id="heatmap-titles" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> Titles<a class="anchor" aria-label="anchor" href="#heatmap-titles"><i class="fas fa-link"></i></a>
</h2>
<p>The title of the heatmap basically tells what the plot is about. In
<strong>ComplexHeatmap</strong> package, you can set heatmap title either by the row or/and
by the column. Note at a same time you can only put e.g. column title either
on the top or at the bottom of the heatmap.</p>
<p>The graphic parameters can be set by <code>row_title_gp</code> and <code>column_title_gp</code>
respectively. Please remember you should use <code>gpar()</code> to specify graphics
parameters.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, column_title <span class="op">=</span> <span class="st">"I am a column title"</span>, 
    row_title <span class="op">=</span> <span class="st">"I am a row title"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/row_column_title-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, column_title <span class="op">=</span> <span class="st">"I am a column title at the bottom"</span>, 
    column_title_side <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/row_column_title-2.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, column_title <span class="op">=</span> <span class="st">"I am a big column title"</span>, 
    column_title_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">20</span>, fontface <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/row_column_title-3.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Rotations for titles can be set by <code>row_title_rot</code> and <code>column_title_rot</code>, but
only horizontal and vertical rotations are allowed.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_title <span class="op">=</span> <span class="st">"row title"</span>, row_title_rot <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/title_rotation-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Row or column title supports as a template which is used when rows or columns
are split in the heatmap (because there will be multiple row/column titles).
This functionality is introduced in Section <a href="a-single-heatmap.html#heatmap-split">2.7</a>. A quick
example would be:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="co"># row title would be cluster_1 and cluster_2</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">2</span>, row_title <span class="op">=</span> <span class="st">"cluster_%s"</span><span class="op">)</span></code></pre></div>
<p>You can set <code>fill</code> parameter in <code>row_title_gp</code> and <code>column_title_gp</code> to set
the background color of titles. Since <code>col</code> in e.g. <code>row_title_gp</code> controls the
color of text, <code>border</code> is used to control the color of the background border.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, column_title <span class="op">=</span> <span class="st">"I am a column title"</span>, 
    column_title_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"red"</span>, col <span class="op">=</span> <span class="st">"white"</span>, border <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-15-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>You might have found there is no space on the top of the column title when the background
is colored. This is mainly for being consistent to the figure titles of ggplot2 figures (when you make a multiple-panel figure mixed
with ComplexHeatmap and ggplot2 plots).
This can be adjusted by setting the global parameter <code>ht_opt$TITLE_PADDING</code>.
The use for <code>ht_opt()</code> will be introduced in Section <a href="a-list-of-heatmaps.html#change-parameters-globally">4.13</a>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht_opt</span><span class="op">$</span><span class="va">TITLE_PADDING</span> <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8.5</span>, <span class="fl">8.5</span><span class="op">)</span>, <span class="st">"points"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, column_title <span class="op">=</span> <span class="st">"I am a column title"</span>, 
    column_title_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"red"</span>, col <span class="op">=</span> <span class="st">"white"</span>, border <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-16-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ht_opt</span><span class="op">(</span>RESET <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>Title can be set as mathematical formulas.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    column_title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">hat</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">==</span> <span class="op">(</span><span class="va">X</span><span class="op">^</span><span class="va">t</span> <span class="op">*</span> <span class="va">X</span><span class="op">)</span><span class="op">^</span><span class="op">{</span><span class="op">-</span><span class="fl">1</span><span class="op">}</span> <span class="op">*</span> <span class="va">X</span><span class="op">^</span><span class="va">t</span> <span class="op">*</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-17-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>More complicated text can be drawn as the heatmap title by using the
<strong>gridtext</strong> package. Following plot fives a quick example. See Section <a href="integrate-with-other-packages.html#gridtext-title">10.3.1</a> for more examples.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>,
    column_title <span class="op">=</span> <span class="fu">gt_render</span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Some &lt;span style='color:blue'&gt;blue text **in bold.**&lt;/span&gt;&lt;br&gt;"</span>,
            <span class="st">"And *italics text.*&lt;br&gt;And some "</span>,
            <span class="st">"&lt;span style='font-size:18pt; color:black'&gt;large&lt;/span&gt; text."</span><span class="op">)</span>, 
        r <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"pt"</span><span class="op">)</span>, 
        padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"pt"</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-18-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
<div id="clustering" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Clustering<a class="anchor" aria-label="anchor" href="#clustering"><i class="fas fa-link"></i></a>
</h2>
<p>Clustering might be the key component of heatmap visualization. In
<strong>ComplexHeatmap</strong> package, hierarchical clustering is supported with great
flexibility. You can specify the clustering either by:</p>
<ul>
<li>a pre-defined distance method (e.g. <code>"euclidean"</code> or <code>"pearson"</code>),</li>
<li>a distance function,</li>
<li>a object that already contains clustering (a <code>hclust</code> or <code>dendrogram</code> object
or object that can be coerced to <code>dendrogram</code> class),</li>
<li>a clustering function.</li>
</ul>
<p>It is also possible to render the dendrograms with different colors and styles
for different nodes and branches for better revealing structures of the dendrogram (e.g.
by <code><a href="http://talgalili.github.io/dendextend/reference/color_branches.html">dendextend::color_branches()</a></code>).</p>
<p>First, there are general settings for the clustering, e.g. whether to apply
clustering or show dendrograms, the side of the dendrograms and heights of the
dendrograms.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># turn off row clustering</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_basic-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, show_column_dend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># hide column dendrogram</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_basic-2.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_dend_side <span class="op">=</span> <span class="st">"right"</span>, column_dend_side <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_basic-3.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, column_dend_height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span>, 
    row_dend_width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_basic-4.png" width="499.2" style="display: block; margin: auto;"></div>
<div id="distance-methods" class="section level3" number="2.3.1">
<h3>
<span class="header-section-number">2.3.1</span> Distance methods<a class="anchor" aria-label="anchor" href="#distance-methods"><i class="fas fa-link"></i></a>
</h3>
<p>Hierarchical clustering is performed in two steps: calculate the distance
matrix and apply clustering. There are three ways to specify distance metric
for clustering:</p>
<ul>
<li>specify distance as a pre-defined option. The valid values are the supported
methods in <code><a href="https://rdrr.io/r/stats/dist.html">dist()</a></code> function and in <code>"pearson"</code>, <code>"spearman"</code> and
<code>"kendall"</code>. The correlation distance is defined as <code>1 - cor(x, y, method)</code>.
All these built-in distance methods allow <code>NA</code> values.</li>
<li>a self-defined function which calculates distance from a matrix. The
function should only contain one argument. Please note for clustering on
columns, the matrix will be transposed automatically.</li>
<li>a self-defined function which calculates distance from two vectors. The
function should only contain two arguments. Note this might be slow because
it is implemented by two nested <code>for</code> loop.</li>
</ul>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, clustering_distance_rows <span class="op">=</span> <span class="st">"pearson"</span>,
    column_title <span class="op">=</span> <span class="st">"pre-defined distance method (1 - pearson)"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_distance-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, clustering_distance_rows <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>,
    column_title <span class="op">=</span> <span class="st">"a function that calculates distance matrix"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_distance-2.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, clustering_distance_rows <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,
    column_title <span class="op">=</span> <span class="st">"a function that calculates pairwise distance"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_distance-3.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Based on these features, we can apply clustering which is robust to outliers
based on the pairwise distance. Note here we set the color mapping function
because we don’t want outliers affect the colors.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat_with_outliers</span> <span class="op">=</span> <span class="va">mat</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span>  <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="va">mat_with_outliers</span><span class="op">[</span><span class="va">i</span>, <span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1000</span>
<span class="va">robust_dist</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">qx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span>
    <span class="va">qy</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span>
    <span class="va">l</span> <span class="op">=</span> <span class="va">x</span> <span class="op">&gt;</span> <span class="va">qx</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">x</span> <span class="op">&lt;</span> <span class="va">qx</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">y</span> <span class="op">&gt;</span> <span class="va">qy</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">y</span> <span class="op">&lt;</span> <span class="va">qy</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
    <span class="va">x</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">l</span><span class="op">]</span>
    <span class="va">y</span> <span class="op">=</span> <span class="va">y</span><span class="op">[</span><span class="va">l</span><span class="op">]</span>
    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">y</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We can compare the two heatmaps with or without the robust distance method:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat_with_outliers</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>,
    column_title <span class="op">=</span> <span class="st">"dist"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat_with_outliers</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>,
    clustering_distance_rows <span class="op">=</span> <span class="va">robust_dist</span>,
    clustering_distance_columns <span class="op">=</span> <span class="va">robust_dist</span>,
    column_title <span class="op">=</span> <span class="st">"robust_dist"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-20-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>If there are proper distance methods (like methods in <a href="https://cran.r-project.org/web/packages/stringdist/"><strong>stringdist</strong>
package</a>), you can also
cluster a character matrix. <code>cell_fun</code> argument will be introduced in Section
<a href="a-single-heatmap.html#customize-the-heatmap-body">2.9</a>.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat_letters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>
<span class="co"># distance in the ASCII table</span>
<span class="va">dist_letters</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/strtoi.html">strtoi</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">x</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>, base <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>
    <span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/strtoi.html">strtoi</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">y</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>, base <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">y</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat_letters</span>, name <span class="op">=</span> <span class="st">"letters"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span>, names <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>,
    clustering_distance_rows <span class="op">=</span> <span class="va">dist_letters</span>, 
    clustering_distance_columns <span class="op">=</span> <span class="va">dist_letters</span>,
    cell_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">w</span>, <span class="va">h</span>, <span class="va">col</span><span class="op">)</span> <span class="op">{</span> <span class="co"># add text to each grid</span>
        <span class="fu">grid.text</span><span class="op">(</span><span class="va">mat_letters</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_character_matrix-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
<div id="clustering-methods" class="section level3" number="2.3.2">
<h3>
<span class="header-section-number">2.3.2</span> Clustering methods<a class="anchor" aria-label="anchor" href="#clustering-methods"><i class="fas fa-link"></i></a>
</h3>
<p>Method to perform hierarchical clustering can be specified by
<code>clustering_method_rows</code> and <code>clustering_method_columns</code>. Possible methods are
those supported in <code><a href="https://rdrr.io/r/stats/hclust.html">hclust()</a></code> function.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, clustering_method_rows <span class="op">=</span> <span class="st">"single"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_method-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>If you already have a clustering object or a function which directly returns a
clustering object, you can ignore the distance settings and set <code>cluster_rows</code>
or <code>cluster_columns</code> to the clustering objects or clustering functions. If it
is a clustering function, the only argument should be the matrix and it should
return a <code>hclust</code> or <code>dendrogram</code> object or a object that can be converted to
the <code>dendrogram</code> class.</p>
<p>In following example, we perform clustering with methods from <strong>cluster</strong>
package either by a pre-calculated clustering object or a clustering function:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/cluster/">cluster</a></span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/cluster/man/diana.html">diana</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>,
   cluster_columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/cluster/man/agnes.html">agnes</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span>, column_title <span class="op">=</span> <span class="st">"clustering objects"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_object-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># if cluster_columns is set as a function, you don't need to transpose the matrix</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="va">diana</span>,
   cluster_columns <span class="op">=</span> <span class="va">agnes</span>, column_title <span class="op">=</span> <span class="st">"clustering functions"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_object-2.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The last command is as same as :</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/dendrogram.html">as.dendrogram</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/cluster/man/diana.html">diana</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span>,
    cluster_columns <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/dendrogram.html">as.dendrogram</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/cluster/man/agnes.html">agnes</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span>, 
    column_title <span class="op">=</span> <span class="st">"clutering functions"</span><span class="op">)</span></code></pre></div>
<p>Please note, when <code>cluster_rows</code> is set as a function, the argument <code>m</code> is the
input <code>mat</code> itself, while for <code>cluster_columns</code>, <code>m</code> is the transpose of
<code>mat</code>.</p>
<p><code><a href="https://rdrr.io/pkg/fastcluster/man/hclust.html">fastcluster::hclust</a></code> implements a faster version of <code><a href="https://rdrr.io/r/stats/hclust.html">hclust()</a></code>. You can set
it to <code>cluster_rows</code> and <code>cluster_columns</code> to use the faster version of
<code><a href="https://rdrr.io/r/stats/hclust.html">hclust()</a></code>.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">fh</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">fastcluster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fastcluster/man/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="va">fh</span>, cluster_columns <span class="op">=</span> <span class="va">fh</span><span class="op">)</span></code></pre></div>
<p>To make it more convinient to use the faster version of <code><a href="https://rdrr.io/r/stats/hclust.html">hclust()</a></code> (assuming
you have many heatmaps to construct), it can be set as a global option. The
usage of <code>ht_opt</code> is introduced in Section
<a href="a-list-of-heatmaps.html#change-parameters-globally">4.13</a>.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">ht_opt</span><span class="op">$</span><span class="va">fast_hclust</span> <span class="op">=</span> <span class="cn">TRUE</span>
<span class="co"># now fastcluster::hclust is used in all heatmaps</span></code></pre></div>
<p>This is one special scenario where you might already have a subgroup
classification for the matrix rows or columns, and you only want to perform
clustering for the features in the same subgroup. You
can split the heatmap by the subgroup variable (see Section
<a href="a-single-heatmap.html#heatmap-split">2.7</a>), or you can use <code>cluster_within_group()</code> clustering
function to generate a special dendrogram.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">group</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, centers <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">$</span><span class="va">cluster</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_columns <span class="op">=</span> <span class="fu">cluster_within_group</span><span class="op">(</span><span class="va">mat</span>, <span class="va">group</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-24-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>In above example, columns in a same group are still clustered, but the
dendrogram is degenerated as a flat line. The dendrogram on columns shows the
hierarchy of the groups.</p>
</div>
<div id="render-dendrograms" class="section level3" number="2.3.3">
<h3>
<span class="header-section-number">2.3.3</span> Render dendrograms<a class="anchor" aria-label="anchor" href="#render-dendrograms"><i class="fas fa-link"></i></a>
</h3>
<p>If you want to render the dendrogram, normally you need to generate a
<code>dendrogram</code> object and render it through <code>nodePar</code> and <code>edgePar</code> parameter in
advance, then send it to the <code>cluster_rows</code> or <code>cluster_columns</code> argument.</p>
<p>You can render your <code>dendrogram</code> object by the <strong>dendextend</strong> package to make
a more customized visualization of the dendrogram.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://talgalili.github.io/dendextend/">dendextend</a></span><span class="op">)</span>
<span class="va">row_dend</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/dendrogram.html">as.dendrogram</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">row_dend</span> <span class="op">=</span> <span class="fu"><a href="http://talgalili.github.io/dendextend/reference/color_branches.html">color_branches</a></span><span class="op">(</span><span class="va">row_dend</span>, k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># `color_branches()` returns a dendrogram object</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="va">row_dend</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_dendextend-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p><code>row_dend_gp</code> and <code>column_dend_gp</code> control the global graphics setting for
dendrograms. Note e.g. graphics settings in <code>row_dend</code> will be overwritten by
<code>row_dend_gp</code>.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="va">row_dend</span>, 
    row_dend_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-25-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>From version 2.5.6, you can also add graphics on the nodes of the dendrogram by setting
a proper <code>nodePar</code>.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">row_dend</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/dendrapply.html">dendrapply</a></span><span class="op">(</span><span class="va">row_dend</span>, <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">d</span>, <span class="st">"nodePar"</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>cex <span class="op">=</span> <span class="fl">0.8</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">1</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/rand_color.html">rand_color</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="va">row_dend</span>, row_dend_width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-26-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Currently, only points can be added on the nodes, however, if you have the need to add
more types of graphics, especially the self-defined graphics, just send me a message and I
will think about it.</p>
</div>
<div id="reorder-dendrograms" class="section level3" number="2.3.4">
<h3>
<span class="header-section-number">2.3.4</span> Reorder dendrograms<a class="anchor" aria-label="anchor" href="#reorder-dendrograms"><i class="fas fa-link"></i></a>
</h3>
<p>In the <code>Heatmap()</code> function, dendrograms are reordered to make features with
larger difference more separated from each others (please refer to the
documentation of <code><a href="https://rdrr.io/r/stats/reorder.dendrogram.html">reorder.dendrogram()</a></code>). Here the difference (or it is called
the weight) is measured by the row means if it is a row dendrogram or by the
column means if it is a column dendrogram. <code>row_dend_reorder</code> and
<code>column_dend_reorder</code> control whether to apply dendrogram reordering if the
value is set as logical. The two arguments also control the weight for the
reordering if they are set to numeric vectors (it will be sent to the <code>wts</code>
argument of <code><a href="https://rdrr.io/r/stats/reorder.dendrogram.html">reorder.dendrogram()</a></code>). The reordering can be turned off by
setting e.g. <code>row_dend_reorder = FALSE</code>.</p>
<p>By default, dendrogram reordering is turned on if
<code>cluster_rows</code>/<code>cluster_columns</code> is set as logical value or a clustering
function. It is turned off if <code>cluster_rows</code>/<code>cluster_columns</code> is set as
clustering object.</p>
<p>Compare following two heatmaps:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, nr <span class="op">=</span> <span class="fl">10</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">m2</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_dend_reorder <span class="op">=</span> <span class="cn">FALSE</span>, column_title <span class="op">=</span> <span class="st">"no reordering"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">m2</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_dend_reorder <span class="op">=</span> <span class="cn">TRUE</span>, column_title <span class="op">=</span> <span class="st">"apply reordering"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cluster_dendsort-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>There are many other methods for reordering dendrograms, e.g. the <strong>dendsort</strong>
package. Basically, all these methods still return a dendrogram that has been
reordered, thus, we can firstly generate the row or column dendrogram based on
the data matrix, reorder it by a certain method, and assign it back to
<code>cluster_rows</code> or <code>cluster_columns</code>.</p>
<p>Compare following two reorderings on both dimensions. Can you tell which is better?</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, column_title <span class="op">=</span> <span class="st">"default reordering"</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/evanbiederstedt/dendsort">dendsort</a></span><span class="op">)</span>
<span class="va">row_dend</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/dendsort/man/dendsort.html">dendsort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">col_dend</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/dendsort/man/dendsort.html">dendsort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="va">row_dend</span>, cluster_columns <span class="op">=</span> <span class="va">col_dend</span>,
    column_title <span class="op">=</span> <span class="st">"reorder by dendsort"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-29-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
</div>
<div id="row-and_column_orders" class="section level2" number="2.4">
<h2>
<span class="header-section-number">2.4</span> Set row and column orders<a class="anchor" aria-label="anchor" href="#row-and_column_orders"><i class="fas fa-link"></i></a>
</h2>
<p>Clustering is used to adjust row orders and column orders of the heatmap, but
you can still set the order manually by <code>row_order</code> and <code>column_order</code>. If
e.g. <code>row_order</code> is set, row clustering is turned off by default.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    row_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"row"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
    column_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    column_title <span class="op">=</span> <span class="st">"reorder matrix"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/manual_order-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The orders can be character vectors if they are just shuffles of the matrix row names or column names.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span>, 
    column_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span>,
    column_title <span class="op">=</span> <span class="st">"reorder matrix by row/column names"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-30-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Note <code>row_dend_reorder</code> and <code>row_order</code> are two different things.
<code>row_dend_reorder</code> is applied on the dendrogram. For any node in the
dendrogram, rotating its two branches actually gives an identical dendrogram,
thus, reordering the dendrogram by automatically rotating sub-dendrogram at
every node can help to separate features further from each other which show
more difference. As a comparison, <code>row_order</code> is simply applied to the matrix
and normally dendrograms should be turned off.</p>
</div>
<div id="heatmap-seriation" class="section level2" number="2.5">
<h2>
<span class="header-section-number">2.5</span> Seriation<a class="anchor" aria-label="anchor" href="#heatmap-seriation"><i class="fas fa-link"></i></a>
</h2>
<p>Seriation is an interesting technique for ordering the matrix (see this
interesting post: <a href="http://nicolas.kruchten.com/content/2018/02/seriation/" class="uri">http://nicolas.kruchten.com/content/2018/02/seriation/</a>). The
powerful <a href="https://cran.r-project.org/web/packages/seriation/index.html"><strong>seriation</strong>
package</a>
implements quite a lot of methods for seriation. Since it is easy to extract
row orders and column orders from the object returned by the core function
<code><a href="https://rdrr.io/pkg/seriation/man/seriate.html">seriate()</a></code> from <strong>seriation</strong> package, they can be directly assigned to
<code>row_order</code> and <code>column_order</code> to make the heatmap.</p>
<p>The first example demonstrates directly applying <code><a href="https://rdrr.io/pkg/seriation/man/seriate.html">seriate()</a></code> on the matrix.
Since the <code>"BEA_TSP"</code> method only allows a non-negative matrix, we modify the
matrix to <code>max(mat) - mat</code>.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mhahsler/seriation">seriation</a></span><span class="op">)</span>
<span class="va">o</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/seriation/man/seriate.html">seriate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">-</span> <span class="va">mat</span>, method <span class="op">=</span> <span class="st">"BEA_TSP"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">-</span> <span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    row_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/seriation/man/get_order.html">get_order</a></span><span class="op">(</span><span class="va">o</span>, <span class="fl">1</span><span class="op">)</span>, column_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/seriation/man/get_order.html">get_order</a></span><span class="op">(</span><span class="va">o</span>, <span class="fl">2</span><span class="op">)</span>,
    column_title <span class="op">=</span> <span class="st">"seriation by BEA_TSP method"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-31-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Or you can apply <code><a href="https://rdrr.io/pkg/seriation/man/seriate.html">seriate()</a></code> to the distance matrix. Now the order for rows
and columns needs to be calcualted separatedly because the distance matrix
needs to be calculated separatedly for columns and rows.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">o1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/seriation/man/seriate.html">seriate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"TSP"</span><span class="op">)</span>
<span class="va">o2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/seriation/man/seriate.html">seriate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"TSP"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/seriation/man/get_order.html">get_order</a></span><span class="op">(</span><span class="va">o1</span><span class="op">)</span>, column_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/seriation/man/get_order.html">get_order</a></span><span class="op">(</span><span class="va">o2</span><span class="op">)</span>,
    column_title <span class="op">=</span> <span class="st">"seriation from the distance matrix"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-32-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Some seriation methods also contain the hierarchical clustering information.
Let’s try:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">o1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/seriation/man/seriate.html">seriate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"GW"</span><span class="op">)</span>
<span class="va">o2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/seriation/man/seriate.html">seriate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"GW"</span><span class="op">)</span></code></pre></div>
<p><code>o1</code> and <code>o2</code> are actually mainly composed of <code>hclust</code> objects:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">o1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "ser_permutation_vector" "hclust"</code></pre>
<p>And the orders are the same by using <code>hclust$order</code> or <code><a href="https://rdrr.io/pkg/seriation/man/get_order.html">get_order()</a></code>.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">o1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">order</span></code></pre></div>
<pre><code>##  [1]  5  2  4 17 16  7 18 10 14 15  1  3  8 11  9 13  6 12</code></pre>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># should be the same as the previous one</span>
<span class="fu"><a href="https://rdrr.io/pkg/seriation/man/get_order.html">get_order</a></span><span class="op">(</span><span class="va">o1</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1]  5  2  4 17 16  7 18 10 14 15  1  3  8 11  9 13  6 12</code></pre>
<p>And we can add the dendrograms to the heatmap.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/dendrogram.html">as.dendrogram</a></span><span class="op">(</span><span class="va">o1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, 
    cluster_columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/dendrogram.html">as.dendrogram</a></span><span class="op">(</span><span class="va">o2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-36-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>For more use of the <code><a href="https://rdrr.io/pkg/seriation/man/seriate.html">seriate()</a></code> function, please refer to the <a href="https://cran.r-project.org/web/packages/seriation/index.html"><strong>seriation</strong>
package</a>.</p>
</div>
<div id="dimension-names" class="section level2" number="2.6">
<h2>
<span class="header-section-number">2.6</span> Dimension labels<a class="anchor" aria-label="anchor" href="#dimension-names"><i class="fas fa-link"></i></a>
</h2>
<p>The row names and column names are drawn on the right and bottom sides of the
heatmap by default. Side, visibility and graphics parameters for dimension
names can be set as follows:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_names_side <span class="op">=</span> <span class="st">"left"</span>, row_dend_side <span class="op">=</span> <span class="st">"right"</span>, 
    column_names_side <span class="op">=</span> <span class="st">"top"</span>, column_dend_side <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/dimension_name-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, show_row_names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/dimension_name-2.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_names_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/dimension_name-3.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    row_names_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/dimension_name-4.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    row_names_centered <span class="op">=</span> <span class="cn">TRUE</span>, column_names_centered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/dimension_name-5.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The rotation of column names can be set by <code>column_names_rot</code>:</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, column_names_rot <span class="op">=</span> <span class="fl">45</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, column_names_rot <span class="op">=</span> <span class="fl">45</span>, column_names_side <span class="op">=</span> <span class="st">"top"</span>,
    column_dend_side <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-38-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>If you have row names or column names which are too long,
<code>row_names_max_width</code> or <code>column_names_max_height</code> can be used to set the
maximal space for them. The default maximal space for row names and column
names are all 6 cm. In following code, <code>max_text_width()</code> is a helper function
to quick calculate maximal width from a vector of text.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat2</span> <span class="op">=</span> <span class="va">mat</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat2</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">letters</span>, <span class="va">LETTERS</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat2</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_title <span class="op">=</span> <span class="st">"default row_names_max_width"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat2</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_title <span class="op">=</span> <span class="st">"row_names_max_width as length of a*"</span>,
    row_names_max_width <span class="op">=</span> <span class="fu">max_text_width</span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat2</span><span class="op">)</span>, 
        gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>
    <span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-40-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Instead of directly using the row/column names from the matrix, you can also
provide another character vector which corresponds to the rows or columns and
set it by <code>row_labels</code> or <code>column_labels</code>. This is useful because you don’t
need to change the dimension names of the matrix to change the labels on the
heatmap while you can directly provide the new labels.</p>
<p>There is one typical scenario that <code>row_labels</code> and <code>column_labels</code> are
useful. For the gene expression analysis, we might use Ensembl ID as the gene
ID which is used as row names of the gene expression matrix. However, the
Ensembl ID is for the indexing of the Ensembl database but not for the human
reading. Instead, we would prefer to put gene symbols on the heatmap as the
row names which is easier to read. To do this, we only need to assign the
corresponding gene symbols to <code>row_labels</code> without modifying the original
matrix.</p>
<p>The second advantage is <code>row_labels</code> or <code>column_labels</code> allows duplicated
labels, while duplicated row names or column names are not allowed in the
matrix.</p>
<p>Following gives a simple example that we put letters as row labels and column
labels:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># use a named vector to make sure the correspondance between </span>
<span class="co"># row names and row labels is correct</span>
<span class="va">row_labels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">24</span><span class="op">]</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">24</span><span class="op">)</span>, names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"row"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span>
<span class="va">column_labels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">24</span><span class="op">]</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">24</span><span class="op">)</span>, names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span>
<span class="va">row_labels</span></code></pre></div>
<pre><code>##  row1  row2  row3  row4  row5  row6  row7  row8  row9 row10 row11 row12 row13 
##  "a1"  "b2"  "c3"  "d4"  "e5"  "f6"  "g7"  "h8"  "i9" "j10" "k11" "l12" "m13" 
## row14 row15 row16 row17 row18 row19 row20 row21 row22 row23 row24 
## "n14" "o15" "p16" "q17" "r18" "s19" "t20" "u21" "v22" "w23" "x24"</code></pre>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_labels <span class="op">=</span> <span class="va">row_labels</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">]</span>, 
    column_labels <span class="op">=</span> <span class="va">column_labels</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-41-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The third advantage is mathematical expression can be used as row names in the
heatmap.</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">alpha</span>, <span class="va">beta</span>, <span class="va">gamma</span>, 
    <span class="va">delta</span>, <span class="va">epsilon</span>, <span class="va">zeta</span>, <span class="va">eta</span>, <span class="va">theta</span>, <span class="va">iota</span>, <span class="va">kappa</span>, <span class="va">lambda</span>, <span class="va">mu</span>, <span class="va">nu</span>, <span class="va">xi</span>, 
    <span class="va">omicron</span>, <span class="va">pi</span>, <span class="va">rho</span>, <span class="va">sigma</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-42-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The fourth advantage is that you can construct complicated labels with <strong>gridtext</strong> package.
The following is a quick example. More examples can be found in Section <a href="integrate-with-other-packages.html#gridtext-title">10.3.1</a>.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>,
    row_labels <span class="op">=</span> <span class="fu">gt_render</span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">18</span><span class="op">]</span>, padding <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span>, <span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>, <span class="st">"pt"</span><span class="op">)</span><span class="op">)</span>,
    row_names_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>box_col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"green"</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-43-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Internally, row names and columns names are actually implemented by the
<code>anno_text()</code> function (Section <a href="heatmap-annotations.html#text-annotation">3.14</a>), in other words, they
are treated as special cases for text annotations.</p>
</div>
<div id="heatmap-split" class="section level2" number="2.7">
<h2>
<span class="header-section-number">2.7</span> Heatmap split<a class="anchor" aria-label="anchor" href="#heatmap-split"><i class="fas fa-link"></i></a>
</h2>
<p>One major advantage of <strong>ComplexHeatmap</strong> package is that it supports splitting the
heatmap by rows and columns to better group the features and additionally
highlight the patterns.</p>
<p>Following arguments control the splitting: <code>row_km</code>, <code>row_split</code>, <code>column_km</code>,
<code>column_split</code>. In following, we call the sub-clusters generated by splitting as
“<em>slices</em>.”</p>
<div id="split-by-kmeans-clustering" class="section level3" number="2.7.1">
<h3>
<span class="header-section-number">2.7.1</span> Split by k-means clustering<a class="anchor" aria-label="anchor" href="#split-by-kmeans-clustering"><i class="fas fa-link"></i></a>
</h3>
<p><code>row_km</code> and <code>column_km</code> apply k-means partitioning.</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/k_means-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, column_km <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/k_means-2.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Row splitting and column splitting can be performed simultaneously.</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-44-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>You might notice there are dashed lines in the row and column dendrograms,
it will be explained in Section <a href="a-single-heatmap.html#split-by-categorical-variables">2.7.2</a> (the last paragraph).</p>
<p><code>Heatmap()</code> internally calls <code><a href="https://rdrr.io/r/stats/kmeans.html">kmeans()</a></code> with random start points, which
results in, for some cases, generating different clusters from repeated runs.
To get rid of this problem, <code>row_km_repeats</code> and <code>column_km_repeats</code> can be
set to a number larger than 1 to run <code><a href="https://rdrr.io/r/stats/kmeans.html">kmeans()</a></code> multiple times and a final
consensus k-means clustering is used. Please note the final number of clusters
form consensus k-means might be smaller than the number set in <code>row_km</code> and
<code>column_km</code>.</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># of course, it will be a little bit slower</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    row_km <span class="op">=</span> <span class="fl">2</span>, row_km_repeats <span class="op">=</span> <span class="fl">100</span>,
    column_km <span class="op">=</span> <span class="fl">3</span>, column_km_repeats <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></code></pre></div>
<p>Note if you want the k-means clustering completely reproducible, you must explicitly
set the same random seed:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span>, row_km <span class="op">=</span> <span class="va">...</span>, column_km <span class="op">=</span> <span class="va">...</span><span class="op">)</span></code></pre></div>
</div>
<div id="split-by-categorical-variables" class="section level3" number="2.7.2">
<h3>
<span class="header-section-number">2.7.2</span> Split by categorical variables<a class="anchor" aria-label="anchor" href="#split-by-categorical-variables"><i class="fas fa-link"></i></a>
</h3>
<p>More generally, <code>row_split</code> or <code>column_split</code> can be set to a categorical
vector or a data frame where different combinations of levels split the
rows/columns in the heatmap. How to control the order of the slices is
introduced in Section <a href="a-single-heatmap.html#order-of-slices">2.7.4</a>.</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># split by a vector</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    row_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="fl">9</span><span class="op">)</span>, column_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"C"</span>, <span class="st">"D"</span><span class="op">)</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/split-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># split by a data frame</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    row_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="fl">9</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"C"</span>, <span class="st">"D"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/split-2.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># split on both dimensions</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span>,
    column_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"C"</span>, <span class="st">"D"</span><span class="op">)</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/split-3.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Actually, k-means clustering just generates a vector of cluster classes and
appends to <code>row_split</code> or <code>column_split</code>. <code>row_km</code>/<code>column_km</code> can be used
mixed with <code>row_split</code> and <code>column_split</code>.</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="fl">9</span><span class="op">)</span>, row_km <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-47-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>which is the same as:</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">cl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span><span class="op">(</span><span class="va">mat</span>, centers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">cluster</span>
<span class="co"># classes from k-means are always put as the first column in `row_split`</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>If you are not happy with the default k-means partition, it is easy to use
other partition methods by just assigning the partition vector to
<code>row_split</code>/<code>column_split</code>.</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pa</span> <span class="op">=</span> <span class="fu">cluster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/cluster/man/pam.html">pam</a></span><span class="op">(</span><span class="va">mat</span>, k <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"pam"</span>, <span class="va">pa</span><span class="op">$</span><span class="va">clustering</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/pam-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>If <code>row_order</code> or <code>column_order</code> is set, in each row/column slice, it is still
ordered.</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># remember when `row_order` is set, row clustering is turned off</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_order <span class="op">=</span> <span class="fl">18</span><span class="op">:</span><span class="fl">1</span>, row_km <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/split_row_order-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Character matrix can only be split by <code>row_split</code>/<code>column_split</code> argument.</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># split by the first column in `discrete_mat`</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">discrete_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, row_split <span class="op">=</span> <span class="va">discrete_mat</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/split_discrete_matrix-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>If <code>row_km</code>/<code>column_km</code> is set or <code>row_split</code>/<code>column_split</code> is set as a
vector or a data frame, hierarchical clustering is first applied to each slice
which generates <code>k</code> dendrograms, then a parent dendrogram is generated based
on the mean values of each slice. <strong>The height of the parent dendrogram is
adjusted by adding the maximal height of the dendrograms in all child
slices and the parent dendrogram is added on top of the child dendrograms
to form a single global dendrogram.</strong> This is why you see dashed lines in the
dendrograms in previous heatmaps. They are used to discriminate the parent dendrogram
and the child dendrograms, and alert users they are calculated in different
ways. These dashed lines can be removed by setting <code>show_parent_dend_line = FALSE</code> in <code>Heatmap()</code>, or set it as a global option:
<code>ht_opt$show_parent_dend_line = FALSE</code>, but we are not suggested to do so.</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">3</span>, 
    show_parent_dend_line <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-49-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
<div id="spilt-by-dendrogram" class="section level3" number="2.7.3">
<h3>
<span class="header-section-number">2.7.3</span> Split by dendrogram<a class="anchor" aria-label="anchor" href="#spilt-by-dendrogram"><i class="fas fa-link"></i></a>
</h3>
<p>A second scenario for splitting is that users may still want to keep the
global dendrogram <strong>which is generated from the complete matrix</strong>. In this case, <code>row_split</code>/<code>column_split</code> can be
set to a single number which will apply <code><a href="http://talgalili.github.io/dendextend/reference/cutree-methods.html">cutree()</a></code> on the row/column
dendrogram. This works when <code>cluster_rows</code>/<code>cluster_columns</code> is set to <code>TRUE</code>
or is assigned with a <code>hclust</code>/<code>dendrogram</code> object.</p>
<p>For this case, the dendrogram is still as same as the original one, except that the
positions of dendrogram leaves are slightly adjusted by the gaps between
slices. (There is no dashed lines, because here the dendrogram is calcualted
as a complete one and there is no parent dendrogram or child dendrograms.)</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="fl">2</span>, column_split <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/split_dendrogram-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dend</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/dendrogram.html">as.dendrogram</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">dend</span> <span class="op">=</span> <span class="fu"><a href="http://talgalili.github.io/dendextend/reference/color_branches.html">color_branches</a></span><span class="op">(</span><span class="va">dend</span>, k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, cluster_rows <span class="op">=</span> <span class="va">dend</span>, row_split <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/split_dendrogram-2.png" width="499.2" style="display: block; margin: auto;"></div>
<p>If you want to combine splitting from <code><a href="http://talgalili.github.io/dendextend/reference/cutree-methods.html">cutree()</a></code> and other categorical
variables, you need to generate the partitions from <code><a href="http://talgalili.github.io/dendextend/reference/cutree-methods.html">cutree()</a></code> in the first
place, append to e.g. <code>row_split</code> as a data frame and then send it to
<code>row_split</code> argument.</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="http://talgalili.github.io/dendextend/reference/cutree-methods.html">cutree</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span>, k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span><span class="op">)</span></code></pre></div>
</div>
<div id="order-of-slices" class="section level3" number="2.7.4">
<h3>
<span class="header-section-number">2.7.4</span> Order of slices<a class="anchor" aria-label="anchor" href="#order-of-slices"><i class="fas fa-link"></i></a>
</h3>
<p>When <code>row_split</code>/<code>column_split</code> is set as a categorical variable (a vector or a
data frame) or <code>row_km</code>/<code>column_km</code> is set, by default, there is an additional
clustering applied to the mean of slices to show the hierarchy on the slice
level. Under this scenario, you cannot precisely control the order of slices
because it is controlled by the clustering of slices.</p>
<p>Nevertheless, you can set <code>cluster_row_slices</code> or <code>cluster_column_slices</code> to
<code>FALSE</code> to turn off the clustering on slices, and now you can precisely
control the order of slices.</p>
<p>When there is no slice clustering, the order of each slice can be controlled
by <code>levels</code> of each variable in <code>row_split</code>/<code>column_split</code> (in this case, each
variable should be a factor). If all variables are characters, the default
order is <code>unique(row_split)</code> or <code>unique(column_split)</code>. Compare following
heatmaps:</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    row_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">6</span><span class="op">)</span>, column_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-51-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># clustering is similar as previous heatmap with branches </span>
<span class="co"># in some nodes in the dendrogram flipped</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    row_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">6</span><span class="op">)</span>, levels <span class="op">=</span> <span class="va">LETTERS</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
    column_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, levels <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">6</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-51-2.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># now the order is exactly what we set</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    row_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">6</span><span class="op">)</span>, levels <span class="op">=</span> <span class="va">LETTERS</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
    column_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, levels <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">6</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
    cluster_row_slices <span class="op">=</span> <span class="cn">FALSE</span>, 
    cluster_column_slices <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-51-3.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Also you can see in the third heatmap, when <code>cluster_row_slices</code> and <code>cluster_column_slices</code>
are set to <code>FALSE</code>, there is no dendrogram on slice level.</p>
</div>
<div id="titles-for-splitting" class="section level3" number="2.7.5">
<h3>
<span class="header-section-number">2.7.5</span> Titles for splitting<a class="anchor" aria-label="anchor" href="#titles-for-splitting"><i class="fas fa-link"></i></a>
</h3>
<p>When <code>row_split</code>/<code>column_split</code> is set as a single number, there is only one
categorical variable, while when <code>row_km</code>/<code>column_km</code> is set and/or
<code>row_split</code>/<code>column_split</code> is set as categorical variables, there will be
multiple categorical variables. By default, the titles are in a form of
<code>"level1,level2,..."</code> which corresponds to every combination of levels in all
categorical variables. The titles for splitting can be controlled by “a
template.”</p>
<p><strong>ComplexHeatmap</strong> supports three types of templates. The first one is by
<code><a href="https://rdrr.io/r/base/sprintf.html">sprintf()</a></code> where the <code>%s</code> is replaced by the corresponding level. In
following example, since all combinations of <code>split</code> are <code>c("A", "C")</code>, <code>c("A", "D")</code>, <code>c("B", "C")</code>
and <code>c("B", "D")</code>, if <code>row_title</code> is set to <code>%s|%s</code>, the four row titles will be
<code>A|C</code>, <code>A|D</code>, <code>B|C</code>, <code>B|D</code>.</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="fl">9</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"C"</span>, <span class="st">"D"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">9</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span>, row_title <span class="op">=</span> <span class="st">"%s|%s"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-52-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>For the <code><a href="https://rdrr.io/r/base/sprintf.html">sprintf()</a></code> template, you can only put the levels which are <code>A,B,C,D</code>
in the title, and <code>C,D</code> is always after <code>A,B</code> (i.e. it always <code>A,C</code> and
<code>A,D</code>). However, when making the heatmap, you might want to put more
meaningful text instead of the internal levels. Once you know how to
correspond the text to the level, you can add it by the following two other template
methods.</p>
<p>In the following two template methods, special marks are used to mark the R
code which is executable (it is called variable interpolation where the code
is extracted and executed and the returned value in put back to the string).
There are two types of template marks <code>@{}</code> and <code><a href="https://rdrr.io/r/base/Paren.html">{}</a></code>. The first one is from
<strong>GetoptLong</strong> package which should already be installed when you install the
<strong>ComplexHeatmap</strong> package and the second one is from <strong>glue</strong> package which
you need to install first.</p>
<p>There is an internal variable <code>x</code> you should use when you use the latter two
templates. <code>x</code> is just a simple vector which contains current category levels
(e.g. <code>c("A", "C")</code>).</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># We only run the code for the first heatmap</span>
<span class="va">map</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span> <span class="op">=</span> <span class="st">"aaa"</span>, <span class="st">"B"</span> <span class="op">=</span> <span class="st">"bbb"</span>, <span class="st">"C"</span> <span class="op">=</span> <span class="st">"333"</span>, <span class="st">"D"</span> <span class="op">=</span> <span class="st">"444"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span>, 
    row_title <span class="op">=</span> <span class="st">"@{map[ x[1] ]}|@{map[ x[2] ]}"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span>, 
    row_title <span class="op">=</span> <span class="st">"{map[ x[1] ]}|{map[ x[2] ]}"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-54-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The row title is rotated by default, you can set <code>row_title_rot = 0</code> to make
it horizontal:</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span>, row_title <span class="op">=</span> <span class="st">"%s|%s"</span>, 
    row_title_rot <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-55-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>When <code>row_split</code>/<code>column_split</code> is set as a number, you can also use template
to adjust the titles for slices.</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="fl">2</span>, row_title <span class="op">=</span> <span class="st">"cluster_%s"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-56-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>If you know the final number of row slices, you can directly set a vector of
titles to <code>row_title</code>. Be careful the number of row slices is not always
identical to <code>n_level_1 * n_level_2 * ...</code>.</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># we know there are four slices</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span>, 
    row_title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"top_slice"</span>, <span class="st">"middle_top_slice"</span>, <span class="st">"middle_bottom_slice"</span>, <span class="st">"bottom_slice"</span><span class="op">)</span>,
    row_title_rot <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-57-1.png" width="672" style="display: block; margin: auto;"></div>
<p>If the length of <code>row_title</code> is specified as a single string, it will be like
a single title for all slices.</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span>, row_title <span class="op">=</span> <span class="st">"there are four slices"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-58-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>If you still want titles for each slice, but also a global title, you can do
as follows.</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span>, row_title <span class="op">=</span> <span class="st">"%s|%s"</span><span class="op">)</span>
<span class="co"># This row_title is actually a heatmap-list-level row title</span>
<span class="fu">draw</span><span class="op">(</span><span class="va">ht</span>, row_title <span class="op">=</span> <span class="st">"I am a row title"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-59-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>Actually the <code>row_title</code> used in <code>draw()</code> function is the row title of the
heatmap list (although in the example there is only one heatmap). The <code>draw()</code>
function and the heatmap list will be introduced in Chapter
<a href="a-list-of-heatmaps.html#a-list-of-heatmaps">4</a>.</p>
<p>If <code>row_title</code> is set to <code>NULL</code>, no row title is drawn.</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_split <span class="op">=</span> <span class="va">split</span>, row_title <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-60-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>All these rules also work for column titles for slices.</p>
</div>
<div id="graphic-parameters-for-splitting" class="section level3" number="2.7.6">
<h3>
<span class="header-section-number">2.7.6</span> Graphic parameters for splitting<a class="anchor" aria-label="anchor" href="#graphic-parameters-for-splitting"><i class="fas fa-link"></i></a>
</h3>
<p>When splitting is applied on rows/columns, graphic parameters for row/column
title and row/column names can be specified as same length as number of
slices.</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># by defalt, there no space on the top of the title, here we add 4pt to the top.</span>
<span class="co"># it can be reset by `ht_opt(RESET = TRUE)`</span>
<span class="va">ht_opt</span><span class="op">$</span><span class="va">TITLE_PADDING</span> <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"points"</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, 
    row_km <span class="op">=</span> <span class="fl">2</span>, 
    row_title_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span><span class="op">)</span>, font <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>,
    row_names_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"orange"</span><span class="op">)</span>, fontsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span>,
    column_km <span class="op">=</span> <span class="fl">3</span>, 
    column_title_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"green"</span><span class="op">)</span>, font <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,
    column_names_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"orange"</span>, <span class="st">"purple"</span><span class="op">)</span>, 
        fontsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">14</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/split_graphical_parameter-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
<div id="gaps-between-slices" class="section level3" number="2.7.7">
<h3>
<span class="header-section-number">2.7.7</span> Gaps between slices<a class="anchor" aria-label="anchor" href="#gaps-between-slices"><i class="fas fa-link"></i></a>
</h3>
<p>The space of gaps between row/column slices can be controlled by
<code>row_gap</code>/<code>column_gap</code>. The value can be a single unit or a vector of units.</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">3</span>, row_gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">5</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/split_gap-1.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">3</span>, row_gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/split_gap-2.png" width="499.2" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">3</span>, row_gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span>,
    column_km <span class="op">=</span> <span class="fl">3</span>, column_gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/split_gap-3.png" width="499.2" style="display: block; margin: auto;"></div>
<p>When heatmap border is added by setting <code>border = TRUE</code>, the border of every
slice is added.</p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">3</span>, border <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-62-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>If you set gap size to zero, the heatmap will look like it is partitioned by
vertical and horizontal lines.</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">3</span>, 
    row_gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"mm"</span><span class="op">)</span>, column_gap <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"mm"</span><span class="op">)</span>, border <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-63-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
<div id="split-heatmap-annotations" class="section level3" number="2.7.8">
<h3>
<span class="header-section-number">2.7.8</span> Split heatmap annotations<a class="anchor" aria-label="anchor" href="#split-heatmap-annotations"><i class="fas fa-link"></i></a>
</h3>
<p>When the heatmap is split, all the heatmap components are split accordingly.
Following gives you a simple example and the heatmap annotation will be
introduced in Chapter <a href="heatmap-annotations.html#heatmap-annotations">3</a>.</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">3</span>,
    top_annotation <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo1 <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">24</span>, bar1 <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo2 <span class="op">=</span> <span class="fl">18</span><span class="op">:</span><span class="fl">1</span>, bar2 <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">18</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-64-1.png" width="576" style="display: block; margin: auto;"></div>
</div>
</div>
<div id="heatmap-as-raster-image" class="section level2" number="2.8">
<h2>
<span class="header-section-number">2.8</span> Heatmap as raster image<a class="anchor" aria-label="anchor" href="#heatmap-as-raster-image"><i class="fas fa-link"></i></a>
</h2>
<p>When we produce so-called “high quality figures,” normally we save the figures
as <a href="https://en.wikipedia.org/wiki/Vector_graphics">vector graphics</a> in the
format of <em>e.g.</em> pdf or svg. The vector graphics basically store details of
every single graphic elements, thus, if a heatmap made from a very huge matrix is
saved as vector graphics, the final file size would be very big. On the other
hand, when visualizing <em>e.g.</em> the pdf file on the screen, multiple grids from
the heatmap actually only map to single pixels, due to the limited size of the
screen. Thus, there need some ways to effectively reduce the original image and
it is not necessary to store the complete matrix for the heatmap.</p>
<p>Rasterization is a way to covnert the vector graphics into a matrix of colors.
In this case, an image is represented as a matrix of RGB values, which is
called a <a href="https://en.wikipedia.org/wiki/Raster_graphics">raster image</a>. If the
heatmap is larger than the size of the screen or the pixels that current
graphics devices can support, we can convert the heatmap and reduce it, by
saving it in a form of a color matrix with the same dimension as on the device.</p>
<p>Let’s assume a matrix has <span class="math inline">\(n_r\)</span> rows and <span class="math inline">\(n_c\)</span> columns. When it is drawn on a
certain graphics device, <em>e.g.</em> an on-screen device, the corresponding heatmap
body has <span class="math inline">\(p_r\)</span> and <span class="math inline">\(p_c\)</span> pixels (or points) for the rows and columns,
respectively. When <span class="math inline">\(n_r &gt; p_r\)</span> and/or <span class="math inline">\(n_c &gt; p_c\)</span>, multiple values in the
matrix are mapped to single pixels. Here we need to reduce <span class="math inline">\(n_r\)</span> and/or <span class="math inline">\(n_c\)</span>
if they are larger than <span class="math inline">\(p_r\)</span> and/or <span class="math inline">\(p_c\)</span>.</p>
<p>To make it simple, I assume both <span class="math inline">\(n_r &gt; p_r\)</span> and <span class="math inline">\(n_c &gt; p_c\)</span>. The
principle is basically the same for the scenarios where only one dimension of
the matrix is larger than the device.</p>
<p>From <strong>ComplexHeatmap</strong> version 2.5.4, there are following three implementations for
image rasterization. Note the implementation is a little bit different from
the earlier versions (of course, better than the earlier versions).</p>
<ol style="list-style-type: decimal">
<li>
<p>First an image
(in a specific format, <em>e.g.</em> png or jpeg) with <span class="math inline">\((p_r \cdot a) \times (p_c \cdot a)\)</span> resolution is saved into a temporary file (e.g., by <code><a href="https://rdrr.io/r/grDevices/png.html">png()</a></code> or <code><a href="https://rdrr.io/r/grDevices/png.html">jpeg()</a></code>) where <span class="math inline">\(a\)</span> is a zooming
factor, next it is read back as a <code>raster</code> object by <em>e.g.</em>
<code><a href="https://rdrr.io/pkg/png/man/readPNG.html">png::readPNG()</a></code> or <code><a href="https://rdrr.io/pkg/jpeg/man/readJPEG.html">jpeg::readJPEG()</a></code>, and later the raster object is
filled into the heatmap body by <code><a href="https://rdrr.io/r/grid/grid.raster.html">grid::grid.raster()</a></code>. So we can say, the
rasterization is done by the raster image devices (<code><a href="https://rdrr.io/r/grDevices/png.html">png()</a></code> or <code><a href="https://rdrr.io/r/grDevices/png.html">jpeg()</a></code>).</p>
<p>This type of rasterization is automatically turned on (<strong>if magick package is
not installed</strong>) when the number of rows or columns exceeds 2000 (You will
see a message. It won’t happen silently). It can also be manually
controlled by setting the <code>use_raster</code> argument:</p>
</li>
</ol>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span>, use_raster <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>The zooming factor is controlled by <code>raster_quality</code> argument. A value larger
than 1 generates files with larger size.</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span>, use_raster <span class="op">=</span> <span class="cn">TRUE</span>, raster_quality <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>
<p>Simply reduce the original matrix to <span class="math inline">\(p_r \times p_c\)</span> where now each single values can
correspond to single pixels. In the reduction, a user-defined function is applied to summarize
the sub-matrices.</p>
<p>This can be set by <code>raster_resize_mat</code> argument:</p>
</li>
</ol>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># the default summary function is mean()</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span>, use_raster <span class="op">=</span> <span class="cn">TRUE</span>, raster_resize_mat <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># use max() as the summary function</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span>, use_raster <span class="op">=</span> <span class="cn">TRUE</span>, raster_resize_mat <span class="op">=</span> <span class="va">max</span><span class="op">)</span>
<span class="co"># randomly pick one</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span>, use_raster <span class="op">=</span> <span class="cn">TRUE</span>, raster_resize_mat <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>
<p>A temporary image with complete resolution <span class="math inline">\(n_r \times n_c\)</span> is first generated, here
<code><a href="https://docs.ropensci.org/magick/reference/transform.html">magick::image_resize()</a></code> is used to reduce the image to size <span class="math inline">\(p_r \times p_c\)</span>. Finally the reduced image is read as a <code>raster</code> object and filled into
the heatmap body. <strong>magick</strong> provides a lot of methods for
“resizing”/“scaling” the image, which is called the “filtering methods”
under the term of <strong>magick</strong>. <a href="https://www.imagemagick.org/Magick++/Enumerations.html#FilterTypes">All filtering
methods</a>
can be obtained by <code><a href="https://docs.ropensci.org/magick/reference/options.html">magick::filter_types()</a></code>.</p>
<p>This type of rasterization can be truned on by setting <code>raster_by_magick = TRUE</code>
and choosing a proper <code>raster_magick_filter</code>.</p>
</li>
</ol>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span>, use_raster <span class="op">=</span> <span class="cn">TRUE</span>, raster_by_magick <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span>, use_raster <span class="op">=</span> <span class="cn">TRUE</span>, raster_by_magick <span class="op">=</span> <span class="cn">TRUE</span>, raster_magick_filter <span class="op">=</span> <span class="va">...</span><span class="op">)</span></code></pre></div>
<p>The type of temporary image is controlled by <code>raster_device</code> argument. All supported
“raster devices” are: <code>png</code>, <code>CairoPNG</code>, <code>agg_png</code>, <code>jpeg</code>, <code>tiff</code>, <code>CairoJPEG</code> and
<code>CairoTIFF</code>. <code>CairoPNG</code> is taken as the default raster device (If <strong>Cairo</strong> package is installed) because the previously
default device <code>png</code> occasionally produces white vertical and horizontal lines in the
raster image.</p>
<p>In <strong>ComplexHeatmap</strong>, <code>use_raster</code> is by default turned on if the number of
rows or columns is more than 2000 in the matrix.</p>
<p>In the following parts of this section, we compare the visual difference
between different image rasterization methods. The following example is from <a href="https://gdevailly.netlify.app/post/plotting-big-matrices-in-r/">Guillaume Devailly’s simulated
data</a> but with
small adaptations. This example shows an enrichment pattern to the top center of the plot.</p>
<p>In the folowing examples, We won’t show the code for making heatmaps because
there are too many heatmaps and the specific settings is already written as the
row title of each heatmap. We set the same color mapping for all heatmaps, so
that you can see how different rasterizations change the original patterns.</p>
<p>For the comparison, we generated many heatmaps. They can be categoried into three groups, as corresponded to the
three rasterization methods mentioned previously.</p>
<ul>
<li>by <code><a href="https://rdrr.io/r/grDevices/png.html">png()</a></code>/<code>CairoPNG()</code>/<code>agg_png()</code>/<code><a href="https://rdrr.io/r/grDevices/png.html">jpeg()</a></code>: Rasterization method 1. First row in the following heatmaps.</li>
<li>
<code>raster_resize_mat = *</code>: Rasterization method 2, with different summary methods. Second row in the following heatmaps.</li>
<li>
<code>filter = *</code>: Rasterization method 3, with different filterring method. The string <code>filter</code>
should be <code>raster_magick_filter</code>. It is truncated so that the row title won’t be cut by the plot regions.</li>
</ul>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-70-1.png" width="100%" style="display: block; margin: auto auto auto 0;"></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-71-1.png" width="100%" style="display: block; margin: auto auto auto 0;"></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-72-1.png" width="100%" style="display: block; margin: auto auto auto 0;"></div>
<p>More examples on image rasteration can be found in this blog post: <a href="https://jokergoo.github.io/2020/06/30/rasterization-in-complexheatmap/">Rasterization in ComplexHeatmap</a>.</p>
<p>According to the examples that have been shown, we would say
rasterization by <strong>magick</strong> package performs better, thus, by default, in
<strong>ComplexHeatmap</strong>, the rasterization is done by <strong>magick</strong> (with <code>"Lanczos"</code>
as the default filter method) and if <strong>magick</strong> is not installed, it uses
<code>CairoPNG()</code> and a friendly message is printed to suggest users to install
<strong>magick</strong>.</p>
<p>Following example compares the PDF file size with raster images by different
raster devices.</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/GetoptLong">GetoptLong</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">mat2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">*</span><span class="fl">100</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html">pdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/GetoptLong/man/qq.html">qq</a></span><span class="op">(</span><span class="st">"heatmap_no_rasteration.pdf"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">8</span>, height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat2</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>, cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>, use_raster <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu">draw</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">all_devices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"png"</span>, <span class="st">"CairoPNG"</span>, <span class="st">"agg_png"</span>, <span class="st">"jpeg"</span>, <span class="st">"CairoJPEG"</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">device</span> <span class="kw">in</span> <span class="va">all_devices</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html">pdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/GetoptLong/man/qq.html">qq</a></span><span class="op">(</span><span class="st">"heatmap_@{device}.pdf"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">8</span>, height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>
    <span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat2</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>, cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>, use_raster <span class="op">=</span> <span class="cn">TRUE</span>, 
        raster_device <span class="op">=</span> <span class="va">device</span><span class="op">)</span>
    <span class="fu">draw</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_files</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GetoptLong/man/qq.html">qq</a></span><span class="op">(</span><span class="st">"heatmap_@{all_devices}.pdf"</span>, collapse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">all_files</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"heatmap_no_rasteration.pdf"</span>, <span class="va">all_files</span><span class="op">)</span>
<span class="va">fs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.info.html">file.size</a></span><span class="op">(</span><span class="va">all_files</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fs</span><span class="op">)</span> <span class="op">=</span> <span class="va">all_files</span>
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">fs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">1024</span><span class="op">)</span>, <span class="st">"KB"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## heatmap_no_rasteration.pdf            heatmap_png.pdf 
##                  "6394 KB"                   "175 KB" 
##       heatmap_CairoPNG.pdf        heatmap_agg_png.pdf 
##                   "177 KB"                   "308 KB" 
##           heatmap_jpeg.pdf      heatmap_CairoJPEG.pdf 
##                   "667 KB"                   "677 KB"</code></pre>
<p>We can see <code>png</code>-family methods generate smaller file size.</p>
</div>
<div id="customize-the-heatmap-body" class="section level2" number="2.9">
<h2>
<span class="header-section-number">2.9</span> Customize the heatmap body<a class="anchor" aria-label="anchor" href="#customize-the-heatmap-body"><i class="fas fa-link"></i></a>
</h2>
<p>The heatmap body can be self-defined to add more types of graphics. By default
the heatmap body is composed by a matrix of small rectangles (it might be
called grids in other parts of this documentation, but let’s call it “<em>cells</em>”
here) with different filled colors. However, it is also possible to add more
graphics or symbols as additional layers on the heatmap. There are two
arguments <code>cell_fun</code> and <code>layer_fun</code> which both should be user-defined
functions.</p>
<p>In later chapter, we will introduce OncoPrint (Chapter <a href="oncoprint.html#oncoprint">7</a>), UpSet plot (Chapter <a href="upset-plot.html#upset-plot">8</a>)
and 3D heatmap (Chapter <a href="three-d-heatmap.html#three-d-heatmap">12</a>). They are all implemented with <code>cell_fun</code>/<code>layer_fun</code>.</p>
<div id="cell-fun" class="section level3" number="2.9.1">
<h3>
<span class="header-section-number">2.9.1</span> cell_fun<a class="anchor" aria-label="anchor" href="#cell-fun"><i class="fas fa-link"></i></a>
</h3>
<p><code>cell_fun</code> draws in each cell repeatedly, which is internally executed in two
nested <code>for</code> loops, while <code>layer_fun</code> is the vectorized version of <code>cell_fun</code>.
<code>cell_fun</code> is easier to understand but <code>layer_fun</code> is much faster to execute
and more customizable.</p>
<p><code>cell_fun</code> expects a function with 7 arguments (the argument names can be
different from following, but the order must be the same), which are:</p>
<ul>
<li>
<code>j</code>: column index in the matrix. Column index corresponds to the x-direction
in the viewport, that’s why <code>j</code> is put as the first argument.</li>
<li>
<code>i</code>: row index in the matrix.</li>
<li>
<code>x</code>: x coordinate of middle point of the cell which is measured in the
viewport of the heatmap body.</li>
<li>
<code>y</code>: y coordinate of middle point of the cell which is measured in the
viewport of the heatmap body.</li>
<li>
<code>width</code>: width of the cell. The value is <code>unit(1/ncol(sub_mat), "npc")</code>
where <code>sub_mat</code> correspond to the sub-matrix by row splitting and column
splitting.</li>
<li>
<code>height</code>: height of the cell. The value is <code>unit(1/nrow(sub_mat), "npc")</code>.</li>
<li>
<code>fill</code>: color of the cell.</li>
</ul>
<p>The values for the seven arguments are automatically sent to the function when
executed in each cell.</p>
<p>The most common use is to add values in the matrix onto the heatmap:</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">small_mat</span> <span class="op">=</span> <span class="va">mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span>
<span class="va">col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>,
    cell_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">width</span>, <span class="va">height</span>, <span class="va">fill</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu">grid.text</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.1f"</span>, <span class="va">small_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span>, <span class="va">x</span>, <span class="va">y</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-76-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>and we can also choose only to add text for the cells with positive values:</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>,  col <span class="op">=</span> <span class="va">col_fun</span>,
    cell_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">width</span>, <span class="va">height</span>, <span class="va">fill</span><span class="op">)</span> <span class="op">{</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">small_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>
            <span class="fu">grid.text</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.1f"</span>, <span class="va">small_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span>, <span class="va">x</span>, <span class="va">y</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-77-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>You can split the heatmap without doing anything extra to <code>cell_fun</code>:</p>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>,
    row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">2</span>,
    cell_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">width</span>, <span class="va">height</span>, <span class="va">fill</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu">grid.text</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.1f"</span>, <span class="va">small_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span>, <span class="va">x</span>, <span class="va">y</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-78-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>In following example, we make a heatmap which shows correlation matrix similar
as the <strong>corrplot</strong> package:</p>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cor_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">small_mat</span><span class="op">)</span>
<span class="va">od</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="va">cor_mat</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">order</span>
<span class="va">cor_mat</span> <span class="op">=</span> <span class="va">cor_mat</span><span class="op">[</span><span class="va">od</span>, <span class="va">od</span><span class="op">]</span>
<span class="va">nm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">cor_mat</span><span class="op">)</span>
<span class="va">col_fun</span> <span class="op">=</span> <span class="fu">circlize</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># `col = col_fun` here is used to generate the legend</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">cor_mat</span>, name <span class="op">=</span> <span class="st">"correlation"</span>, col <span class="op">=</span> <span class="va">col_fun</span>, rect_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>, 
    cell_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">width</span>, <span class="va">height</span>, <span class="va">fill</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu">grid.rect</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, width <span class="op">=</span> <span class="va">width</span>, height <span class="op">=</span> <span class="va">height</span>, 
            gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"grey"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="va">j</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu">grid.text</span><span class="op">(</span><span class="va">nm</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op">&gt;</span> <span class="va">j</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu">grid.circle</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">cor_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu">unit.c</span><span class="op">(</span><span class="va">width</span>, <span class="va">height</span><span class="op">)</span><span class="op">)</span>, 
                gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">col_fun</span><span class="op">(</span><span class="va">cor_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
            <span class="fu">grid.text</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.1f"</span>, <span class="va">cor_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span>, <span class="va">x</span>, <span class="va">y</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
        <span class="op">}</span>
    <span class="op">}</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>, cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>,
    show_row_names <span class="op">=</span> <span class="cn">FALSE</span>, show_column_names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/cell_fun-1.png" width="624" style="display: block; margin: auto;"></div>
<p>As you may see in previous plot, when setting the non-standard parameter
<code>rect_gp = gpar(type = "none")</code>, the clustering is performed but nothing is
drawn on the heatmap body.</p>
<p>One last example is to visualize a <a href="https://en.wikipedia.org/wiki/Go_%28game%29">GO
game</a>. The input data takes
records of moves in the game.</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">str</span> <span class="op">=</span> <span class="st">[1615 chars quoted with '"']</span></code></pre></div>
<p>We convert it into a matrix:</p>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">str</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"\\n"</span>, <span class="st">""</span>, <span class="va">str</span><span class="op">)</span>
<span class="va">step</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">str</span>, <span class="st">";"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="va">type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"(B|W).*"</span>, <span class="st">"\\1"</span>, <span class="va">step</span><span class="op">)</span>
<span class="va">row</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"(B|W)\\[(.).\\]"</span>, <span class="st">"\\2"</span>, <span class="va">step</span><span class="op">)</span>
<span class="va">column</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"(B|W)\\[.(.)\\]"</span>, <span class="st">"\\2"</span>, <span class="va">step</span><span class="op">)</span>

<span class="va">go_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">19</span>, ncol <span class="op">=</span> <span class="fl">19</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">go_mat</span><span class="op">)</span> <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">19</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">go_mat</span><span class="op">)</span> <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">19</span><span class="op">]</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">row</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">go_mat</span><span class="op">[</span><span class="va">row</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">column</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">type</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="op">}</span>
<span class="va">go_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></code></pre></div>
<pre><code>##   a   b   c   d  
## a NA  NA  NA  "W"
## b "W" "W" "W" "B"
## c "B" "B" "W" "W"
## d "B" "W" "B" "W"</code></pre>
<p>Black and white stones are put based on the values in the matrix:</p>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">go_mat</span>, name <span class="op">=</span> <span class="st">"go"</span>, rect_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>,
    cell_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">w</span>, <span class="va">h</span>, <span class="va">col</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu">grid.rect</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">w</span>, <span class="va">h</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#dcb35c"</span>, col <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu">grid.segments</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">-</span><span class="va">h</span><span class="op">*</span><span class="fl">0.5</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">go_mat</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu">grid.segments</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">+</span><span class="va">h</span><span class="op">*</span><span class="fl">0.5</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
            <span class="fu">grid.segments</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">-</span><span class="va">h</span><span class="op">*</span><span class="fl">0.5</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">+</span><span class="va">h</span><span class="op">*</span><span class="fl">0.5</span><span class="op">)</span>
        <span class="op">}</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">j</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu">grid.segments</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">x</span><span class="op">+</span><span class="va">w</span><span class="op">*</span><span class="fl">0.5</span>, <span class="va">y</span><span class="op">)</span>        
        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">j</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">go_mat</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu">grid.segments</span><span class="op">(</span><span class="va">x</span><span class="op">-</span><span class="va">w</span><span class="op">*</span><span class="fl">0.5</span>, <span class="va">y</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
            <span class="fu">grid.segments</span><span class="op">(</span><span class="va">x</span><span class="op">-</span><span class="va">w</span><span class="op">*</span><span class="fl">0.5</span>, <span class="va">y</span>, <span class="va">x</span><span class="op">+</span><span class="va">w</span><span class="op">*</span><span class="fl">0.5</span>, <span class="va">y</span><span class="op">)</span>
        <span class="op">}</span>

        <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">10</span>, <span class="fl">16</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">j</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">10</span>, <span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu">grid.points</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, pch <span class="op">=</span> <span class="fl">16</span>, size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">2</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span>
        <span class="op">}</span>
                
        <span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu">unit.c</span><span class="op">(</span><span class="va">w</span>, <span class="va">h</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fl">0.45</span>
        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">go_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">go_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">==</span> <span class="st">"W"</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu">grid.circle</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">r</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, col <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">go_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">==</span> <span class="st">"B"</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu">grid.circle</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">r</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"black"</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span>
        <span class="op">}</span>
    <span class="op">}</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B"</span> <span class="op">=</span> <span class="st">"black"</span>, <span class="st">"W"</span> <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span>,
    show_row_names <span class="op">=</span> <span class="cn">FALSE</span>, show_column_names <span class="op">=</span> <span class="cn">FALSE</span>,
    column_title <span class="op">=</span> <span class="st">"One famous GO game"</span>,
    show_heatmap_legend <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="va">lgd</span> <span class="op">=</span> <span class="fu">Legend</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Players"</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"player1"</span>, <span class="st">"player2"</span><span class="op">)</span>,
    type <span class="op">=</span> <span class="st">"points"</span>, legend_gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"white"</span><span class="op">)</span><span class="op">)</span>,
    size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.45</span>, <span class="st">"snpc"</span><span class="op">)</span>, background <span class="op">=</span> <span class="st">"#dcb35c"</span><span class="op">)</span>
<span class="fu">draw</span><span class="op">(</span><span class="va">ht</span>, heatmap_legend_list <span class="op">=</span> <span class="va">lgd</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-82-1.png" width="576" style="display: block; margin: auto;"></div>
<p>In the Go game example, we actually self-defined a legend. This will be introduced in Section <a href="legends.html#legends">5</a> in more details.</p>
</div>
<div id="layer-fun" class="section level3" number="2.9.2">
<h3>
<span class="header-section-number">2.9.2</span> layer_fun<a class="anchor" aria-label="anchor" href="#layer-fun"><i class="fas fa-link"></i></a>
</h3>
<p>If you tried out the previous code for the Go game, you might see the generation of
the plot is a little bit slow that fragments in the plot come one after other other.
This is because <code>cell_fun</code> is applied in every cell separately. In this section,
we will introduce <code>layer_fun</code> which is a vectorized version of <code>cell_fun</code>.</p>
<p><code>cell_fun</code> adds graphics cell by cell, while <code>layer_fun</code> adds graphics in a
block-wise manner. Similar as <code>cell_fun</code>, <code>layer_fun</code> also needs seven
arguments, but they are all in vector form (<code>layer_fun</code> can also have a eighth and
ninth arguments which is introduced later in this section):</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span>, layer_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">w</span>, <span class="va">h</span>, <span class="va">fill</span><span class="op">)</span> <span class="op">{</span><span class="va">...</span><span class="op">}</span><span class="op">)</span>
<span class="co"># or you can capitalize the arguments to mark they are vectors,</span>
<span class="co"># the names of the argument do not matter</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span>, layer_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">J</span>, <span class="va">I</span>, <span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">H</span>, <span class="va">F</span><span class="op">)</span> <span class="op">{</span><span class="va">...</span><span class="op">}</span><span class="op">)</span></code></pre></div>
<p><code>j</code> and <code>i</code> still contain the column and row indices corresponding to the
original matrix, but since now <code>layer_fun</code> is applied to a heatmap slice which
contains a block of cells, <code>j</code> and <code>i</code> are vectors for all the cells in the
current heatmap slice. Similarlly, <code>x</code>, <code>y</code>, <code>w</code>, <code>h</code> and <code>fill</code> are all vectors
corresponding to all cells in the current heatmap slice.</p>
<p>Since <code>j</code> and <code>i</code> now are vectors, to get corresponding values in the matrix, we
cannot use the form as <code>mat[j, i]</code> because it gives you a sub-matrix with
<code>length(i)</code> rows and <code>length(j)</code> columns. Instead we can use <code>pindex()</code>
function from <strong>ComplexHeatmap</strong> which is like pairwise indexing for a matrix.
See follow example:</p>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mfoo</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span>, nr <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="va">mfoo</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]    1    7
## [2,]    2    8</code></pre>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># but we actually want mfoo[1, 1] and mfoo[2, 3]</span>
<span class="fu">pindex</span><span class="op">(</span><span class="va">mfoo</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 1 8</code></pre>
<p>Next example shows the <code>layer_fun</code> version of adding text on heatmap. It’s
basically the same as the <code>cell_fun</code> version.</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>,
    layer_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">width</span>, <span class="va">height</span>, <span class="va">fill</span><span class="op">)</span> <span class="op">{</span>
        <span class="co"># since grid.text can also be vectorized</span>
        <span class="fu">grid.text</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.1f"</span>, <span class="fu">pindex</span><span class="op">(</span><span class="va">small_mat</span>, <span class="va">i</span>, <span class="va">j</span><span class="op">)</span><span class="op">)</span>, <span class="va">x</span>, <span class="va">y</span>, 
            gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-85-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>And only add text to cells with positive values:</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>, 
    layer_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">width</span>, <span class="va">height</span>, <span class="va">fill</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">v</span> <span class="op">=</span> <span class="fu">pindex</span><span class="op">(</span><span class="va">small_mat</span>, <span class="va">i</span>, <span class="va">j</span><span class="op">)</span>
        <span class="va">l</span> <span class="op">=</span> <span class="va">v</span> <span class="op">&gt;</span> <span class="fl">0</span>
        <span class="fu">grid.text</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.1f"</span>, <span class="va">v</span><span class="op">[</span><span class="va">l</span><span class="op">]</span><span class="op">)</span>, <span class="va">x</span><span class="op">[</span><span class="va">l</span><span class="op">]</span>, <span class="va">y</span><span class="op">[</span><span class="va">l</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-86-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>When the heatmap is split, <code>layer_fun</code> is applied in every slice.</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>,
    row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">2</span>,
    layer_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">width</span>, <span class="va">height</span>, <span class="va">fill</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">v</span> <span class="op">=</span> <span class="fu">pindex</span><span class="op">(</span><span class="va">small_mat</span>, <span class="va">i</span>, <span class="va">j</span><span class="op">)</span>
        <span class="fu">grid.text</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.1f"</span>, <span class="va">v</span><span class="op">)</span>, <span class="va">x</span>, <span class="va">y</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">v</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu">grid.rect</span><span class="op">(</span>gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">2</span>, fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span><span class="op">)</span>
        <span class="op">}</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-87-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p><code>layer_fun</code> can also have two more arguments which are the index for the
current row slice and column slice. E.g. we want to add borders for the top
right and bottom left slices.</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>,
    row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">2</span>,
    layer_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">width</span>, <span class="va">height</span>, <span class="va">fill</span>, <span class="va">slice_r</span>, <span class="va">slice_c</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">v</span> <span class="op">=</span> <span class="fu">pindex</span><span class="op">(</span><span class="va">small_mat</span>, <span class="va">i</span>, <span class="va">j</span><span class="op">)</span>
        <span class="fu">grid.text</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.1f"</span>, <span class="va">v</span><span class="op">)</span>, <span class="va">x</span>, <span class="va">y</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">slice_r</span> <span class="op">!=</span> <span class="va">slice_c</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu">grid.rect</span><span class="op">(</span>gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">2</span>, fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span><span class="op">)</span>
        <span class="op">}</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-88-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The advantage of <code>layer_fun</code> is that it is not only fast to add graphics, but
also it provides more possibilities to customize the heatmap, e.g. you can
interact between cells in a heatmap slice. Consider following visualization: For
each row in the heatmap, if values in the neighbouring two columns have the same
sign, we add a red line or a green line depending on the sign of the two values.
Since now graphics in a cell depend on other cells, it is only possible to
implement it via <code>layer_fun</code>. (Don’t be frightened by following code. They are
explained after the code.)</p>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>,
    row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">2</span>,
    layer_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">w</span>, <span class="va">h</span>, <span class="va">fill</span><span class="op">)</span> <span class="op">{</span>
        <span class="co"># restore_matrix() is explained after this chunk of code</span>
        <span class="va">ind_mat</span> <span class="op">=</span> <span class="fu">restore_matrix</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
        <span class="kw">for</span><span class="op">(</span><span class="va">ir</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">ind_mat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
            <span class="co"># start from the second column</span>
            <span class="kw">for</span><span class="op">(</span><span class="va">ic</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ind_mat</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span>
                <span class="va">ind1</span> <span class="op">=</span> <span class="va">ind_mat</span><span class="op">[</span><span class="va">ir</span>, <span class="va">ic</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="co"># previous column</span>
                <span class="va">ind2</span> <span class="op">=</span> <span class="va">ind_mat</span><span class="op">[</span><span class="va">ir</span>, <span class="va">ic</span><span class="op">]</span>   <span class="co"># current column</span>
                <span class="va">v1</span> <span class="op">=</span> <span class="va">small_mat</span><span class="op">[</span><span class="va">i</span><span class="op">[</span><span class="va">ind1</span><span class="op">]</span>, <span class="va">j</span><span class="op">[</span><span class="va">ind1</span><span class="op">]</span><span class="op">]</span>
                <span class="va">v2</span> <span class="op">=</span> <span class="va">small_mat</span><span class="op">[</span><span class="va">i</span><span class="op">[</span><span class="va">ind2</span><span class="op">]</span>, <span class="va">j</span><span class="op">[</span><span class="va">ind2</span><span class="op">]</span><span class="op">]</span>
                <span class="kw">if</span><span class="op">(</span><span class="va">v1</span> <span class="op">*</span> <span class="va">v2</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span> <span class="co"># if they have the same sign</span>
                    <span class="va">col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">v1</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"darkred"</span>, <span class="st">"darkgreen"</span><span class="op">)</span>
                    <span class="fu">grid.segments</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">ind1</span><span class="op">]</span>, <span class="va">y</span><span class="op">[</span><span class="va">ind1</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="va">ind2</span><span class="op">]</span>, <span class="va">y</span><span class="op">[</span><span class="va">ind2</span><span class="op">]</span>,
                        gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="va">col</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
                    <span class="fu">grid.points</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ind1</span>, <span class="va">ind2</span><span class="op">)</span><span class="op">]</span>, <span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ind1</span>, <span class="va">ind2</span><span class="op">)</span><span class="op">]</span>, 
                        pch <span class="op">=</span> <span class="fl">16</span>, gp <span class="op">=</span> <span class="fu">gpar</span><span class="op">(</span>col <span class="op">=</span> <span class="va">col</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span>
                <span class="op">}</span>
            <span class="op">}</span>
        <span class="op">}</span>
    <span class="op">}</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-89-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The values that are sent to <code>layer_fun</code> are all vectors (for the vectorization
of the <strong>grid</strong> graphics functions), however, the heatmap slice where
<code>layer_fun</code> is applied to, is still represented by a matrix, thus, it would be
very convinient if all the arguments in <code>layer_fun</code> can be converted to the
sub-matrix for the current slice. Here, as shown in above example,
<code>restore_matrix()</code> does the job. <code>restore_matrix()</code> directly accepts the first
four argument in <code>layer_fun</code> and returns an index matrix, where rows and
columns correspond to the rows and columns in the current slice, from top to
bottom and from left to right. The values in the matrix are the natural order
of e.g. vector <code>j</code> in current slice.</p>
<p>If you run following code:</p>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>,
    row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">2</span>,
    layer_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">w</span>, <span class="va">h</span>, <span class="va">fill</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">ind_mat</span> <span class="op">=</span> <span class="fu">restore_matrix</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ind_mat</span><span class="op">)</span>
    <span class="op">}</span>
<span class="op">)</span></code></pre></div>
<p>The first output which is for the top-left slice:</p>
<pre><code>     [,1] [,2] [,3] [,4] [,5]
[1,]    1    4    7   10   13
[2,]    2    5    8   11   14
[3,]    3    6    9   12   15</code></pre>
<p>As you see, this is a three-row and five-column index matrix where the first
row corresponds to the top row in the slice. The values in the matrix
correspond to the natural index (i.e. 1, 2, …) in <code>j</code>, <code>i</code>, <code>x</code>, <code>y</code>,
… in <code>layer_fun</code>. Now, if we want to add values on the second column in the
top-left slice, the code which is put inside <code>layer_fun</code> would look like:</p>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span><span class="op">(</span><span class="va">ind</span> <span class="kw">in</span> <span class="va">ind_mat</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">grid.text</span><span class="op">(</span><span class="va">small_mat</span><span class="op">[</span><span class="va">i</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>, <span class="va">j</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>, <span class="va">y</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>, <span class="va">...</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Now it is easier to understand the second example: we want to add points to
the second row and the third column in every slice:</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, col <span class="op">=</span> <span class="va">col_fun</span>,
    row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">2</span>,
    layer_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">w</span>, <span class="va">h</span>, <span class="va">fill</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">ind_mat</span> <span class="op">=</span> <span class="fu">restore_matrix</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
        <span class="va">ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ind_mat</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span>, <span class="va">ind_mat</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
        <span class="fu">grid.points</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>, <span class="va">y</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">16</span>, size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">4</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-92-1.png" width="499.2" style="display: block; margin: auto;"></div>
</div>
</div>
<div id="size-of-the-heatmap" class="section level2" number="2.10">
<h2>
<span class="header-section-number">2.10</span> Size of the heatmap<a class="anchor" aria-label="anchor" href="#size-of-the-heatmap"><i class="fas fa-link"></i></a>
</h2>
<p><code>width</code>, <code>heatmap_width</code>, <code>height</code> and <code>heatmap_height</code> control the size of
the heatmap. By default, all heatmap components have fixed width or height,
e.g. the width of row dendrogram is <code>1cm</code>. The width or the height of the
heatmap body fill the rest area of the final plotting region, which means, if
you draw it in an interactive graphic window and you change the size of the
window by draging it, the size of the heatmap body is automatically adjusted.</p>
<p><code>heatmap_width</code> and <code>heatmap_height</code> control <strong>the width/height of the complete
heatmap including all heatmap components (excluding the legends)</strong> while <code>width</code>
and <code>height</code> only <strong>control the width/height of the heamtap body</strong>. All these four
arguments can be set as absolute units.</p>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">8</span>, <span class="st">"cm"</span><span class="op">)</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">8</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-93-1.png" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, heatmap_width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">8</span>, <span class="st">"cm"</span><span class="op">)</span>, 
    heatmap_height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">8</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-93-2.png" width="672" style="display: block; margin: auto;"></div>
<p>These four arguments are more important when adjust the size in a list of
heatmaps (see Section
<a href="a-list-of-heatmaps.html#size-of-heatmaps">4.2</a>).</p>
<p>When the size of the heatmap is set as absolute units, it is possible that the
size of the figure is larger than the size of the heatmap, which gives blank
areas around the heatmap. The size of the heatmap can be retrieved by <code>ComplexHeatmap:::width()</code>
and <code>ComplexHeatmap:::height()</code> functions.</p>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">8</span>, <span class="st">"cm"</span><span class="op">)</span>, height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">8</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">draw</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span> <span class="co"># you must call draw() to reassign the heatmap variable</span>
<span class="fu">ComplexHeatmap</span><span class="fu">:::</span><span class="fu">width</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 118.851591171994mm</code></pre>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ComplexHeatmap</span><span class="fu">:::</span><span class="fu">height</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 114.717557838661mm</code></pre>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, heatmap_width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">8</span>, <span class="st">"cm"</span><span class="op">)</span>, 
    heatmap_height <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">8</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">draw</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span>
<span class="fu">ComplexHeatmap</span><span class="fu">:::</span><span class="fu">width</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 94.8877245053272mm</code></pre>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ComplexHeatmap</span><span class="fu">:::</span><span class="fu">height</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 83.8660578386606mm</code></pre>
<p>Check this blog post (<a href="https://jokergoo.github.io/2020/05/11/set-cell-width/height-in-the-heatmap/">Set cell width/height in the heatmap</a>) if you want to save the heatmap in a figure file which
has exactly the same size as the heatmap.</p>
</div>
<div id="plot-the-heatmap" class="section level2" number="2.11">
<h2>
<span class="header-section-number">2.11</span> Plot the heatmap<a class="anchor" aria-label="anchor" href="#plot-the-heatmap"><i class="fas fa-link"></i></a>
</h2>
<p><code>Heatmap()</code> function actually is only a constructor, which means it only puts
all the data and configurations into the object in the <code>Heatmap</code> class. The
clustering will only be performed when the <code>draw()</code> method is called. Under
interactive mode (e.g. the interactive R terminal where you can type your R
code line by line), directly calling <code>Heatmap()</code> without assigning to any
object prints the object and the print method (or the S4 <code>show()</code> method) for
the <code>Heatmap</code> class object calls <code>draw()</code> internally. So if you type
<code>Heatmap(...)</code> in your R terminal, it looks like it is a plotting function
like <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code>, you need to be aware of that it is actually not true and in the
following cases you might see nothing plotted.</p>
<ul>
<li>you put <code>Heatmap(...)</code> inside a function,</li>
<li>you put <code>Heatmap(...)</code> in a code chunk like <code>for</code> or <code>if-else</code>
</li>
<li>you put <code>Heatmap(...)</code> in an Rscript and you run it under command line.</li>
</ul>
<p>The reason is in above three cases, the <code>show()</code> method WILL NOT be called and
thus <code>draw()</code> method is not executed either. So, to make the plot, you need to
call <code>draw()</code> explicitly: <code>draw(Heatmap(...))</code> or:</p>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
<span class="fu">draw</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span></code></pre></div>
<p>The <code>draw()</code> function actually is applied to a list of heatmaps in
<code>HeatmapList</code> class. The <code>draw()</code> method for the single <code>Heatmap</code> class
constructs a <code>HeatmapList</code> with only one heatmap and call <code>draw()</code> method of
the <code>HeatmapList</code> class. The <code>draw()</code> function accpets a lot of more arguments
which e.g. control the legends. It will be discussed in Chapter
<a href="a-list-of-heatmaps.html#a-list-of-heatmaps">4</a>.</p>
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">draw</span><span class="op">(</span><span class="va">ht</span>, <span class="va">heatmap_legend_side</span>, <span class="va">padding</span>, <span class="va">...</span><span class="op">)</span></code></pre></div>
</div>
<div id="get-orders-and-dendrograms-from-heatmap" class="section level2" number="2.12">
<h2>
<span class="header-section-number">2.12</span> Extract orders and dendrograms<a class="anchor" aria-label="anchor" href="#get-orders-and-dendrograms-from-heatmap"><i class="fas fa-link"></i></a>
</h2>
<p>The row/column orders of the heatmap can be obtained by
<code>row_order()</code>/<code>column_order()</code> functions. You can directly apply to the
heatmap object returned by <code>Heatmap()</code> or to the object returned by <code>draw()</code>.
In following, we take <code>row_order()</code> as example.</p>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">small_mat</span> <span class="op">=</span> <span class="va">mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span>
<span class="va">ht1</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span><span class="op">)</span>
<span class="fu">row_order</span><span class="op">(</span><span class="va">ht1</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 5 7 2 4 9 6 8 1 3</code></pre>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht2</span> <span class="op">=</span> <span class="fu">draw</span><span class="op">(</span><span class="va">ht1</span><span class="op">)</span>
<span class="fu">row_order</span><span class="op">(</span><span class="va">ht2</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 5 7 2 4 9 6 8 1 3</code></pre>
<p>As explained in previous section, <code>Heatmap()</code> function does not perform
clustering, thus, when directly apply <code>row_order()</code> on <code>ht1</code>, clustering will
be first performed. Later when making the heatmap by <code>draw(ht1)</code>, the
clustering will be applied again. This might be a problem that if you set
k-means clustering in the heatmap. Since the clustering is applied twice,
k-means might give you different clusterings, which means, you might have
different results from <code>row_order()</code> and you might have different heatmap.</p>
<p>In following chunk of code, <code>o1</code>, <code>o2</code> and <code>o3</code> might be different because
each time, k-means clustering is performed.</p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">ht1</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, row_km <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">o1</span> <span class="op">=</span> <span class="fu">row_order</span><span class="op">(</span><span class="va">ht1</span><span class="op">)</span>
<span class="va">o2</span> <span class="op">=</span> <span class="fu">row_order</span><span class="op">(</span><span class="va">ht1</span><span class="op">)</span>
<span class="va">ht2</span> <span class="op">=</span> <span class="fu">draw</span><span class="op">(</span><span class="va">ht1</span><span class="op">)</span>
<span class="va">o3</span> <span class="op">=</span> <span class="fu">row_order</span><span class="op">(</span><span class="va">ht2</span><span class="op">)</span>
<span class="va">o4</span> <span class="op">=</span> <span class="fu">row_order</span><span class="op">(</span><span class="va">ht2</span><span class="op">)</span></code></pre></div>
<p><code>draw()</code> function returns the heatmap (or more precisely, the heatmap list)
which has already been reordered, and applying <code>row_order()</code> just extracts the
row order from the object, which ensures the row order is exactly the same as
the one shown in the heatmap. In above code, <code>o3</code> is always identical to <code>o4</code>.</p>
<p>So, the preferable way to get row/column orders is as follows.</p>
<div class="sourceCode" id="cb157"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># code only for demonstration</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">draw</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span>
<span class="fu">row_order</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span>
<span class="fu">column_order</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span></code></pre></div>
<p>If rows/columns are split, row order or column order will be a list.</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">draw</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span>
<span class="fu">row_order</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span></code></pre></div>
<pre><code>## $`2`
## [1] 5 7 2 4
## 
## $`1`
## [1] 9 6 8 1 3</code></pre>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">column_order</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span></code></pre></div>
<pre><code>## $`1`
## [1] 6 2 7
## 
## $`3`
## [1] 1 3 4 5
## 
## $`2`
## [1] 8 9</code></pre>
<p>Similarly, the <code>row_dend()</code>/<code>column_dend()</code> functions return the dendrograms.
It returns a single dendrogram or a list of dendrograms depending on whether
the heatmap is split.</p>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">small_mat</span>, row_km <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">ht</span> <span class="op">=</span> <span class="fu">draw</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span>
<span class="fu">row_dend</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span></code></pre></div>
<pre><code>## $`2`
## 'dendrogram' with 2 branches and 4 members total, at height 2.946428 
## 
## $`1`
## 'dendrogram' with 2 branches and 5 members total, at height 2.681351</code></pre>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">column_dend</span><span class="op">(</span><span class="va">ht</span><span class="op">)</span></code></pre></div>
<pre><code>## 'dendrogram' with 2 branches and 9 members total, at height 4.574114</code></pre>
<p><code>row_order()</code>, <code>column_order()</code>, <code>row_dend()</code> and <code>column_dend()</code> also work
for a list of heatmaps, it will be introduced in Section
<a href="a-list-of-heatmaps.html#get-orders-and-dendrograms-from-a-list-of-heatmaps">4.12</a>.</p>
</div>
<div id="subset-a-heatmap" class="section level2" number="2.13">
<h2>
<span class="header-section-number">2.13</span> Subset a heatmap<a class="anchor" aria-label="anchor" href="#subset-a-heatmap"><i class="fas fa-link"></i></a>
</h2>
<p>Since heatmap is a representation of a matrix, there is also a subset method
for the <code>Heatmap</code> class.</p>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">ht</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 18 24</code></pre>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-102-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p>The annotations are subsetted accordingly as well.</p>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">3</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>,
    top_annotation <span class="op">=</span> <span class="fu">HeatmapAnnotation</span><span class="op">(</span>foo1 <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">24</span>, bar1 <span class="op">=</span> <span class="fu">anno_points</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    right_annotation <span class="op">=</span> <span class="fu">rowAnnotation</span><span class="op">(</span>foo2 <span class="op">=</span> <span class="fl">18</span><span class="op">:</span><span class="fl">1</span>, bar2 <span class="op">=</span> <span class="fu">anno_barplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">18</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">ht</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">*</span><span class="fl">2</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">*</span><span class="fl">2</span><span class="op">]</span> <span class="co"># odd rows, even columns</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-103-1.png" width="672" style="display: block; margin: auto;"></div>
<p>The heatmap components are subsetted if they are vector-like. Some
configurations in the heatmap keep the same when subsetting, e.g. if <code>row_km</code>
is set in the original heatmap, the configuration of k-means is kept and it is
performed in the sub-heatmap. So in following example, k-means clustering is
only performed when making heatmap for <code>ht2</code>.</p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ht</span> <span class="op">=</span> <span class="fu">Heatmap</span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"mat"</span>, row_km <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">ht2</span> <span class="op">=</span> <span class="va">ht</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>
<span class="va">ht2</span></code></pre></div>
<div class="inline-figure"><img src="02-single_heatmap_files/figure-html/unnamed-chunk-104-1.png" width="499.2" style="display: block; margin: auto;"></div>
<p><strong>The implementation of subsetting heatmaps is very experimental.</strong> It is not
always working, e.g. if <code>cell_fun</code> is defined and uses an external matrix, or
clustering objects are assigned to <code>cluster_rows</code> or <code>cluster_columns</code>.</p>
<p>There are also subset methods for the <code>HeatmapAnnotation</code> class (Section
<a href="heatmap-annotations.html#heatmap-annotation-utility-function">3.22</a>) and the <code>HeatmapList</code> class (Section <a href="a-list-of-heatmaps.html#subset-heatmap-list">4.10</a>),
but both are very experimental as well.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="introduction.html"><span class="header-section-number">1</span> Introduction</a></div>
<div class="next"><a href="heatmap-annotations.html"><span class="header-section-number">3</span> Heatmap Annotations</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#a-single-heatmap"><span class="header-section-number">2</span> A Single Heatmap</a></li>
<li><a class="nav-link" href="#colors"><span class="header-section-number">2.1</span> Colors</a></li>
<li><a class="nav-link" href="#heatmap-titles"><span class="header-section-number">2.2</span> Titles</a></li>
<li>
<a class="nav-link" href="#clustering"><span class="header-section-number">2.3</span> Clustering</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#distance-methods"><span class="header-section-number">2.3.1</span> Distance methods</a></li>
<li><a class="nav-link" href="#clustering-methods"><span class="header-section-number">2.3.2</span> Clustering methods</a></li>
<li><a class="nav-link" href="#render-dendrograms"><span class="header-section-number">2.3.3</span> Render dendrograms</a></li>
<li><a class="nav-link" href="#reorder-dendrograms"><span class="header-section-number">2.3.4</span> Reorder dendrograms</a></li>
</ul>
</li>
<li><a class="nav-link" href="#row-and_column_orders"><span class="header-section-number">2.4</span> Set row and column orders</a></li>
<li><a class="nav-link" href="#heatmap-seriation"><span class="header-section-number">2.5</span> Seriation</a></li>
<li><a class="nav-link" href="#dimension-names"><span class="header-section-number">2.6</span> Dimension labels</a></li>
<li>
<a class="nav-link" href="#heatmap-split"><span class="header-section-number">2.7</span> Heatmap split</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#split-by-kmeans-clustering"><span class="header-section-number">2.7.1</span> Split by k-means clustering</a></li>
<li><a class="nav-link" href="#split-by-categorical-variables"><span class="header-section-number">2.7.2</span> Split by categorical variables</a></li>
<li><a class="nav-link" href="#spilt-by-dendrogram"><span class="header-section-number">2.7.3</span> Split by dendrogram</a></li>
<li><a class="nav-link" href="#order-of-slices"><span class="header-section-number">2.7.4</span> Order of slices</a></li>
<li><a class="nav-link" href="#titles-for-splitting"><span class="header-section-number">2.7.5</span> Titles for splitting</a></li>
<li><a class="nav-link" href="#graphic-parameters-for-splitting"><span class="header-section-number">2.7.6</span> Graphic parameters for splitting</a></li>
<li><a class="nav-link" href="#gaps-between-slices"><span class="header-section-number">2.7.7</span> Gaps between slices</a></li>
<li><a class="nav-link" href="#split-heatmap-annotations"><span class="header-section-number">2.7.8</span> Split heatmap annotations</a></li>
</ul>
</li>
<li><a class="nav-link" href="#heatmap-as-raster-image"><span class="header-section-number">2.8</span> Heatmap as raster image</a></li>
<li>
<a class="nav-link" href="#customize-the-heatmap-body"><span class="header-section-number">2.9</span> Customize the heatmap body</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#cell-fun"><span class="header-section-number">2.9.1</span> cell_fun</a></li>
<li><a class="nav-link" href="#layer-fun"><span class="header-section-number">2.9.2</span> layer_fun</a></li>
</ul>
</li>
<li><a class="nav-link" href="#size-of-the-heatmap"><span class="header-section-number">2.10</span> Size of the heatmap</a></li>
<li><a class="nav-link" href="#plot-the-heatmap"><span class="header-section-number">2.11</span> Plot the heatmap</a></li>
<li><a class="nav-link" href="#get-orders-and-dendrograms-from-heatmap"><span class="header-section-number">2.12</span> Extract orders and dendrograms</a></li>
<li><a class="nav-link" href="#subset-a-heatmap"><span class="header-section-number">2.13</span> Subset a heatmap</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/jokergoo/ComplexHeatmap/blob/master/02-single_heatmap.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/jokergoo/ComplexHeatmap/edit/master/02-single_heatmap.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>ComplexHeatmap Complete Reference</strong>" was written by Zuguang Gu. It was last built on last revised on 2022-07-31.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
