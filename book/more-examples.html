<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 14 More Examples | ComplexHeatmap Complete Reference</title>
<meta name="author" content="Zuguang Gu">
<meta name="description" content="14.1 Add more information for gene expression matrix Heatmaps are very popular to visualize gene expression matrix. Rows in the matrix correspond to genes and more information on these genes can...">
<meta name="generator" content="bookdown 0.27 with bs4_book()">
<meta property="og:title" content="Chapter 14 More Examples | ComplexHeatmap Complete Reference">
<meta property="og:type" content="book">
<meta property="og:url" content="https://jokergoo.github.io/ComplexHeatmap-reference/book/more-examples.html">
<meta property="og:image" content="https://jokergoo.github.io/ComplexHeatmap-reference/book/complexheatmap-cover.jpg">
<meta property="og:description" content="14.1 Add more information for gene expression matrix Heatmaps are very popular to visualize gene expression matrix. Rows in the matrix correspond to genes and more information on these genes can...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 14 More Examples | ComplexHeatmap Complete Reference">
<meta name="twitter:description" content="14.1 Add more information for gene expression matrix Heatmaps are very popular to visualize gene expression matrix. Rows in the matrix correspond to genes and more information on these genes can...">
<meta name="twitter:image" content="https://jokergoo.github.io/ComplexHeatmap-reference/book/complexheatmap-cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><style>
    #content {
    	font-size: 0.95rem;
    }
    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">ComplexHeatmap Complete Reference</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="a-single-heatmap.html"><span class="header-section-number">2</span> A Single Heatmap</a></li>
<li><a class="" href="heatmap-annotations.html"><span class="header-section-number">3</span> Heatmap Annotations</a></li>
<li><a class="" href="a-list-of-heatmaps.html"><span class="header-section-number">4</span> A List of Heatmaps</a></li>
<li><a class="" href="legends.html"><span class="header-section-number">5</span> Legends</a></li>
<li><a class="" href="heatmap-decoration.html"><span class="header-section-number">6</span> Heatmap Decoration</a></li>
<li><a class="" href="oncoprint.html"><span class="header-section-number">7</span> OncoPrint</a></li>
<li><a class="" href="upset-plot.html"><span class="header-section-number">8</span> UpSet plot</a></li>
<li><a class="" href="interactive.html"><span class="header-section-number">9</span> Interactive ComplexHeatmap</a></li>
<li><a class="" href="integrate-with-other-packages.html"><span class="header-section-number">10</span> Integrate with other packages</a></li>
<li><a class="" href="other-high-level-plots.html"><span class="header-section-number">11</span> Other High-level Plots</a></li>
<li><a class="" href="three-d-heatmap.html"><span class="header-section-number">12</span> Three-dimensional ComplexHeatmap</a></li>
<li><a class="" href="genome-level-heatmap.html"><span class="header-section-number">13</span> Genome-level heatmap</a></li>
<li><a class="active" href="more-examples.html"><span class="header-section-number">14</span> More Examples</a></li>
<li><a class="" href="other-tricks.html"><span class="header-section-number">15</span> Other Tricks</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/jokergoo/ComplexHeatmap">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="more-examples" class="section level1" number="14">
<h1>
<span class="header-section-number">14</span> More Examples<a class="anchor" aria-label="anchor" href="#more-examples"><i class="fas fa-link"></i></a>
</h1>
<div id="add-more-information-for-gene-expression-matrix" class="section level2" number="14.1">
<h2>
<span class="header-section-number">14.1</span> Add more information for gene expression matrix<a class="anchor" aria-label="anchor" href="#add-more-information-for-gene-expression-matrix"><i class="fas fa-link"></i></a>
</h2>
<p>Heatmaps are very popular to visualize gene expression matrix. Rows in the
matrix correspond to genes and more information on these genes can be attached
after the expression heatmap.</p>
<p>In following example, the big heatmap visualizes relative expression for genes
(expression for each gene is scaled). On the right we put the absolute
expression level of genes as a single-column heatmap. The gene length and gene
type (i.e. protein coding or lincRNA) are also put as heatmap annotations or
heatmaps.</p>
<p>On the very left of the heatmaps, there are colored rectangles drawn by
<code><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_block.html">anno_block()</a></code> to identify the five clusters from k-means clustering. On top
of the “base mean” and “gene type” heatmaps, there are summary plots (barplots
and boxplots) showing the statistics or distributions of the data points in
the five clusters.</p>
<div class="sourceCode" id="cb772"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/ComplexHeatmap">ComplexHeatmap</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/circlize">circlize</a></span><span class="op">)</span>

<span class="va">expr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"ComplexHeatmap"</span>, <span class="st">"extdata"</span>, <span class="st">"gene_expression.rds"</span><span class="op">)</span><span class="op">)</span>
<span class="va">mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">expr</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/grep.html">grep</a></span><span class="op">(</span><span class="st">"cell"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">expr</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="va">base_mean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/colSums.html">rowMeans</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>
<span class="va">mat_scaled</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="fl">1</span>, <span class="va">scale</span><span class="op">)</span><span class="op">)</span>

<span class="va">type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"s\\d+_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html">HeatmapAnnotation</a></span><span class="op">(</span>type <span class="op">=</span> <span class="va">type</span>, annotation_name_side <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span>

<span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">mat_scaled</span>, name <span class="op">=</span> <span class="st">"expression"</span>, row_km <span class="op">=</span> <span class="fl">5</span>, 
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>,
    top_annotation <span class="op">=</span> <span class="va">ha</span>, 
    show_column_names <span class="op">=</span> <span class="cn">FALSE</span>, row_title <span class="op">=</span> <span class="cn">NULL</span>, show_row_dend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">base_mean</span>, name <span class="op">=</span> <span class="st">"base mean"</span>, 
    top_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html">HeatmapAnnotation</a></span><span class="op">(</span>summary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_summary.html">anno_summary</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, 
        height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">15</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/rowAnnotation.html">rowAnnotation</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_points.html">anno_points</a></span><span class="op">(</span><span class="va">expr</span><span class="op">$</span><span class="va">length</span>, pch <span class="op">=</span> <span class="fl">16</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"mm"</span><span class="op">)</span>, 
    axis_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2e5</span>, <span class="fl">4e5</span>, <span class="fl">6e5</span><span class="op">)</span>, 
        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"0kb"</span>, <span class="st">"200kb"</span>, <span class="st">"400kb"</span>, <span class="st">"600kb"</span><span class="op">)</span><span class="op">)</span>,
    width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">expr</span><span class="op">$</span><span class="va">type</span>, name <span class="op">=</span> <span class="st">"gene type"</span>, 
    top_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html">HeatmapAnnotation</a></span><span class="op">(</span>summary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_summary.html">anno_summary</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">15</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span>

<span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/rowAnnotation.html">rowAnnotation</a></span><span class="op">(</span>block <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_block.html">anno_block</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">6</span>, col <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>, 
    width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="va">ht_list</span>

<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html">draw</a></span><span class="op">(</span><span class="va">ht_list</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="14-examples_files/figure-html/expression_example-1.png" width="960" style="display: block; margin: auto;"></div>
</div>
<div id="the-measles-vaccine-heatmap" class="section level2" number="14.2">
<h2>
<span class="header-section-number">14.2</span> The measles vaccine heatmap<a class="anchor" aria-label="anchor" href="#the-measles-vaccine-heatmap"><i class="fas fa-link"></i></a>
</h2>
<p>Following code reproduces the heatmap introduced <a href="https://biomickwatson.wordpress.com/2015/04/09/recreating-a-famous-visualisation/">here</a> and <a href="https://benjaminlmoore.wordpress.com/2015/04/09/recreating-the-vaccination-heatmaps-in-r/">here</a>.</p>
<div class="sourceCode" id="cb773"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"measles.rds"</span>, package <span class="op">=</span> <span class="st">"ComplexHeatmap"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ha1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html">HeatmapAnnotation</a></span><span class="op">(</span>
    dist1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_barplot.html">anno_barplot</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/colSums.html">colSums</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, 
        bar_width <span class="op">=</span> <span class="fl">1</span>, 
        gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span>, fill <span class="op">=</span> <span class="st">"#FFE200"</span><span class="op">)</span>, 
        border <span class="op">=</span> <span class="cn">FALSE</span>,
        axis_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2e5</span>, <span class="fl">4e5</span>, <span class="fl">6e5</span>, <span class="fl">8e5</span><span class="op">)</span>,
            labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"0"</span>, <span class="st">"200k"</span>, <span class="st">"400k"</span>, <span class="st">"600k"</span>, <span class="st">"800k"</span><span class="op">)</span><span class="op">)</span>,
        height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span>
    <span class="op">)</span>, show_annotation_name <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">ha2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/rowAnnotation.html">rowAnnotation</a></span><span class="op">(</span>
    dist2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_barplot.html">anno_barplot</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, 
        bar_width <span class="op">=</span> <span class="fl">1</span>, 
        gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span>, fill <span class="op">=</span> <span class="st">"#FFE200"</span><span class="op">)</span>, 
        border <span class="op">=</span> <span class="cn">FALSE</span>,
        axis_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5e5</span>, <span class="fl">1e6</span>, <span class="fl">1.5e6</span><span class="op">)</span>,
            labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"0"</span>, <span class="st">"500k"</span>, <span class="st">"1m"</span>, <span class="st">"1.5m"</span><span class="op">)</span><span class="op">)</span>,
        width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span>
    <span class="op">)</span>, show_annotation_name <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">year_text</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span>
<span class="va">year_text</span><span class="op">[</span><span class="va">year_text</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">10</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="st">""</span>
<span class="va">ha_column</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html">HeatmapAnnotation</a></span><span class="op">(</span>
    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_text.html">anno_text</a></span><span class="op">(</span><span class="va">year_text</span>, rot <span class="op">=</span> <span class="fl">0</span>, location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, just <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">800</span>, <span class="fl">1000</span>, <span class="fl">127000</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"cornflowerblue"</span>, <span class="st">"yellow"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">mat</span>, name <span class="op">=</span> <span class="st">"cases"</span>, col <span class="op">=</span> <span class="va">col_fun</span>,
    cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>, show_row_dend <span class="op">=</span> <span class="cn">FALSE</span>, rect_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col<span class="op">=</span> <span class="st">"white"</span><span class="op">)</span>, 
    show_column_names <span class="op">=</span> <span class="cn">FALSE</span>,
    row_names_side <span class="op">=</span> <span class="st">"left"</span>, row_names_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,
    column_title <span class="op">=</span> <span class="st">'Measles cases in US states 1930-2001\nVaccine introduced 1961'</span>,
    top_annotation <span class="op">=</span> <span class="va">ha1</span>, bottom_annotation <span class="op">=</span> <span class="va">ha_column</span>,
    heatmap_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5e4</span>, <span class="fl">1e5</span>, <span class="fl">1.5e5</span><span class="op">)</span>, 
        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"0"</span>, <span class="st">"50k"</span>, <span class="st">"100k"</span>, <span class="st">"150k"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="va">ha2</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html">draw</a></span><span class="op">(</span><span class="va">ht_list</span>, ht_gap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">3</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/decorate_heatmap_body.html">decorate_heatmap_body</a></span><span class="op">(</span><span class="st">"cases"</span>, <span class="op">{</span>
    <span class="va">i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">==</span> <span class="st">"1961"</span><span class="op">)</span>
    <span class="va">x</span> <span class="op">=</span> <span class="va">i</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/grid/grid.lines.html">grid.lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span><span class="st">"Vaccine introduced"</span>, <span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="14-examples_files/figure-html/unnamed-chunk-2-1.png" width="960" style="display: block; margin: auto;"></div>
</div>
<div id="visualize-cell-heterogeneity-from-single-cell-rnaseq" class="section level2" number="14.3">
<h2>
<span class="header-section-number">14.3</span> Visualize Cell Heterogeneity from Single Cell RNASeq<a class="anchor" aria-label="anchor" href="#visualize-cell-heterogeneity-from-single-cell-rnaseq"><i class="fas fa-link"></i></a>
</h2>
<p>In this example, single cell RNA-Seq data for mouse T-cells is visualized to show the heterogeneity
of cells. The data (<code>mouse_scRNAseq_corrected.txt</code>) is from <a href="http://www.nature.com/nbt/journal/v33/n2/full/nbt.3102.html">Buettner et al.,
2015</a>, supplementary data 1, sheet
“<strong>Cell-cycle corrected gene expr</strong>.” You can get <code>mouse_scRNAseq_corrected.txt</code> <a href="https://jokergoo.github.io/ComplexHeatmap-reference/data/mouse_scRNAseq_corrected.txt">here</a>.</p>
<p>In following code, duplicated genes are removed.</p>
<div class="sourceCode" id="cb774"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">expr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"data/mouse_scRNAseq_corrected.txt"</span>, sep <span class="op">=</span> <span class="st">"\t"</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">expr</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">expr</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">rownames</a></span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="va">expr</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>
<span class="va">expr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">expr</span><span class="op">)</span></code></pre></div>
<p>Genes that are not expressed in more than half of the cells are filtered out.</p>
<div class="sourceCode" id="cb775"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">expr</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">expr</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.5</span><span class="op">)</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></code></pre></div>
<p>The <code>get_correlated_variable_rows()</code> function is defined here. It extracts signature genes that are
variably expressed between cells and correlate to other genes.</p>
<div class="sourceCode" id="cb776"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">get_correlated_variable_genes</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html">nrow</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, <span class="va">cor_cutoff</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">n_cutoff</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
            <span class="va">q</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span>
            <span class="va">x</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">x</span> <span class="op">&gt;</span> <span class="va">q</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">x</span> <span class="op">&lt;</span> <span class="va">q</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
            <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="op">}</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>
    <span class="va">mat2</span> <span class="op">=</span> <span class="va">mat</span><span class="op">[</span><span class="va">ind</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
    <span class="va">dt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/t.html">t</a></span><span class="op">(</span><span class="va">mat2</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"spearman"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">=</span> <span class="fl">0</span>
    <span class="va">dt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">cor_cutoff</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span>
    <span class="va">dt</span><span class="op">[</span><span class="va">dt</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>
    <span class="va">dt</span><span class="op">[</span><span class="va">dt</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span>

    <span class="va">i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/colSums.html">colSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">n_cutoff</span>

    <span class="va">mat3</span> <span class="op">=</span> <span class="va">mat2</span><span class="op">[</span><span class="va">i</span>, ,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">mat3</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Signature genes are defined as a list of genes where each gene correlates to more than 20 genes with
an absolute correlation larger than 0.5.</p>
<p><code>mat2</code> contains expression values scaled per gene, which means it contains relative expression
across cells for every gene. Since single cell RNASeq data is highly variable and outliers are
frequent, gene expression is only scaled within the 10th and 90th quantiles.</p>
<div class="sourceCode" id="cb777"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat</span> <span class="op">=</span> <span class="fu">get_correlated_variable_genes</span><span class="op">(</span><span class="va">expr</span>, cor_cutoff <span class="op">=</span> <span class="fl">0.5</span>, n_cutoff <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>
<span class="va">mat2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">q10</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.1</span><span class="op">)</span>
    <span class="va">q90</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.9</span><span class="op">)</span>
    <span class="va">x</span><span class="op">[</span><span class="va">x</span> <span class="op">&lt;</span> <span class="va">q10</span><span class="op">]</span> <span class="op">=</span> <span class="va">q10</span>
    <span class="va">x</span><span class="op">[</span><span class="va">x</span> <span class="op">&gt;</span> <span class="va">q90</span><span class="op">]</span> <span class="op">=</span> <span class="va">q90</span>
    <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat2</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span></code></pre></div>
<p>Load cell cycle genes and ribonucleoprotein genes. The cell cycle gene list is from <a href="http://www.nature.com/nbt/journal/v33/n2/full/nbt.3102.html">Buettner et
al., 2015</a>, supplementary table 1,
sheet “<strong>Union of Cyclebase and GO genes</strong>.” Ribonucleoprotein genes are from
<a href="http://amigo.geneontology.org/amigo/term/GO:0030529">GO:0030529</a>. Gene list are stored in
<code>mouse_cell_cycle_gene.rds</code> and <code>mouse_ribonucleoprotein.rds</code>. The two files can be found
<a href="https://jokergoo.github.io/ComplexHeatmap-reference/data/mouse_cell_cycle_gene.rds">here</a> and
<a href="https://jokergoo.github.io/ComplexHeatmap-reference/data/mouse_ribonucleoprotein.rds">here</a>.</p>
<div class="sourceCode" id="cb778"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/mouse_cell_cycle_gene.rds"</span><span class="op">)</span>
<span class="va">ccl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html">%in%</a></span> <span class="va">cc</span>
<span class="va">cc_gene</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">[</span><span class="va">ccl</span><span class="op">]</span>

<span class="va">rp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/mouse_ribonucleoprotein.rds"</span><span class="op">)</span>
<span class="va">rpl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html">%in%</a></span> <span class="va">rp</span></code></pre></div>
<p>Since with scaling the expression values per gene the expression level of a gene relative to other
genes has been lost, we calculate the base mean as the mean expression of a gene throughout all
samples. The base mean can be used to compare expression levels between genes.</p>
<div class="sourceCode" id="cb779"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">base_mean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/colSums.html">rowMeans</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span></code></pre></div>
<p>Now the following information is available:</p>
<ol style="list-style-type: decimal">
<li>scaled expression, <code>mat2</code>,</li>
<li>base mean, <code>base_mean</code>,</li>
<li>whether genes are ribonucleoprotein genes, <code>rpl</code>,</li>
<li>whether genes are cell cycle genes, <code>ccl</code>,</li>
<li>symbols for cell cycle genes, <code>cc_gene</code>,</li>
</ol>
<p>In the next step, we can put the information together and visualize it as a list of heatmaps. A
gene-gene correlation heatmap is added at the end and defined to be the main_heatmap, meaning that
the row order of all heatmaps/row annotations are based on the clustering of this correlation
matrix.</p>
<p>For cell cycle genes with relatively high expression levels (larger than the 25% quantile of all
genes), the gene name is indicated as text labels. In the first heatmap, the column dendrogram is
underlaid with two different colours based in the two main groups derived by hierarchical clustering
to highlight the two subpopulations.</p>
<div class="sourceCode" id="cb780"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/GetoptLong">GetoptLong</a></span><span class="op">)</span>
<span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">mat2</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>, 
    name <span class="op">=</span> <span class="st">"scaled_expr"</span>, column_title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GetoptLong/man/qq.html">qq</a></span><span class="op">(</span><span class="st">"relative expression for @{nrow(mat)} genes"</span><span class="op">)</span>,
    show_column_names <span class="op">=</span> <span class="cn">FALSE</span>, width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">8</span>, <span class="st">"cm"</span><span class="op">)</span>,
    heatmap_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Scaled expr"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">base_mean</span>, name <span class="op">=</span> <span class="st">"base_expr"</span>, width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"mm"</span><span class="op">)</span>,
        heatmap_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Base expr"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">rpl</span> <span class="op">+</span> <span class="fl">0</span>, name <span class="op">=</span> <span class="st">"ribonucleoprotein"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"0"</span> <span class="op">=</span> <span class="st">"white"</span>, <span class="st">"1"</span> <span class="op">=</span> <span class="st">"purple"</span><span class="op">)</span>, 
        show_heatmap_legend <span class="op">=</span> <span class="cn">FALSE</span>, width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">ccl</span> <span class="op">+</span> <span class="fl">0</span>, name <span class="op">=</span> <span class="st">"cell_cycle"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"0"</span> <span class="op">=</span> <span class="st">"white"</span>, <span class="st">"1"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>, 
        show_heatmap_legend <span class="op">=</span> <span class="cn">FALSE</span>, width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/rowAnnotation.html">rowAnnotation</a></span><span class="op">(</span>link <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_mark.html">anno_mark</a></span><span class="op">(</span>at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="va">ccl</span> <span class="op">&amp;</span> <span class="va">base_mean</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">base_mean</span>, <span class="fl">0.25</span><span class="op">)</span><span class="op">)</span>, 
        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">[</span><span class="va">ccl</span> <span class="op">&amp;</span> <span class="va">base_mean</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">base_mean</span>, <span class="fl">0.25</span><span class="op">)</span><span class="op">]</span>, 
        labels_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, padding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/t.html">t</a></span><span class="op">(</span><span class="va">mat2</span><span class="op">)</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"cor"</span>, 
        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>, 
        show_row_names <span class="op">=</span> <span class="cn">FALSE</span>, show_column_names <span class="op">=</span> <span class="cn">FALSE</span>, row_dend_side <span class="op">=</span> <span class="st">"right"</span>, 
        show_column_dend <span class="op">=</span> <span class="cn">FALSE</span>, column_title <span class="op">=</span> <span class="st">"pairwise correlation between genes"</span>,
        heatmap_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Correlation"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html">draw</a></span><span class="op">(</span><span class="va">ht_list</span>, main_heatmap <span class="op">=</span> <span class="st">"cor"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/decorate_column_dend.html">decorate_column_dend</a></span><span class="op">(</span><span class="st">"scaled_expr"</span>, <span class="op">{</span>
    <span class="va">tree</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/column_dend-dispatch.html">column_dend</a></span><span class="op">(</span><span class="va">ht_list</span><span class="op">)</span><span class="op">$</span><span class="va">scaled_expr</span>
    <span class="va">ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/as.hclust.html">as.hclust</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span>, k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/order.dendrogram.html">order.dendrogram</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span><span class="op">]</span>

    <span class="va">first_index</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    <span class="va">last_index</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">{</span> <span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>; <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span> <span class="op">}</span>
    <span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fu">first_index</span><span class="op">(</span><span class="va">ind</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="fu">first_index</span><span class="op">(</span><span class="va">ind</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>
    <span class="va">x2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fu">last_index</span><span class="op">(</span><span class="va">ind</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="fu">last_index</span><span class="op">(</span><span class="va">ind</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/grid/grid.rect.html">grid.rect</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ind</span><span class="op">)</span>, width <span class="op">=</span> <span class="op">(</span><span class="va">x2</span> <span class="op">-</span> <span class="va">x1</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ind</span><span class="op">)</span>, just <span class="op">=</span> <span class="st">"left"</span>,
        default.units <span class="op">=</span> <span class="st">"npc"</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"#FF000040"</span>, <span class="st">"#00FF0040"</span><span class="op">)</span>, col <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="14-examples_files/figure-html/unnamed-chunk-9-1.png" width="1152" style="display: block; margin: auto;"></div>
<p>The heatmap clearly reveals that the cells are separated into two sub-populations. The population on
the left in the first heatmap exhibits high expression of a subset of cell cycle genes (cell cycle
genes are indicated in “<strong>cell_cycle</strong>” heatmap). However, the overall expression level for these
genes is relatively low (see “<strong>base_expr</strong>” heatmap). The population on the right has higher
expression in the other signature genes. Interestingly, the signature genes which are higher
expressed in this subpopulation are enriched for genes coding for ribonucleoproteins (see
“<strong>ribonucleoprotein</strong>” heatmap). A subset of the ribonucleoprotein genes shows strong coexpression
(see correlation heatmap) and overall high expression levels (“<strong>base_expr</strong>” heatmap).</p>
</div>
<div id="correlations-between-methylation-expression-and-other-genomic-features" class="section level2" number="14.4">
<h2>
<span class="header-section-number">14.4</span> Correlations between methylation, expression and other genomic features<a class="anchor" aria-label="anchor" href="#correlations-between-methylation-expression-and-other-genomic-features"><i class="fas fa-link"></i></a>
</h2>
<p>In the following example, data is randomly generated based on patterns found in an unpublished analysis.
First we load the data. <code>meth.rds</code> can be found <a href="https://jokergoo.github.io/ComplexHeatmap-reference/data/meth.rds">here</a>.</p>
<div class="sourceCode" id="cb781"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/meth.rds"</span><span class="op">)</span>
<span class="va">type</span> <span class="op">=</span> <span class="va">res_list</span><span class="op">$</span><span class="va">type</span>
<span class="va">mat_meth</span> <span class="op">=</span> <span class="va">res_list</span><span class="op">$</span><span class="va">mat_meth</span>
<span class="va">mat_expr</span> <span class="op">=</span> <span class="va">res_list</span><span class="op">$</span><span class="va">mat_expr</span>
<span class="va">direction</span> <span class="op">=</span> <span class="va">res_list</span><span class="op">$</span><span class="va">direction</span>
<span class="va">cor_pvalue</span> <span class="op">=</span> <span class="va">res_list</span><span class="op">$</span><span class="va">cor_pvalue</span>
<span class="va">gene_type</span> <span class="op">=</span> <span class="va">res_list</span><span class="op">$</span><span class="va">gene_type</span>
<span class="va">anno_gene</span> <span class="op">=</span> <span class="va">res_list</span><span class="op">$</span><span class="va">anno_gene</span>
<span class="va">dist</span> <span class="op">=</span> <span class="va">res_list</span><span class="op">$</span><span class="va">dist</span>
<span class="va">anno_enhancer</span> <span class="op">=</span> <span class="va">res_list</span><span class="op">$</span><span class="va">anno_enhancer</span></code></pre></div>
<p>The different sources of information and corresponding variables are:</p>
<ol style="list-style-type: decimal">
<li>
<code>type</code>: the label which shows whether the sample is tumor or normal.</li>
<li>
<code>mat_meth</code>: a matrix in which rows correspond to differetially methylated regions (DMRs). The
value in the matrix is the mean methylation level in the DMR in every sample.</li>
<li>
<code>mat_expr</code>: a matrix in which rows correspond to genes which are associated to the DMRs (i.e. the
nearest gene to the DMR). The value in the matrix is the expression level for each gene in each
sample. Expression is scaled for every gene across samples.</li>
<li>
<code>direction</code>: direction of the methylation change (hyper meaning higher methylation in tumor
samples, hypo means lower methylation in tumor samples).</li>
<li>
<code>cor_pvalue</code>: p-value for the correlation test between methylation and expression of the
associated gene.</li>
<li>
<code>gene_type</code>: type of the genes (e.g. protein coding genes or lincRNAs).</li>
<li>
<code>anno_gene</code>: annotation to the gene models (intergenic, intragenic or TSS).</li>
<li>
<code>dist</code>: distance from DMRs to TSS of the assiciated genes.</li>
<li>
<code>anno_enhancer</code>: fraction of the DMR that overlaps enhancers.</li>
</ol>
<p>The data only includes DMRs for which methylation and expression of the associated gene are
negatively correlated.</p>
<p>The clustering of columns for the methylation matrix are calculated first so that columns in the
expression matrix can be adjusted to have the same column order as in the methylation matrix.</p>
<div class="sourceCode" id="cb782"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">column_tree</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/t.html">t</a></span><span class="op">(</span><span class="va">mat_meth</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">column_order</span> <span class="op">=</span> <span class="va">column_tree</span><span class="op">$</span><span class="va">order</span></code></pre></div>
<div class="sourceCode" id="cb783"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span>
<span class="va">meth_col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>
<span class="va">direction_col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"hyper"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"hypo"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>
<span class="va">expr_col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>
<span class="va">pvalue_col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>
<span class="va">gene_type_col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html">unique</a></span><span class="op">(</span><span class="va">gene_type</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Set3"</span><span class="op">)</span>, 
    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html">unique</a></span><span class="op">(</span><span class="va">gene_type</span><span class="op">)</span><span class="op">)</span>
<span class="va">anno_gene_col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html">unique</a></span><span class="op">(</span><span class="va">anno_gene</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Set1"</span><span class="op">)</span>, 
    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html">unique</a></span><span class="op">(</span><span class="va">anno_gene</span><span class="op">)</span><span class="op">)</span>
<span class="va">dist_col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10000</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"white"</span><span class="op">)</span><span class="op">)</span>
<span class="va">enhancer_col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"orange"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We first define two column annotations and then make the complex heatmaps.</p>
<div class="sourceCode" id="cb784"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/ht_opt.html">ht_opt</a></span><span class="op">(</span>
    legend_title_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">8</span>, fontface <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, 
    legend_labels_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>, 
    heatmap_column_names_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,
    heatmap_column_title_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
    heatmap_row_title_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">ha</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html">HeatmapAnnotation</a></span><span class="op">(</span>type <span class="op">=</span> <span class="va">type</span>, 
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"Tumor"</span> <span class="op">=</span> <span class="st">"pink"</span>, <span class="st">"Control"</span> <span class="op">=</span> <span class="st">"royalblue"</span><span class="op">)</span><span class="op">)</span>,
    annotation_name_side <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span>
<span class="va">ha2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html">HeatmapAnnotation</a></span><span class="op">(</span>type <span class="op">=</span> <span class="va">type</span>, 
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"Tumor"</span> <span class="op">=</span> <span class="st">"pink"</span>, <span class="st">"Control"</span> <span class="op">=</span> <span class="st">"royalblue"</span><span class="op">)</span><span class="op">)</span>, 
    show_legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">mat_meth</span>, name <span class="op">=</span> <span class="st">"methylation"</span>, col <span class="op">=</span> <span class="va">meth_col_fun</span>,
    column_order<span class="op">=</span> <span class="va">column_order</span>,
    top_annotation <span class="op">=</span> <span class="va">ha</span>, column_title <span class="op">=</span> <span class="st">"Methylation"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">direction</span>, name <span class="op">=</span> <span class="st">"direction"</span>, col <span class="op">=</span> <span class="va">direction_col</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">mat_expr</span><span class="op">[</span>, <span class="va">column_tree</span><span class="op">$</span><span class="va">order</span><span class="op">]</span>, name <span class="op">=</span> <span class="st">"expression"</span>, 
        col <span class="op">=</span> <span class="va">expr_col_fun</span>, 
        column_order <span class="op">=</span> <span class="va">column_order</span>, 
        top_annotation <span class="op">=</span> <span class="va">ha2</span>, column_title <span class="op">=</span> <span class="st">"Expression"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">cor_pvalue</span>, name <span class="op">=</span> <span class="st">"-log10(cor_p)"</span>, col <span class="op">=</span> <span class="va">pvalue_col_fun</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">gene_type</span>, name <span class="op">=</span> <span class="st">"gene type"</span>, col <span class="op">=</span> <span class="va">gene_type_col</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">anno_gene</span>, name <span class="op">=</span> <span class="st">"anno_gene"</span>, col <span class="op">=</span> <span class="va">anno_gene_col</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">dist</span>, name <span class="op">=</span> <span class="st">"dist_tss"</span>, col <span class="op">=</span> <span class="va">dist_col_fun</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">anno_enhancer</span>, name <span class="op">=</span> <span class="st">"anno_enhancer"</span>, col <span class="op">=</span> <span class="va">enhancer_col_fun</span>, 
        cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>, column_title <span class="op">=</span> <span class="st">"Enhancer"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html">draw</a></span><span class="op">(</span><span class="va">ht_list</span>, row_km <span class="op">=</span> <span class="fl">2</span>, row_split <span class="op">=</span> <span class="va">direction</span>,
    column_title <span class="op">=</span> <span class="st">"Comprehensive correspondence between methylation, expression and other genomic features"</span>, 
    column_title_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">12</span>, fontface <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, 
    merge_legends <span class="op">=</span> <span class="cn">TRUE</span>, heatmap_legend_side <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="14-examples_files/figure-html/unnamed-chunk-13-1.png" width="1152" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb785"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/ht_opt.html">ht_opt</a></span><span class="op">(</span>RESET <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>The complex heatmaps reveal that highly methylated DMRs are enriched in intergenic and intragenic
regions and rarely overlap with enhancers. In contrast, lowly methylated DMRs are enriched for
transcription start sites (TSS) and enhancers.</p>
</div>
<div id="visualize-methylation-profile-with-complex-annotations" class="section level2" number="14.5">
<h2>
<span class="header-section-number">14.5</span> Visualize Methylation Profile with Complex Annotations<a class="anchor" aria-label="anchor" href="#visualize-methylation-profile-with-complex-annotations"><i class="fas fa-link"></i></a>
</h2>
<p>In this example, Figure 1 in <a href="http://dx.doi.org/10.1016/j.ccr.2012.08.024">Strum et al., 2012</a>
is re-implemented with some adjustments.</p>
<p>Some packages need to be loaded firstly.</p>
<div class="sourceCode" id="cb786"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HenrikBengtsson/matrixStats">matrixStats</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/GenomicRanges">GenomicRanges</a></span><span class="op">)</span></code></pre></div>
<p>Methylation profiles can be download from <a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE36278">GEO
database</a>. The <a href="http://bioconductor.org/packages/release/bioc/html/GEOquery.html"><strong>GEOquery</strong>
package</a> is used to retrieve
data from GEO.</p>
<div class="sourceCode" id="cb787"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/seandavi/GEOquery">GEOquery</a></span><span class="op">)</span>
<span class="va">gset</span> <span class="op">=</span> <span class="fu"><a href="http://seandavi.github.io/GEOquery/reference/getGEO.html">getGEO</a></span><span class="op">(</span><span class="st">"GSE36278"</span><span class="op">)</span></code></pre></div>
<p>The methylation profiles have been measured by Illumina HumanMethylation450 BeadChip arrays.
We load probe data via the <strong>IlluminaHumanMethylation450kanno.ilmn12.hg19</strong> package.</p>
<p>Adjust row names in the matrix to be the same as the probes.</p>
<div class="sourceCode" id="cb788"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">IlluminaHumanMethylation450kanno.ilmn12.hg19</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Locations</span><span class="op">)</span>

<span class="va">mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/exprs.html">exprs</a></span><span class="op">(</span><span class="va">gset</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/phenoData.html">phenoData</a></span><span class="op">(</span><span class="va">gset</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">title</span>
<span class="va">mat</span> <span class="op">=</span> <span class="va">mat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">rownames</a></span><span class="op">(</span><span class="va">Locations</span><span class="op">)</span>, <span class="op">]</span> </code></pre></div>
<p><code>probe</code> contains locations of probes and also information whether the CpG sites overlap
with SNPs. Here we remove probes that are on sex chromosomes and probes that overlap with SNPs.</p>
<div class="sourceCode" id="cb789"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">SNPs.137CommonSingle</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Islands.UCSC</span><span class="op">)</span>
<span class="va">l</span> <span class="op">=</span> <span class="va">Locations</span><span class="op">$</span><span class="va">chr</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"chr"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">22</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">SNPs.137CommonSingle</span><span class="op">$</span><span class="va">Probe_rs</span><span class="op">)</span>
<span class="va">mat</span> <span class="op">=</span> <span class="va">mat</span><span class="op">[</span><span class="va">l</span>, <span class="op">]</span></code></pre></div>
<p>Get subsets for locations of probes and the annotation to CpG Islands accordingly.</p>
<div class="sourceCode" id="cb790"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cgi</span> <span class="op">=</span> <span class="va">Islands.UCSC</span><span class="op">$</span><span class="va">Relation_to_Island</span><span class="op">[</span><span class="va">l</span><span class="op">]</span>
<span class="va">loc</span> <span class="op">=</span> <span class="va">Locations</span><span class="op">[</span><span class="va">l</span>, <span class="op">]</span></code></pre></div>
<p>Separate the matrix into a matrix for tumor samples and a matrix for normal samples. Also modify
column names for the tumor samples to be consistent with the phenotype data which we will read
later.</p>
<div class="sourceCode" id="cb791"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">mat</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/grep.html">grep</a></span><span class="op">(</span><span class="st">"GBM"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>   <span class="co"># tumor samples</span>
<span class="va">mat2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">mat</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/grep.html">grep</a></span><span class="op">(</span><span class="st">"CTRL"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>  <span class="co"># normal samples</span>
<span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat1</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"GBM"</span>, <span class="st">"dkfz"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Phenotype data is from <a href="http://dx.doi.org/10.1016/j.ccr.2012.08.024">Sturm et al., 2012</a>,
supplementary table S1 and can be found <a href="https://jokergoo.github.io/ComplexHeatmap-reference/data/450K_annotation.txt">here</a>.</p>
<p>The rows of phenotype data are adjusted to be the same as the columns of the methylation matrix.</p>
<div class="sourceCode" id="cb792"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">phenotype</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"data/450K_annotation.txt"</span>, header <span class="op">=</span> <span class="cn">TRUE</span>, sep <span class="op">=</span> <span class="st">"\t"</span>, 
    row.names <span class="op">=</span> <span class="fl">1</span>, check.names <span class="op">=</span> <span class="cn">FALSE</span>, comment.char <span class="op">=</span> <span class="st">""</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">phenotype</span> <span class="op">=</span> <span class="va">phenotype</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat1</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<p>Please note that we only use the 136 samples which are from DKFZ, while in <a href="http://dx.doi.org/10.1016/j.ccr.2012.08.024">Sturm et al., 2012</a>, additional 74 TCGA samples have been used.</p>
<p>Extract the top 8000 probes with most variable methylation in the tumor samples, and also subset other
information correspondingly.</p>
<div class="sourceCode" id="cb793"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowVars.html">rowVars</a></span><span class="op">(</span><span class="va">mat1</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">8000</span><span class="op">]</span>
<span class="va">m1</span> <span class="op">=</span> <span class="va">mat1</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span>
<span class="va">m2</span> <span class="op">=</span> <span class="va">mat2</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span>
<span class="va">cgi2</span> <span class="op">=</span> <span class="va">cgi</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>
<span class="va">cgi2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Shore"</span>, <span class="va">cgi2</span><span class="op">)</span>, <span class="st">"Shore"</span>, <span class="va">cgi2</span><span class="op">)</span>
<span class="va">cgi2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/grep.html">grepl</a></span><span class="op">(</span><span class="st">"Shelf"</span>, <span class="va">cgi2</span><span class="op">)</span>, <span class="st">"Shelf"</span>, <span class="va">cgi2</span><span class="op">)</span>
<span class="va">loc</span> <span class="op">=</span> <span class="va">loc</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span></code></pre></div>
<p>For each probe, find the distance to the closest TSS. <code>pc_tx_tss.bed</code> contains positions
of TSS from protein coding genes.</p>
<div class="sourceCode" id="cb794"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/GRanges-class.html">GRanges</a></span><span class="op">(</span><span class="va">loc</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, ranges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/IRanges-constructor.html">IRanges</a></span><span class="op">(</span><span class="va">loc</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">loc</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">tss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"data/pc_tx_tss.bed"</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">tss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/GRanges-class.html">GRanges</a></span><span class="op">(</span><span class="va">tss</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, ranges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/IRanges-constructor.html">IRanges</a></span><span class="op">(</span><span class="va">tss</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">tss</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

<span class="va">tss_dist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/nearest-methods.html">distanceToNearest</a></span><span class="op">(</span><span class="va">gr</span>, <span class="va">tss</span><span class="op">)</span>
<span class="va">tss_dist</span> <span class="op">=</span> <span class="va">tss_dist</span><span class="op">@</span><span class="va">elementMetadata</span><span class="op">$</span><span class="va">distance</span></code></pre></div>
<p>Because there are a few <code>NA</code> in the matrix (<code>sum(is.na(m1))/length(m1)</code> = 0.0011967)
which will break the <code><a href="https://rdrr.io/r/stats/cor.html">cor()</a></code> function, we replace <code>NA</code> to the intermediate methylation (0.5).
Note that although <strong>ComplexHeatmap</strong> allows <code>NA</code> in the matrix, removal of <code>NA</code> will speed up the clustering.</p>
<div class="sourceCode" id="cb795"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0.5</span>
<span class="va">m2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0.5</span></code></pre></div>
<p>The following annotations will be added to the columns of the methylation matrix:</p>
<ol style="list-style-type: decimal">
<li>age</li>
<li>subtype classification by DKFZ</li>
<li>subtype classification by TCGA</li>
<li>subtype classification by TCGA, based on expression profile</li>
<li>IDH1 mutation</li>
<li>H3F3A mutation</li>
<li>TP53 mutation</li>
<li>chr7 gain</li>
<li>chr10 loss</li>
<li>CDKN2A deletion</li>
<li>EGFR amplification</li>
<li>PDGFRA amplification</li>
</ol>
<p>In following code we define the column annotation in the <code>ha</code> variable. Also we customize colors, legends and height of the annotations.</p>
<div class="sourceCode" id="cb796"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mutation_col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"MUT"</span>, <span class="st">"WT"</span>, <span class="st">"G34R"</span>, <span class="st">"G34V"</span>, <span class="st">"K27M"</span><span class="op">)</span>, 
    <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"white"</span>, <span class="st">"#4DAF4A"</span>, <span class="st">"#4DAF4A"</span>, <span class="st">"#377EB8"</span><span class="op">)</span><span class="op">)</span>
<span class="va">cnv_col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"gain"</span> <span class="op">=</span> <span class="st">"#E41A1C"</span>, <span class="st">"loss"</span> <span class="op">=</span> <span class="st">"#377EB8"</span>, <span class="st">"amp"</span> <span class="op">=</span> <span class="st">"#E41A1C"</span>, 
    <span class="st">"del"</span> <span class="op">=</span> <span class="st">"#377EB8"</span>, <span class="st">"normal"</span> <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span>
<span class="va">ha</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html">HeatmapAnnotation</a></span><span class="op">(</span>
    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_points.html">anno_points</a></span><span class="op">(</span><span class="va">phenotype</span><span class="op">[[</span><span class="fl">13</span><span class="op">]</span><span class="op">]</span>, 
        gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">phenotype</span><span class="op">[[</span><span class="fl">13</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">20</span>, <span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>, 
        height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">3</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>,
    dkfz_cluster <span class="op">=</span> <span class="va">phenotype</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
    tcga_cluster <span class="op">=</span> <span class="va">phenotype</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>,
    tcga_expr <span class="op">=</span> <span class="va">phenotype</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>,
    IDH1 <span class="op">=</span> <span class="va">phenotype</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span>,
    H3F3A <span class="op">=</span> <span class="va">phenotype</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>,
    TP53 <span class="op">=</span> <span class="va">phenotype</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span>,
    chr7_gain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">phenotype</span><span class="op">[[</span><span class="fl">7</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"gain"</span>, <span class="st">"normal"</span><span class="op">)</span>,
    chr10_loss <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">phenotype</span><span class="op">[[</span><span class="fl">8</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"loss"</span>, <span class="st">"normal"</span><span class="op">)</span>,
    CDKN2A_del <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">phenotype</span><span class="op">[[</span><span class="fl">9</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"del"</span>, <span class="st">"normal"</span><span class="op">)</span>,
    EGFR_amp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">phenotype</span><span class="op">[[</span><span class="fl">10</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"amp"</span>, <span class="st">"normal"</span><span class="op">)</span>,
    PDGFRA_amp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">phenotype</span><span class="op">[[</span><span class="fl">11</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"amp"</span>, <span class="st">"normal"</span><span class="op">)</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dkfz_cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"IDH"</span>, <span class="st">"K27"</span>, <span class="st">"G34"</span>, <span class="st">"RTK I PDGFRA"</span>, 
            <span class="st">"Mesenchymal"</span>, <span class="st">"RTK II Classic"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">6</span>, <span class="st">"Set1"</span><span class="op">)</span><span class="op">)</span>,
        tcga_cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"G-CIMP+"</span>, <span class="st">"Cluster #2"</span>, <span class="st">"Cluster #3"</span><span class="op">)</span>, 
            <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">3</span>, <span class="st">"Set1"</span><span class="op">)</span><span class="op">)</span>,
        tcga_expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"Proneural"</span>, <span class="st">"Classical"</span>, <span class="st">"Mesenchymal"</span><span class="op">)</span>, 
            <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"#377EB8"</span>, <span class="st">"#FFFF33"</span>, <span class="st">"#FF7F00"</span><span class="op">)</span><span class="op">)</span>,
        IDH1 <span class="op">=</span> <span class="va">mutation_col</span>,
        H3F3A <span class="op">=</span> <span class="va">mutation_col</span>,
        TP53 <span class="op">=</span> <span class="va">mutation_col</span>,
        chr7_gain <span class="op">=</span> <span class="va">cnv_col</span>,
        chr10_loss <span class="op">=</span> <span class="va">cnv_col</span>,
        CDKN2A_del <span class="op">=</span> <span class="va">cnv_col</span>,
        EGFR_amp <span class="op">=</span> <span class="va">cnv_col</span>,
        PDGFRA_amp <span class="op">=</span> <span class="va">cnv_col</span><span class="op">)</span>,
    na_col <span class="op">=</span> <span class="st">"grey"</span>, border <span class="op">=</span> <span class="cn">TRUE</span>,
    show_legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">TRUE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">FALSE</span>, <span class="cn">FALSE</span>, <span class="cn">FALSE</span><span class="op">)</span>,
    show_annotation_name <span class="op">=</span> <span class="cn">FALSE</span>,
    annotation_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        dkfz_cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"DKFZ Methylation"</span><span class="op">)</span>,
        tcga_cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"TCGA Methylation"</span><span class="op">)</span>,
        tcga_expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"TCGA Expression"</span><span class="op">)</span>,
        H3F3A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Mutations"</span><span class="op">)</span>,
        chr7_gain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"CNV"</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>In the final plot, there are four heatmaps added. From left to right, there are</p>
<ol style="list-style-type: decimal">
<li>heatmap for methylation in tumor samples</li>
<li>methylation in normal samples</li>
<li>distance to nearest TSS</li>
<li>CpG Island (CGI) annotation.</li>
</ol>
<p>The heatmaps are split by rows according to CGI annotations.</p>
<p>After the heatmaps are plotted, additional graphics such as labels for annotations are added by
<code>decorate_*()</code> functions.</p>
<div class="sourceCode" id="cb797"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"#377EB8"</span>, <span class="st">"white"</span>, <span class="st">"#E41A1C"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">m1</span>, col <span class="op">=</span> <span class="va">col_fun</span>, name <span class="op">=</span> <span class="st">"Methylation"</span>,
    clustering_distance_columns <span class="op">=</span> <span class="st">"spearman"</span>,
    show_row_dend <span class="op">=</span> <span class="cn">FALSE</span>, show_column_dend <span class="op">=</span> <span class="cn">FALSE</span>,
    show_column_names <span class="op">=</span> <span class="cn">FALSE</span>,
    bottom_annotation <span class="op">=</span> <span class="va">ha</span>, column_title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GetoptLong/man/qq.html">qq</a></span><span class="op">(</span><span class="st">"GBM samples (n = @{ncol(m1)})"</span><span class="op">)</span>,
    row_split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">cgi2</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"Island"</span>, <span class="st">"Shore"</span>, <span class="st">"Shelf"</span>, <span class="st">"OpenSea"</span><span class="op">)</span><span class="op">)</span>, 
    row_title_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"#FFFFFF00"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">m2</span>, col <span class="op">=</span> <span class="va">col_fun</span>, show_column_names <span class="op">=</span> <span class="cn">FALSE</span>, 
    show_column_dend <span class="op">=</span> <span class="cn">FALSE</span>, column_title <span class="op">=</span> <span class="st">"Controls"</span>,
    show_heatmap_legend <span class="op">=</span> <span class="cn">FALSE</span>, width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">tss_dist</span>, name <span class="op">=</span> <span class="st">"tss_dist"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2e5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"black"</span><span class="op">)</span><span class="op">)</span>, 
    width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"mm"</span><span class="op">)</span>,
    heatmap_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1e5</span>, <span class="fl">2e5</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"0kb"</span>, <span class="st">"100kb"</span>, <span class="st">"200kb"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">cgi2</span>, name <span class="op">=</span> <span class="st">"CGI"</span>, show_row_names <span class="op">=</span> <span class="cn">FALSE</span>, width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"mm"</span><span class="op">)</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"Island"</span>, <span class="st">"Shore"</span>, <span class="st">"Shelf"</span>, <span class="st">"OpenSea"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"green"</span>, <span class="st">"#CCCCCC"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html">draw</a></span><span class="op">(</span><span class="va">ht_list</span>, row_title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"DNA methylation probes (n = "</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html">nrow</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span>,
    annotation_legend_side <span class="op">=</span> <span class="st">"left"</span>, heatmap_legend_side <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span>

<span class="va">annotation_titles</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span>dkfz_cluster <span class="op">=</span> <span class="st">"DKFZ Methylation"</span>,
    tcga_cluster <span class="op">=</span> <span class="st">"TCGA Methylation"</span>,
    tcga_expr <span class="op">=</span> <span class="st">"TCGA Expression"</span>,
    IDH1 <span class="op">=</span> <span class="st">"IDH1"</span>,
    H3F3A <span class="op">=</span> <span class="st">"H3F3A"</span>,
    TP53 <span class="op">=</span> <span class="st">"TP53"</span>,
    chr7_gain <span class="op">=</span> <span class="st">"Chr7 gain"</span>,
    chr10_loss <span class="op">=</span> <span class="st">"Chr10 loss"</span>,
    CDKN2A_del <span class="op">=</span> <span class="st">"Chr10 loss"</span>,
    EGFR_amp <span class="op">=</span> <span class="st">"EGFR amp"</span>,
    PDGFRA_amp <span class="op">=</span> <span class="st">"PDGFRA amp"</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">an</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">annotation_titles</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/decorate_annotation.html">decorate_annotation</a></span><span class="op">(</span><span class="va">an</span>, <span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span><span class="va">annotation_titles</span><span class="op">[</span><span class="va">an</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="st">"mm"</span><span class="op">)</span>, just <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/grid/grid.rect.html">grid.rect</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/decorate_annotation.html">decorate_annotation</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span><span class="st">"Age"</span>, <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">8</span>, <span class="st">"mm"</span><span class="op">)</span>, just <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/grid/grid.rect.html">grid.rect</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/grid/grid.lines.html">grid.lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"npc"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>, <span class="st">"native"</span><span class="op">)</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/decorate_annotation.html">decorate_annotation</a></span><span class="op">(</span><span class="st">"IDH1"</span>, <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/grid/grid.lines.html">grid.lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">40</span>, <span class="fl">0</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/decorate_annotation.html">decorate_annotation</a></span><span class="op">(</span><span class="st">"chr7_gain"</span>, <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/grid/grid.lines.html">grid.lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">40</span>, <span class="fl">0</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="14-examples_files/figure-html/unnamed-chunk-26-1.png" width="1152" style="display: block; margin: auto;"></div>
</div>
<div id="add-multiple-boxplots-for-single-row" class="section level2" number="14.6">
<h2>
<span class="header-section-number">14.6</span> Add multiple boxplots for single row<a class="anchor" aria-label="anchor" href="#add-multiple-boxplots-for-single-row"><i class="fas fa-link"></i></a>
</h2>
<p>The annotation function <code><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_boxplot.html">anno_boxplot()</a></code> only draws one boxplot for a single row. When multiple
heatmaps are concatenated, or the groups for columns have already been defined, for each row, we
want to compare between heatmaps or column groups, thus, multiple boxplots need to be drawn for
each single row.</p>
<p>In following example, we demonstrate how to implement an annotation function which draws multiple
boxplots for single rows. The <code><a href="https://rdrr.io/pkg/ComplexHeatmap/man/grid.boxplot.html">grid.boxplot()</a></code> function is from <strong>ComplexHeatmap</strong> package which
makes it easy to draw boxplot under <strong>grid</strong> system.</p>
<div class="sourceCode" id="cb798"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>, <span class="fl">10</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">m2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">10</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">m1</span>, name <span class="op">=</span> <span class="st">"m1"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span><span class="va">m2</span>, name <span class="op">=</span> <span class="st">"m2"</span><span class="op">)</span>

<span class="va">rg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/inter-range-methods.html">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span><span class="op">)</span><span class="op">)</span>
<span class="va">rg</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="va">rg</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="op">(</span><span class="va">rg</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">rg</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">*</span> <span class="fl">0.02</span>
<span class="va">rg</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">rg</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="va">rg</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">rg</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">*</span> <span class="fl">0.02</span>
<span class="va">anno_multiple_boxplot</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">nr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/grid/viewports.html">pushViewport</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/viewport.html">viewport</a></span><span class="op">(</span>xscale <span class="op">=</span> <span class="va">rg</span>, yscale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">nr</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/grid/grid.rect.html">grid.rect</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">nr</span><span class="op">-</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>, height <span class="op">=</span> <span class="fl">1</span>, default.units <span class="op">=</span> <span class="st">"native"</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/grid.boxplot.html">grid.boxplot</a></span><span class="op">(</span><span class="va">m1</span><span class="op">[</span> <span class="va">index</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="op">]</span>, pos <span class="op">=</span> <span class="va">nr</span><span class="op">-</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">0.2</span>, box_width <span class="op">=</span> <span class="fl">0.3</span>, 
            gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>, direction <span class="op">=</span> <span class="st">"horizontal"</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/grid.boxplot.html">grid.boxplot</a></span><span class="op">(</span><span class="va">m2</span><span class="op">[</span> <span class="va">index</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="op">]</span>, pos <span class="op">=</span> <span class="va">nr</span><span class="op">-</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">0.2</span>, box_width <span class="op">=</span> <span class="fl">0.3</span>, 
            gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"green"</span><span class="op">)</span>, direction <span class="op">=</span> <span class="st">"horizontal"</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="fu"><a href="https://rdrr.io/r/grid/grid.xaxis.html">grid.xaxis</a></span><span class="op">(</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/grid/viewports.html">popViewport</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">ht_list</span> <span class="op">=</span> <span class="va">ht_list</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/rowAnnotation.html">rowAnnotation</a></span><span class="op">(</span>boxplot <span class="op">=</span> <span class="va">anno_multiple_boxplot</span>, width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span>, 
    show_annotation_name <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">lgd</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Legend.html">Legend</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"m1"</span>, <span class="st">"m2"</span><span class="op">)</span>, title <span class="op">=</span> <span class="st">"boxplots"</span>,
    legend_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"green"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html">draw</a></span><span class="op">(</span><span class="va">ht_list</span>, padding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span>, heatmap_legend_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lgd</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="14-examples_files/figure-html/unnamed-chunk-27-1.png" width="480" style="display: block; margin: auto;"></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="genome-level-heatmap.html"><span class="header-section-number">13</span> Genome-level heatmap</a></div>
<div class="next"><a href="other-tricks.html"><span class="header-section-number">15</span> Other Tricks</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#more-examples"><span class="header-section-number">14</span> More Examples</a></li>
<li><a class="nav-link" href="#add-more-information-for-gene-expression-matrix"><span class="header-section-number">14.1</span> Add more information for gene expression matrix</a></li>
<li><a class="nav-link" href="#the-measles-vaccine-heatmap"><span class="header-section-number">14.2</span> The measles vaccine heatmap</a></li>
<li><a class="nav-link" href="#visualize-cell-heterogeneity-from-single-cell-rnaseq"><span class="header-section-number">14.3</span> Visualize Cell Heterogeneity from Single Cell RNASeq</a></li>
<li><a class="nav-link" href="#correlations-between-methylation-expression-and-other-genomic-features"><span class="header-section-number">14.4</span> Correlations between methylation, expression and other genomic features</a></li>
<li><a class="nav-link" href="#visualize-methylation-profile-with-complex-annotations"><span class="header-section-number">14.5</span> Visualize Methylation Profile with Complex Annotations</a></li>
<li><a class="nav-link" href="#add-multiple-boxplots-for-single-row"><span class="header-section-number">14.6</span> Add multiple boxplots for single row</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/jokergoo/ComplexHeatmap/blob/master/14-examples.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/jokergoo/ComplexHeatmap/edit/master/14-examples.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>ComplexHeatmap Complete Reference</strong>" was written by Zuguang Gu. It was last built on last revised on 2022-07-31.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
